<mat-card>
  <mat-card-header>
    <mat-card-title>
      <mat-icon svgIcon="vfs"></mat-icon>
      <span>{{ 'shared.vfsControl.title' | translate }}</span>
    </mat-card-title>
  </mat-card-header>

  <mat-card-content>
    @if (vfsNotFound()) {
      <div class="empty-state">
        <mat-icon svgIcon="vfs"></mat-icon>
        <span>{{ 'shared.vfsControl.noVfsFound' | translate }}</span>
        <p>{{ 'shared.vfsControl.noVfsRunning' | translate }}</p>
      </div>
    } @else if (loading() && vfsInstances().length === 0) {
      <div class="loading-state">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>{{ 'shared.vfsControl.loading' | translate }}</p>
      </div>
    } @else if (vfsInstances().length > 0) {
      @if (vfsInstances().length > 1) {
        <div class="vfs-selector">
          <mat-form-field>
            <mat-label>{{ 'shared.vfsControl.vfsInstance' | translate }}</mat-label>
            <mat-select
              [ngModel]="selectedVfs()"
              (ngModelChange)="onVfsSelectionChange($event)"
              [compareWith]="compareVfs"
            >
              @for (vfs of vfsInstances(); track trackByVfsName($index, vfs)) {
                <mat-option [value]="vfs">
                  {{ vfs.name }}
                  @if (vfs.queue.length > 0) {
                    <span class="option-badge"
                      >({{ vfs.queue.length }} {{ 'shared.vfsControl.queued' | translate }})</span
                    >
                  }
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
      }

      <!-- Warning for indexed VFS entries -->
      @if (isIndexedVfs()) {
        <div class="indexed-vfs-warning">
          <mat-icon svgIcon="warning" class="warn"></mat-icon>
          <div class="warning-content">
            <strong>{{ 'shared.vfsControl.controlsUnavailable' | translate }}</strong>
            <p>
              {{ 'shared.vfsControl.indexedWarning' | translate: { suffix: ':[0]' } }}
            </p>
            <a
              href="https://github.com/rclone/rclone/issues/9120"
              target="_blank"
              rel="noopener noreferrer"
            >
              #9120
            </a>
          </div>
        </div>
      }

      @if (selectedVfs(); as vfs) {
        <!-- VFS Stats & Controls - Only for usable (non-indexed) VFS -->
        @if (hasUsableVfs()) {
          @if (vfs.stats) {
            <div class="stats-grid">
              @if (vfs.stats.metadataCache; as metadataCache) {
                <div class="stat-item">
                  <span class="label">{{ 'shared.vfsControl.stats.metadata' | translate }}</span>
                  <span class="value">
                    {{ metadataCache.dirs + metadataCache.files }}
                    {{ 'shared.vfsControl.stats.items' | translate }}
                  </span>
                </div>
              }

              @if (vfs.stats.diskCache; as diskCache) {
                <div class="stat-item">
                  <span class="label">{{ 'shared.vfsControl.stats.diskCache' | translate }}</span>
                  <span class="value">
                    {{ diskCache.bytesUsed | formatFileSize }}
                  </span>
                </div>
                <div class="stat-item">
                  <span class="label">{{ 'shared.vfsControl.stats.cachedFiles' | translate }}</span>
                  <span class="value">{{ diskCache.files }}</span>
                </div>
                <div class="stat-item">
                  <span class="label">{{
                    'shared.vfsControl.stats.pendingUploads' | translate
                  }}</span>
                  <span class="value">
                    {{ diskCache.uploadsQueued }}
                  </span>
                </div>
                <div class="stat-item">
                  <span class="label">{{ 'shared.vfsControl.stats.inProgress' | translate }}</span>
                  <span class="value">
                    {{ diskCache.uploadsInProgress }}
                  </span>
                </div>
                @if (diskCache.erroredFiles > 0) {
                  <div class="stat-item error">
                    <span class="label">{{ 'shared.vfsControl.stats.errors' | translate }}</span>
                    <span class="value">{{ diskCache.erroredFiles }}</span>
                  </div>
                }
              } @else {
                <div class="stat-item">
                  <span class="label">{{ 'shared.vfsControl.stats.diskCache' | translate }}</span>
                  <span class="value disabled">{{
                    'shared.vfsControl.stats.disabled' | translate
                  }}</span>
                </div>
              }

              <div class="stat-item">
                <span class="label">{{ 'shared.vfsControl.stats.inUse' | translate }}</span>
                <span class="value">{{ vfs.stats.inUse }}</span>
              </div>
            </div>
          } @else {
            <div class="loading-shade">
              <mat-spinner diameter="40" mode="indeterminate"></mat-spinner>
              <p>{{ 'shared.vfsControl.loadingStats' | translate }}</p>
            </div>
          }

          <div class="queue-section">
            <div class="section-header">
              <h3>
                <mat-icon svgIcon="file-arrow-up"></mat-icon>
                {{ 'shared.vfsControl.queue.title' | translate }}
                @if (vfs.queue.length > 0) {
                  <span class="queue-info">
                    ({{
                      'shared.vfsControl.queue.uploadingCount'
                        | translate
                          : {
                              uploading: uploadingCount(),
                              total: totalQueueSize() | formatFileSize,
                            }
                    }})
                  </span>
                }
              </h3>
            </div>

            <div class="queue-container">
              @if (vfs.queue.length === 0) {
                @if (!vfs.stats) {
                  <div class="empty-state">
                    <mat-spinner diameter="32"></mat-spinner>
                    <span>{{ 'shared.vfsControl.fetchingQueue' | translate }}</span>
                  </div>
                } @else {
                  <div class="empty-state">
                    <mat-icon svgIcon="circle-check"></mat-icon>
                    <span>{{ 'shared.vfsControl.queue.empty' | translate }}</span>
                    <p>{{ 'shared.vfsControl.queue.emptyHint' | translate }}</p>
                  </div>
                }
              } @else {
                <table mat-table [dataSource]="vfs.queue" multiTemplateDataRows>
                  <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef>
                      {{ 'shared.vfsControl.queue.name' | translate }}
                    </th>
                    <td mat-cell *matCellDef="let item">
                      <span class="file-name-cell">{{ item.name }}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="size">
                    <th mat-header-cell *matHeaderCellDef>
                      {{ 'shared.vfsControl.queue.size' | translate }}
                    </th>
                    <td mat-cell *matCellDef="let item">
                      <span class="size-badge">{{ item.size | formatFileSize }}</span>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>
                      {{ 'shared.vfsControl.queue.status' | translate }}
                    </th>
                    <td mat-cell *matCellDef="let item">
                      <div class="status-cell">
                        <div class="status-left">
                          <span class="status-text" [class.uploading]="item.uploading">
                            {{ getQueueItemStatus(item) }}
                          </span>
                          @if (item.tries > 0) {
                            <span class="tries-badge"
                              >{{ item.tries }}
                              {{ 'shared.vfsControl.queue.tries' | translate }}</span
                            >
                          }
                        </div>
                        <div class="status-right">
                          @if (!item.uploading && item.expiry > 5) {
                            <button
                              mat-icon-button
                              (click)="prioritizeUpload(item); $event.stopPropagation()"
                              [matTooltip]="
                                'shared.vfsControl.queue.tooltips.uploadNext' | translate
                              "
                              class="primary"
                            >
                              <mat-icon svgIcon="file-arrow-up"></mat-icon>
                            </button>
                          }
                          @if (canDelayUpload(item)) {
                            <button
                              mat-icon-button
                              (click)="delayUpload(item); $event.stopPropagation()"
                              [matTooltip]="
                                'shared.vfsControl.queue.tooltips.delayLong' | translate
                              "
                              class="warn"
                            >
                              <mat-icon svgIcon="stop"></mat-icon>
                            </button>
                            <button
                              mat-icon-button
                              class="accent"
                              (click)="toggleDelaySlider(item); $event.stopPropagation()"
                              [matTooltip]="
                                showDelaySlider() === item.id
                                  ? ('shared.vfsControl.queue.tooltips.hideSlider' | translate)
                                  : ('shared.vfsControl.queue.tooltips.setDelay' | translate)
                              "
                              [class]="showDelaySlider() === item.id ? 'primary' : undefined"
                            >
                              <mat-icon svgIcon="clock"></mat-icon>
                            </button>
                          }
                        </div>
                      </div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="expandedDetail">
                    <td mat-cell *matCellDef="let item" [attr.colspan]="displayedColumns.length">
                      <div class="element-detail">
                        @if (showDelaySlider() === item.id) {
                          <div class="delay-slider-container">
                            <div class="slider-header">
                              <mat-icon svgIcon="clock"></mat-icon>
                              <span>{{ 'shared.vfsControl.queue.slider.title' | translate }}</span>
                            </div>
                            <div class="slider-content">
                              <mat-slider
                                [min]="10"
                                [max]="86400"
                                [step]="10"
                                [displayWith]="formatSliderLabel"
                                discrete
                              >
                                <input
                                  matSliderThumb
                                  [ngModel]="delaySliderValue()"
                                  (ngModelChange)="delaySliderValue.set($event)"
                                />
                              </mat-slider>
                              <div class="slider-value">
                                {{ formatSliderLabel(delaySliderValue()) }}
                              </div>
                            </div>
                            <div class="slider-actions">
                              <button mat-button (click)="showDelaySlider.set(null)">
                                {{ 'shared.vfsControl.queue.slider.cancel' | translate }}
                              </button>
                              <button
                                mat-raised-button
                                class="primary"
                                (click)="setCustomDelay(item)"
                              >
                                {{ 'shared.vfsControl.queue.slider.apply' | translate }}
                              </button>
                            </div>
                          </div>
                        }
                      </div>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                  <tr
                    mat-row
                    *matRowDef="let row; columns: displayedColumns"
                    class="element-row"
                  ></tr>
                  <tr
                    mat-row
                    *matRowDef="let row; columns: ['expandedDetail']; when: isDetailRow"
                    class="detail-row"
                  ></tr>
                </table>
              }
            </div>
          </div>

          @if (vfs.stats?.diskCache; as diskCache) {
            <div class="cache-info-section">
              <div class="section-header">
                <h3>
                  <mat-icon svgIcon="database"></mat-icon>
                  {{ 'shared.vfsControl.cacheInfo.title' | translate }}
                </h3>
              </div>
              <div class="cache-info-content">
                <div class="info-row">
                  <div class="info-text">
                    <div class="path-header">
                      <strong>{{ 'shared.vfsControl.cacheInfo.location' | translate }}</strong>
                    </div>
                    <code
                      >{{ diskCache.path }}
                      <button
                        mat-icon-button
                        (click)="openFolder(diskCache.path)"
                        [matTooltip]="'shared.vfsControl.cacheInfo.openFolder' | translate"
                        class="folder-button"
                      >
                        <mat-icon svgIcon="folder"></mat-icon>
                      </button>
                    </code>
                  </div>
                </div>
                <div class="info-row">
                  <div class="info-text">
                    <div class="path-header">
                      <strong>{{ 'shared.vfsControl.cacheInfo.metaLocation' | translate }}</strong>
                    </div>
                    <code
                      >{{ diskCache.pathMeta }}
                      <button
                        mat-icon-button
                        (click)="openFolder(diskCache.pathMeta)"
                        [matTooltip]="'shared.vfsControl.cacheInfo.openMetaFolder' | translate"
                        class="folder-button"
                      >
                        <mat-icon svgIcon="folder"></mat-icon></button
                    ></code>
                  </div>
                </div>
                <div class="info-row">
                  <mat-icon svgIcon="circle-info"></mat-icon>
                  <div class="info-text">
                    <span class="info-note">
                      <strong>{{ 'shared.vfsControl.cacheInfo.note' | translate }}</strong>
                      {{ 'shared.vfsControl.cacheInfo.noteText' | translate }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- Advanced Configuration Section -->
          @if (vfs.stats?.opt) {
            <div class="advanced-config-section">
              <div
                class="section-header clickable"
                tabindex="0"
                (click)="showAdvancedConfig.set(!showAdvancedConfig())"
                (keydown.enter)="showAdvancedConfig.set(!showAdvancedConfig())"
              >
                <h3>
                  <mat-icon
                    [svgIcon]="showAdvancedConfig() ? 'chevron-down' : 'chevron-right'"
                  ></mat-icon>
                  <mat-icon svgIcon="gear"></mat-icon>
                  {{ 'shared.vfsControl.advancedConfig.title' | translate }}
                </h3>
              </div>

              @if (showAdvancedConfig()) {
                <div class="advanced-config-content">
                  <div class="config-search">
                    <mat-form-field>
                      <mat-label>{{
                        'shared.vfsControl.advancedConfig.search' | translate
                      }}</mat-label>
                      <input
                        matInput
                        [ngModel]="configSearchTerm()"
                        (ngModelChange)="configSearchTerm.set($event)"
                        [placeholder]="
                          'shared.vfsControl.advancedConfig.searchPlaceholder' | translate
                        "
                      />
                      <mat-icon matPrefix svgIcon="search"></mat-icon>
                      @if (configSearchTerm()) {
                        <button
                          mat-icon-button
                          matSuffix
                          (click)="configSearchTerm.set('')"
                          [matTooltip]="'shared.vfsControl.advancedConfig.clearSearch' | translate"
                        >
                          <mat-icon svgIcon="close"></mat-icon>
                        </button>
                      }
                    </mat-form-field>
                  </div>

                  @if (vfsConfigGroups().length === 0) {
                    <div class="empty-state">
                      <mat-icon svgIcon="search"></mat-icon>
                      <span>{{ 'shared.vfsControl.advancedConfig.noResults' | translate }}</span>
                    </div>
                  } @else {
                    @for (group of vfsConfigGroups(); track trackByCategory($index, group)) {
                      <div class="config-group">
                        <h4 class="group-title">
                          <mat-icon svgIcon="folder"></mat-icon>
                          {{
                            'shared.vfsControl.advancedConfig.categories.' + group.name | translate
                          }}
                        </h4>
                        <div class="config-table">
                          @for (item of group.items; track trackByConfigKey($index, item)) {
                            <div class="config-row">
                              <div class="config-key" [matTooltip]="item.key">{{ item.key }}</div>
                              <div class="config-value" [matTooltip]="'Raw: ' + item.rawValue">
                                {{ item.value }}
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  }
                </div>
              }
            </div>
          }
        }
      }
    }
  </mat-card-content>

  @if (selectedVfs(); as vfs) {
    <mat-card-actions>
      <mat-form-field>
        <mat-label>{{ 'shared.vfsControl.actions.pollInterval' | translate }}</mat-label>
        <input
          matInput
          [ngModel]="
            vfs.pollIntervalSupported === false
              ? ('shared.vfsControl.actions.pollIntervalNotSupported' | translate)
              : pollIntervalInput()
          "
          (ngModelChange)="pollIntervalInput.set($event)"
          [placeholder]="'shared.vfsControl.pollIntervalPlaceholder' | translate"
          [disabled]="!hasUsableVfs() || loading() || vfs.pollIntervalSupported === false"
        />
        <button
          mat-icon-button
          matSuffix
          (click)="updatePollInterval()"
          [matTooltip]="'shared.vfsControl.actions.updateInterval' | translate"
          [disabled]="
            !hasUsableVfs() ||
            !pollIntervalInput().trim() ||
            loading() ||
            vfs.pollIntervalSupported === false
          "
        >
          <mat-icon svgIcon="bolt"></mat-icon>
        </button>
      </mat-form-field>
      <button
        mat-icon-button
        (click)="refreshDirectory()"
        [matTooltip]="'shared.vfsControl.actions.refreshMetadata' | translate"
        [disabled]="!hasUsableVfs() || loading()"
      >
        <mat-icon svgIcon="sync"></mat-icon>
      </button>

      <button
        mat-icon-button
        class="warn"
        (click)="clearMetadataCache()"
        [matTooltip]="'shared.vfsControl.actions.clearCache' | translate"
        [disabled]="!hasUsableVfs() || loading()"
      >
        <mat-icon svgIcon="trash"></mat-icon>
      </button>

      <button
        mat-icon-button
        (click)="loadAll()"
        [matTooltip]="'shared.vfsControl.actions.refreshAll' | translate"
        [disabled]="loading()"
      >
        <mat-icon [class.spin]="loading()" svgIcon="refresh"></mat-icon>
      </button>
    </mat-card-actions>
  }
</mat-card>
