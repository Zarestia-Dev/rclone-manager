<form [formGroup]="form()" class="remote-form">
  <cdk-virtual-scroll-viewport
    [itemSize]="20"
    [style.height.px]="700"
    class="virtual-scroll-viewport"
  >
    <div class="form-container">
      <ng-container *cdkVirtualFor="let field of formFields(); trackBy: trackByField">
        @if (field.type === 'basic-info') {
          <mat-form-field appearance="fill">
            <mat-label>Remote Name</mat-label>
            <input
              matInput
              formControlName="name"
              id="remoteName"
              placeholder="e.g., my-cloud-storage"
            />
            @if (form().get('name')?.hasError('required')) {
              <mat-error> Remote name is required </mat-error>
            }
            @if (form().get('name')?.hasError('invalidChars')) {
              <mat-error> Name contains invalid characters </mat-error>
            }
            @if (form().get('name')?.hasError('invalidStart')) {
              <mat-error> Name cannot start with a dash or space </mat-error>
            }
            @if (form().get('name')?.hasError('invalidEnd')) {
              <mat-error> Name cannot end with a space </mat-error>
            }
            @if (form().get('name')?.hasError('nameTaken')) {
              <mat-error> A remote with this name already exists </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Remote Type</mat-label>
            <input
              type="text"
              matInput
              [formControl]="remoteSearchCtrl"
              [matAutocomplete]="auto"
              placeholder="e.g., Google Drive"
            />
            <mat-autocomplete
              #auto="matAutocomplete"
              [displayWith]="displayRemote.bind(this)"
              (optionSelected)="onTypeSelected($event.option.value)"
            >
              @for (remote of filteredRemotes(); track remote.value) {
                <mat-option [value]="remote.value">
                  <div class="option-content">
                    <span class="option-label">{{ remote.label }}</span>
                    <small class="option-description">{{ remote.value }}</small>
                  </div>
                </mat-option>
              }
              @if (filteredRemotes().length === 0) {
                <mat-option disabled>No matching remote types</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
        }

        @if (field.type === 'basic-info' && isLoading()) {
          <div class="loading-container">
            <mat-spinner diameter="30"></mat-spinner>
            <span>Loading configuration options...</span>
          </div>
        }

        @if (field.type === 'config-toggles') {
          <mat-slide-toggle (change)="toggleAdvancedOptions()" [checked]="showAdvancedOptions()">
            Show Advanced Options
          </mat-slide-toggle>

          <mat-slide-toggle (change)="toggleInteractiveMode()" [checked]="useInteractiveMode()">
            Use Interactive Configuration
          </mat-slide-toggle>
        }

        @if (field.type === 'provider-field' && providerField(); as pField) {
          <mat-form-field appearance="fill">
            <mat-label>{{ pField.Help || 'Authentication Method' }}</mat-label>
            <input
              type="text"
              matInput
              [formControl]="providerSearchCtrl"
              [matAutocomplete]="providerAuto"
              [placeholder]="pField.DefaultStr || ''"
            />
            <mat-autocomplete
              #providerAuto="matAutocomplete"
              [displayWith]="displayProvider.bind(this)"
              (optionSelected)="onProviderSelected($event.option.value)"
            >
              @for (option of filteredProviders(); track option.Value) {
                <mat-option [value]="option.Value">
                  <div class="option-content">
                    <span class="option-label">{{ option.Help }}</span>
                    <small class="option-description">{{ option.Value }}</small>
                  </div>
                </mat-option>
              }
            </mat-autocomplete>
            @if (form().get(pField.Name)?.hasError('required')) {
              <mat-error>Provider is required</mat-error>
            }
          </mat-form-field>
        }

        @if (field.type === 'basic-fields') {
          @for (item of basicFields(); track item.Name) {
            <app-setting-control
              [option]="item"
              [formControlName]="item.Name"
              (valueChanged)="onFieldChanged(item.Name, $event)"
            ></app-setting-control>
          }
        }

        @if (field.type === 'advanced-section') {
          <div class="advanced-section">
            <h3 class="section-heading">
              Advanced Options
              <span>{{ advancedFields().length }}</span>
            </h3>

            @for (item of advancedFields(); track item.Name) {
              <app-setting-control
                [option]="item"
                [formControlName]="item.Name"
                (valueChanged)="onFieldChanged(item.Name, $event)"
              ></app-setting-control>
            }
          </div>
        }
      </ng-container>
    </div>
  </cdk-virtual-scroll-viewport>
</form>
