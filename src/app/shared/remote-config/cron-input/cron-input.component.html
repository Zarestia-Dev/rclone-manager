<div class="cron-input-container">
  <mat-tab-group>
    <mat-tab label="Simple">
      <div class="tab-content">
        <div class="section-title">Choose a common schedule:</div>
        <div class="preset-cards">
          @for (preset of presetOptions; track preset.key) {
            <button
              type="button"
              class="preset-card"
              [class.selected]="selectedPreset === preset.key"
              (click)="applyPreset(preset.key, preset.cron)"
              [matTooltip]="preset.cron"
            >
              <div class="preset-title">{{ preset.title }}</div>
              <div class="preset-description">{{ preset.description }}</div>
            </button>
          }
        </div>

        <div class="divider">
          <span>or customize</span>
        </div>

        <div class="custom-builder" [formGroup]="simpleForm">
          <div class="builder-row">
            <span class="builder-label">Run this task</span>
            <mat-form-field class="inline-field">
              <mat-select formControlName="frequency">
                <mat-option value="daily">every day</mat-option>
                <mat-option value="weekly">every week</mat-option>
                <mat-option value="monthly">every month</mat-option>
                <mat-option value="interval">every few hours</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          @if (simpleForm.get('frequency')?.value === 'weekly') {
            <div class="builder-row">
              <span class="builder-label">on</span>
              <mat-form-field class="inline-field">
                <mat-select formControlName="dayOfWeek">
                  <mat-option value="1">Monday</mat-option>
                  <mat-option value="2">Tuesday</mat-option>
                  <mat-option value="3">Wednesday</mat-option>
                  <mat-option value="4">Thursday</mat-option>
                  <mat-option value="5">Friday</mat-option>
                  <mat-option value="6">Saturday</mat-option>
                  <mat-option value="0">Sunday</mat-option>
                  <mat-option value="1-5">Weekdays (Mon-Fri)</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          }

          @if (simpleForm.get('frequency')?.value === 'monthly') {
            <div class="builder-row">
              <span class="builder-label">on day</span>
              <mat-form-field class="inline-field">
                <mat-select formControlName="dayOfMonth">
                  @for (day of daysOfMonth; track day) {
                    <mat-option [value]="day">{{ day }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
              <span class="builder-label">of the month</span>
            </div>
          }

          @if (simpleForm.get('frequency')?.value === 'interval') {
            <div class="builder-row">
              <span class="builder-label">every</span>
              <mat-form-field class="inline-field">
                <mat-select formControlName="intervalHours">
                  <mat-option [value]="2">2 hours</mat-option>
                  <mat-option [value]="4">4 hours</mat-option>
                  <mat-option [value]="6">6 hours</mat-option>
                  <mat-option [value]="8">8 hours</mat-option>
                  <mat-option [value]="12">12 hours</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          }

          @if (simpleForm.get('frequency')?.value !== 'interval') {
            <div class="builder-row">
              <span class="builder-label">at</span>
              <mat-form-field class="inline-field">
                <input
                  matInput
                  [ngxMatTimepicker]="timePicker"
                  formControlName="time"
                  readonly
                  (click)="timePicker.open()"
                />
                <mat-icon matSuffix svgIcon="clock"></mat-icon>
                <ngx-mat-timepicker
                  #timePicker
                  [enableKeyboardInput]="true"
                  (timeSet)="onSimpleFormChange()"
                ></ngx-mat-timepicker>
              </mat-form-field>
            </div>
          }
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Advanced">
      <div class="tab-content">
        <div class="advanced-intro">
          <mat-icon svgIcon="info"></mat-icon>
          <div>
            <strong>For advanced users:</strong> Configure individual cron fields or enter a
            complete cron expression manually. Use * for "any value", */n for "every n units", or
            specific values.
          </div>
        </div>

        <div class="advanced-section">
          <div class="section-title">Field Builder</div>
          <div [formGroup]="advancedForm" class="advanced-fields">
            <mat-form-field>
              <mat-label>Minute (0-59)</mat-label>
              <mat-select formControlName="minute">
                <mat-option value="*">* (Every minute)</mat-option>
                <mat-option value="0">0 (On the hour)</mat-option>
                <mat-option value="*/5">*/5 (Every 5 minutes)</mat-option>
                <mat-option value="*/10">*/10 (Every 10 minutes)</mat-option>
                <mat-option value="*/15">*/15 (Every 15 minutes)</mat-option>
                <mat-option value="*/30">*/30 (Every 30 minutes)</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Hour (0-23)</mat-label>
              <mat-select formControlName="hour">
                <mat-option value="*">* (Every hour)</mat-option>
                <mat-option value="0">0 (Midnight)</mat-option>
                <mat-option value="*/2">*/2 (Every 2 hours)</mat-option>
                <mat-option value="*/4">*/4 (Every 4 hours)</mat-option>
                <mat-option value="*/6">*/6 (Every 6 hours)</mat-option>
                @for (hour of [6, 9, 12, 15, 18, 21]; track hour) {
                  <mat-option [value]="hour.toString()">{{ hour }}:00</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Day of Month (1-31)</mat-label>
              <mat-select formControlName="dayOfMonth">
                <mat-option value="*">* (Every day)</mat-option>
                <mat-option value="1">1 (First day)</mat-option>
                <mat-option value="15">15 (Middle)</mat-option>
                <mat-option value="*/2">*/2 (Every 2 days)</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Month (1-12)</mat-label>
              <mat-select formControlName="month">
                <mat-option value="*">* (Every month)</mat-option>
                @for (
                  month of [
                    { value: 1, label: 'January' },
                    { value: 2, label: 'February' },
                    { value: 3, label: 'March' },
                    { value: 4, label: 'April' },
                    { value: 5, label: 'May' },
                    { value: 6, label: 'June' },
                    { value: 7, label: 'July' },
                    { value: 8, label: 'August' },
                    { value: 9, label: 'September' },
                    { value: 10, label: 'October' },
                    { value: 11, label: 'November' },
                    { value: 12, label: 'December' },
                  ];
                  track month.value
                ) {
                  <mat-option [value]="month.value.toString()">{{ month.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field>
              <mat-label>Day of Week</mat-label>
              <mat-select formControlName="dayOfWeek">
                <mat-option value="*">* (Every day)</mat-option>
                <mat-option value="1">Monday</mat-option>
                <mat-option value="2">Tuesday</mat-option>
                <mat-option value="3">Wednesday</mat-option>
                <mat-option value="4">Thursday</mat-option>
                <mat-option value="5">Friday</mat-option>
                <mat-option value="6">Saturday</mat-option>
                <mat-option value="0">Sunday</mat-option>
                <mat-option value="1-5">1-5 (Weekdays)</mat-option>
                <mat-option value="0,6">0,6 (Weekends)</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <div class="advanced-section">
          <div class="section-title">Or enter manually</div>
          <mat-form-field class="manual-field">
            <mat-label>Cron Expression</mat-label>
            <mat-icon matPrefix svgIcon="terminal"></mat-icon>
            <input
              matInput
              [formControl]="cronControl"
              placeholder="0 9 * * * (Daily at 9 AM)"
              [attr.aria-label]="'Cron expression for ' + taskName"
            />
            @if (cronControl.value) {
              <button
                matSuffix
                mat-icon-button
                type="button"
                (click)="cronControl.reset()"
                aria-label="Clear"
              >
                <mat-icon svgIcon="circle-xmark"></mat-icon>
              </button>
            }
            @if (cronControl.hasError('invalidCron')) {
              <mat-error>{{ validationError }}</mat-error>
            }
          </mat-form-field>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>

  @if (cronControl.value && validationResponse?.isValid) {
    <div class="schedule-preview">
      <div class="preview-header">
        <mat-icon svgIcon="circle-check" class="success-icon"></mat-icon>
        <span class="preview-title">Your Schedule</span>
      </div>
      <div class="preview-content">
        <div class="preview-description">
          {{ getHumanReadableSchedule() }}
        </div>
        @if (validationResponse?.nextRun) {
          <div class="preview-next-runs">
            <div class="next-run-item">
              <strong>Next run:</strong>
              {{ formatNextRun(validationResponse?.nextRun ?? null) }}
            </div>
          </div>
        }
      </div>
      <div class="preview-technical">
        <code>{{ cronControl.value }}</code>
      </div>
    </div>
  }

  @if (validationResponse?.isValid && cronControl.value) {
    <div class="timezone-note">
      <mat-icon svgIcon="globe"></mat-icon>
      <span>
        Times are in your local timezone (UTC{{ userTimezone }}) and automatically converted to UTC
        for scheduling.
      </span>
    </div>
  }
</div>
