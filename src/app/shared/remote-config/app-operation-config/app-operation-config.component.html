<div class="operation-config" [formGroup]="opFormGroup">
  <div class="header-section">
    <mat-slide-toggle formControlName="autoStart" class="operation-enable">
      Enable Auto-{{ operationType | titlecase }}
    </mat-slide-toggle>
    <p class="section-description">{{ description }}</p>

    @if (opFormGroup.get('autoStart')?.value && !isMount) {
      <mat-expansion-panel class="cron-panel" [expanded]="isPanelExpanded">
        <mat-expansion-panel-header>
          <mat-panel-title>
            Scheduling Options
            @if (cronExpression) {
              <button
                mat-icon-button
                class="clear-schedule-btn"
                (click)="clearSchedule($event)"
                matTooltip="Clear schedule (run once on startup)"
                type="button"
              >
                <mat-icon svgIcon="circle-xmark"></mat-icon>
              </button>
            }
          </mat-panel-title>
          <mat-panel-description>
            <span [class.no-schedule]="!cronExpression">
              {{ cronExpression || 'Run once on startup' }}
            </span>
          </mat-panel-description>
        </mat-expansion-panel-header>
        <div class="cron-content">
          <div class="scheduling-info">
            <mat-icon svgIcon="info" class="info-icon"></mat-icon>
            <div class="info-text">
              <p><strong>How scheduling works:</strong></p>
              <ul>
                <li><strong>No schedule:</strong> Operation runs <em>once</em> when app starts</li>
                <li>
                  <strong>With cron schedule:</strong> Operation runs <em>recurring</em> based on
                  your expression
                </li>
              </ul>
            </div>
          </div>
          <app-cron-input
            [initialValue]="cronExpression"
            [taskName]="operationType"
            (cronChange)="onCronChange($event)"
            (validationChange)="onCronValidationChange($event)"
          ></app-cron-input>
        </div>
      </mat-expansion-panel>
    }
  </div>

  <div class="path-section" formGroupName="source">
    @if (isMount) {
      @if (sourcePathState$ | async; as state) {
        <div class="path-input-wrapper">
          <mat-form-field appearance="fill">
            <mat-label>Source Path</mat-label>
            <span matPrefix class="path-prefix mount-remote locked">
              <mat-icon svgIcon="hard-drive"></mat-icon>
              <span>{{ currentRemoteName }}:/</span>
            </span>
            <input
              matInput
              formControlName="path"
              placeholder="Root folder (optional)"
              aria-label="Source path on remote"
              (input)="onInputChanged($event, 'source')"
              (click)="$event.stopPropagation()"
              [matMenuTriggerFor]="!isNewRemote ? sourcePathAutocompleteMenu : null"
            />
          </mat-form-field>

          <mat-menu
            #sourcePathAutocompleteMenu="matMenu"
            panelClass="path-autocomplete-menu"
            [overlapTrigger]="false"
          >
            @if (state.isLoading) {
              <div class="loading-spinner">
                <mat-spinner diameter="24"></mat-spinner> <span>Loading...</span>
              </div>
            } @else {
              @if (state.currentPath) {
                <button mat-menu-item (click)="goUp('source')">
                  <mat-icon svgIcon="arrow-turn-up-left"></mat-icon> <span>.. (Up a folder)</span>
                </button>
              }
              @for (entry of state.options; track trackByEntry($index, entry)) {
                <button
                  mat-menu-item
                  (click)="onPathSelected('source', entry.Name)"
                  [disabled]="!entry.IsDir"
                >
                  <mat-icon [svgIcon]="entry.IsDir ? 'folder' : 'file'"></mat-icon>
                  <span>{{ entry.Name }}</span>
                </button>
              } @empty {
                @if (!state.isLoading && state.remoteName) {
                  <div class="no-results"><span>No items found in this directory.</span></div>
                }
              }
            }
          </mat-menu>
        </div>
      }
    } @else {
      @if (sourcePathState$ | async; as state) {
        <div class="path-input-wrapper">
          <mat-form-field appearance="fill">
            <mat-label>Source Path</mat-label>
            <mat-select
              matPrefix
              formControlName="pathType"
              class="path-prefix"
              [class.local]="sourcePathType === 'local'"
              [class.remote]="sourcePathType === 'currentRemote'"
              [class.other]="sourcePathType === 'otherRemote'"
              aria-label="Change source path type"
              (click)="$event.stopPropagation()"
              (selectionChange)="clearPathOnTypeChange('source')"
            >
              <mat-select-trigger>
                @switch (sourcePathType) {
                  @case ('local') {
                    <mat-icon svgIcon="folder" class="purple"></mat-icon> <span>Local Path</span>
                  }
                  @case ('currentRemote') {
                    <mat-icon svgIcon="hard-drive" class="primary"></mat-icon>
                    <span>{{ currentRemoteName }}:/</span>
                  }
                  @case ('otherRemote') {
                    <mat-icon svgIcon="cloud" class="accent"></mat-icon>
                    <span>{{ opFormGroup.get('source.otherRemoteName')?.value }}:/</span>
                  }
                }
              </mat-select-trigger>
              <mat-option value="local">
                <mat-icon svgIcon="folder" class="purple"></mat-icon> Local Path
              </mat-option>
              <mat-option value="currentRemote">
                <mat-icon svgIcon="hard-drive" class="primary"></mat-icon> {{ currentRemoteName }}:/
              </mat-option>
              @if (otherRemotes.length) {
                <mat-optgroup label="Other Remotes">
                  @for (remote of otherRemotes; track remote) {
                    <mat-option [value]="'otherRemote:' + remote">
                      <mat-icon class="accent" svgIcon="cloud"></mat-icon> {{ remote }}:/
                    </mat-option>
                  }
                </mat-optgroup>
              }
            </mat-select>

            <input
              matInput
              formControlName="path"
              placeholder="Enter source path..."
              aria-label="Source path"
              (input)="onInputChanged($event, 'source')"
              (click)="$event.stopPropagation()"
              [matMenuTriggerFor]="sourcePathType !== 'local' ? sourcePathAutocompleteMenu : null"
            />

            @if (sourcePathType === 'local') {
              <button
                matIconButton
                matSuffix
                (click)="onSelectFolder('source')"
                type="button"
                aria-label="Select source folder"
              >
                <mat-icon svgIcon="folder" class="purple"></mat-icon>
              </button>
            }
          </mat-form-field>

          <mat-menu
            #sourcePathAutocompleteMenu="matMenu"
            panelClass="path-autocomplete-menu"
            [overlapTrigger]="false"
          >
            @if (state.isLoading) {
              <div class="loading-spinner">
                <mat-spinner diameter="24"></mat-spinner> <span>Loading...</span>
              </div>
            } @else {
              @if (state.currentPath) {
                <button mat-menu-item (click)="goUp('source')">
                  <mat-icon svgIcon="arrow-turn-up-left"></mat-icon> <span>.. (Up a folder)</span>
                </button>
              }
              @for (entry of state.options; track trackByEntry($index, entry)) {
                <button
                  mat-menu-item
                  (click)="onPathSelected('source', entry.Name)"
                  [disabled]="!entry.IsDir"
                >
                  <mat-icon [svgIcon]="entry.IsDir ? 'folder' : 'file'"></mat-icon>
                  <span>{{ entry.Name }}</span>
                </button>
              } @empty {
                @if (!state.isLoading && state.remoteName) {
                  <div class="no-results"><span>No items found in this directory.</span></div>
                }
              }
            }
          </mat-menu>
        </div>
      }
    }
  </div>

  @if (isMount) {
    <div class="path-section">
      <mat-form-field appearance="fill">
        <mat-label>Destination Path</mat-label>
        <span matPrefix class="path-prefix mount-local locked">
          <mat-icon svgIcon="folder" class="purple"></mat-icon>
          <span>Local Path</span>
        </span>
        <input
          matInput
          formControlName="dest"
          placeholder="Select a mount folder..."
          aria-label="Destination mount path"
        />
        <button
          matIconButton
          matSuffix
          (click)="onSelectFolder('dest')"
          type="button"
          aria-label="Select destination folder"
        >
          <mat-icon svgIcon="folder" class="purple"></mat-icon>
        </button>
        @if (opFormGroup.get('dest')?.hasError('required')) {
          <mat-error>Destination is required</mat-error>
        }
      </mat-form-field>
    </div>
  } @else {
    <div class="path-section" formGroupName="dest">
      @if (destPathState$ | async; as state) {
        <div class="path-input-wrapper">
          <mat-form-field appearance="fill">
            <mat-label>Destination Path</mat-label>
            <mat-select
              matPrefix
              formControlName="pathType"
              class="path-prefix"
              [class.local]="destPathType === 'local'"
              [class.remote]="destPathType === 'currentRemote'"
              [class.other]="destPathType === 'otherRemote'"
              aria-label="Change destination path type"
              (click)="$event.stopPropagation()"
              (selectionChange)="clearPathOnTypeChange('dest')"
            >
              <mat-select-trigger>
                @switch (destPathType) {
                  @case ('local') {
                    <mat-icon svgIcon="folder" class="purple"></mat-icon> <span>Local Path</span>
                  }
                  @case ('currentRemote') {
                    <mat-icon svgIcon="hard-drive" class="primary"></mat-icon>
                    <span>{{ currentRemoteName }}:/</span>
                  }
                  @case ('otherRemote') {
                    <mat-icon svgIcon="cloud" class="accent"></mat-icon>
                    <span>{{ opFormGroup.get('dest.otherRemoteName')?.value }}:/</span>
                  }
                }
              </mat-select-trigger>
              <mat-option value="local">
                <mat-icon svgIcon="folder" class="purple"></mat-icon> Local Path
              </mat-option>
              <mat-option value="currentRemote">
                <mat-icon svgIcon="hard-drive" class="primary"></mat-icon> {{ currentRemoteName }}:/
              </mat-option>
              @if (otherRemotes.length) {
                <mat-optgroup label="Other Remotes">
                  @for (remote of otherRemotes; track remote) {
                    <mat-option [value]="'otherRemote:' + remote">
                      <mat-icon class="accent" svgIcon="cloud"></mat-icon> {{ remote }}:/
                    </mat-option>
                  }
                </mat-optgroup>
              }
            </mat-select>

            <input
              matInput
              formControlName="path"
              placeholder="Enter destination path..."
              aria-label="Destination path"
              (input)="onInputChanged($event, 'dest')"
              (click)="$event.stopPropagation()"
              [matMenuTriggerFor]="destPathType !== 'local' ? destPathAutocompleteMenu : null"
            />

            @if (destPathType === 'local') {
              <button
                matIconButton
                matSuffix
                (click)="onSelectFolder('dest')"
                type="button"
                aria-label="Select destination folder"
              >
                <mat-icon svgIcon="folder" class="purple"></mat-icon>
              </button>
            }
            @if (opFormGroup.get('dest.path')?.hasError('required')) {
              <mat-error>Destination is required</mat-error>
            }
          </mat-form-field>

          <mat-menu
            #destPathAutocompleteMenu="matMenu"
            panelClass="path-autocomplete-menu"
            [overlapTrigger]="false"
          >
            @if (state.isLoading) {
              <div class="loading-spinner">
                <mat-spinner diameter="24"></mat-spinner> <span>Loading...</span>
              </div>
            } @else {
              @if (state.currentPath) {
                <button mat-menu-item (click)="goUp('dest')">
                  <mat-icon svgIcon="arrow-turn-up-left"></mat-icon> <span>.. (Up a folder)</span>
                </button>
              }
              @for (entry of state.options; track trackByEntry($index, entry)) {
                <button
                  mat-menu-item
                  (click)="onPathSelected('dest', entry.Name)"
                  [disabled]="!entry.IsDir"
                >
                  <mat-icon [svgIcon]="entry.IsDir ? 'folder' : 'file'"></mat-icon>
                  <span>{{ entry.Name }}</span>
                </button>
              } @empty {
                @if (!state.isLoading && state.remoteName) {
                  <div class="no-results"><span>No items found in this directory.</span></div>
                }
              }
            }
          </mat-menu>
        </div>
      }
    </div>
  }

  @if (isNewRemote) {
    <div class="message warning" role="status">
      <mat-icon svgIcon="info" class="orange"></mat-icon>
      <span> Note: Remote path completion available after creation of the remote. </span>
    </div>
  }
</div>
