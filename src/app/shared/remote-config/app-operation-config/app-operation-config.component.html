<div class="operation-config" [formGroup]="opFormGroup">
  <div class="header-section">
    <mat-slide-toggle formControlName="autoStart" class="operation-enable">
      {{ 'wizards.appOperation.enableAutoStart' | translate: { type: operationType | titlecase } }}
    </mat-slide-toggle>
    <p class="section-description">{{ description }}</p>

    @if (!isMount && !isServe) {
      <mat-divider></mat-divider>
      <mat-slide-toggle formControlName="cronEnabled" class="cron-enable">
        {{
          'wizards.appOperation.enableScheduled' | translate: { type: operationType | titlecase }
        }}
      </mat-slide-toggle>
      <p
        class="section-description"
        [innerHTML]="'wizards.appOperation.scheduleDescription' | translate"
      ></p>
    }
  </div>

  @if (!isMount && !isServe && isCronEnabled) {
    <mat-accordion class="cron-accordion" [multi]="false">
      <mat-expansion-panel class="cron-panel">
        <mat-expansion-panel-header>
          <mat-panel-title> {{ 'wizards.appOperation.cronSchedule' | translate }} </mat-panel-title>
          <mat-panel-description>
            <span [class.no-schedule]="!cronExpression">
              {{ cronExpression || ('wizards.appOperation.notConfigured' | translate) }}
            </span>
            @if (cronExpression) {
              <button
                mat-icon-button
                class="clear-schedule-btn"
                (click)="clearSchedule($event)"
                [matTooltip]="'wizards.appOperation.clearSchedule' | translate"
                type="button"
                [attr.aria-label]="'wizards.appOperation.clearSchedule' | translate"
              >
                <mat-icon svgIcon="circle-xmark"></mat-icon>
              </button>
            }
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div class="cron-content">
          <app-cron-input
            [initialValue]="cronExpression"
            [taskName]="operationType"
            (cronChange)="onCronChange($event)"
            (validationChange)="onCronValidationChange($event)"
          ></app-cron-input>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  }

  <!-- Source Path Section -->
  <div class="paths-container">
    <div class="path-section" formGroupName="source">
      @if (isMount || isServe) {
        <!-- Mount/Serve Source is Fixed to Current Remote -->
        <div class="path-input-wrapper">
          <mat-form-field appearance="fill">
            <mat-label>{{
              isServe
                ? ('wizards.appOperation.remotePathServe' | translate)
                : ('wizards.appOperation.sourcePath' | translate)
            }}</mat-label>
            <span matPrefix class="path-prefix mount-remote locked">
              <mat-icon svgIcon="hard-drive"></mat-icon>
              <span>{{ currentRemoteName }}:</span>
            </span>
            <input
              matInput
              formControlName="path"
              [placeholder]="
                isServe
                  ? ('wizards.appOperation.rootFolderSpecific' | translate)
                  : ('wizards.appOperation.rootFolderOptional' | translate)
              "
              [attr.aria-label]="
                isServe
                  ? ('wizards.appOperation.remotePathServe' | translate)
                  : ('wizards.appOperation.sourcePath' | translate)
              "
              (input)="onInputChanged($event, 'source')"
              [cdkMenuTriggerFor]="sourceAutocompleteMenu"
            />
            <button
              matIconButton
              matSuffix
              (click)="selectRemotePath('source'); $event.stopPropagation()"
              type="button"
              [attr.aria-label]="'wizards.appOperation.selectRemoteSource' | translate"
            >
              <mat-icon svgIcon="folder" class="accent"></mat-icon>
            </button>
          </mat-form-field>
        </div>
      } @else {
        <!-- Standard Source Path (Sync/Copy/Move) -->
        <div class="path-input-wrapper">
          <mat-form-field appearance="fill">
            <mat-label>{{ 'wizards.appOperation.sourcePath' | translate }}</mat-label>
            <mat-select
              matPrefix
              formControlName="pathType"
              class="path-prefix"
              [class.local]="sourcePathType === 'local'"
              [class.remote]="sourcePathType === 'currentRemote'"
              [class.other]="sourcePathType === 'otherRemote'"
              [attr.aria-label]="'wizards.appOperation.changeSourceType' | translate"
              (selectionChange)="clearPathOnTypeChange('source')"
            >
              <mat-select-trigger>
                @switch (sourcePathType) {
                  @case ('local') {
                    <mat-icon svgIcon="folder" class="purple"></mat-icon>
                    <span>{{ 'wizards.appOperation.localPath' | translate }}</span>
                  }
                  @case ('currentRemote') {
                    <mat-icon svgIcon="hard-drive" class="primary"></mat-icon>
                    <span>{{ currentRemoteName }}:</span>
                  }
                  @case ('otherRemote') {
                    <mat-icon svgIcon="cloud" class="accent"></mat-icon>
                    <span>{{ opFormGroup.get('source.otherRemoteName')?.value }}:</span>
                  }
                }
              </mat-select-trigger>

              <mat-option value="local">
                <mat-icon svgIcon="folder" class="purple"></mat-icon>
                {{ 'wizards.appOperation.localPath' | translate }}
              </mat-option>
              <mat-option value="currentRemote">
                <mat-icon svgIcon="hard-drive" class="primary"></mat-icon>
                {{ currentRemoteName }}:
              </mat-option>

              @if (otherRemotes.length) {
                <mat-optgroup [label]="'wizards.appOperation.otherRemotes' | translate">
                  @for (remote of otherRemotes; track remote) {
                    <mat-option [value]="'otherRemote:' + remote">
                      <mat-icon class="accent" svgIcon="cloud"></mat-icon>
                      {{ remote }}:
                    </mat-option>
                  }
                </mat-optgroup>
              }
            </mat-select>

            <input
              matInput
              formControlName="path"
              [placeholder]="'wizards.appOperation.enterSourcePath' | translate"
              [attr.aria-label]="'wizards.appOperation.sourcePath' | translate"
              (click)="$event.stopPropagation()"
              (input)="onInputChanged($event, 'source')"
              [cdkMenuTriggerFor]="sourceAutocompleteMenu"
            />

            <!-- Picker Button -->
            <button
              matIconButton
              matSuffix
              (click)="selectRemotePath('source'); $event.stopPropagation()"
              type="button"
              [attr.aria-label]="'wizards.appOperation.selectRemoteSource' | translate"
            >
              <mat-icon
                svgIcon="folder"
                [class.purple]="sourcePathType === 'local'"
                [class.accent]="sourcePathType !== 'local'"
              ></mat-icon>
            </button>
          </mat-form-field>
        </div>
      }
    </div>

    <!-- Destination Path Section -->
    @if (isMount && !isServe) {
      <div class="path-section">
        <div class="path-input-wrapper">
          <mat-form-field appearance="fill">
            <mat-label>{{ 'wizards.appOperation.destPath' | translate }}</mat-label>
            <span matPrefix class="path-prefix mount-local locked">
              <mat-icon svgIcon="folder" class="purple"></mat-icon>
              <span>{{ 'wizards.appOperation.localPath' | translate }}</span>
            </span>
            <input
              matInput
              formControlName="dest"
              [placeholder]="'wizards.appOperation.selectDestFolder' | translate"
              [attr.aria-label]="'wizards.appOperation.destPath' | translate"
              (input)="onInputChanged($event, 'dest')"
              [cdkMenuTriggerFor]="destAutocompleteMenu"
            />
            <!-- Picker Button for Mount Dest (Local) -->
            <button
              matIconButton
              matSuffix
              (click)="selectRemotePath('dest'); $event.stopPropagation()"
              type="button"
              [attr.aria-label]="'wizards.appOperation.selectDestFolder' | translate"
            >
              <mat-icon svgIcon="folder" class="purple"></mat-icon>
            </button>
            @if (opFormGroup.get('dest')?.hasError('required')) {
              <mat-error>{{ 'wizards.appOperation.destRequired' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>
      </div>
    } @else if (!isMount && !isServe) {
      <div class="path-section" formGroupName="dest">
        <div class="path-input-wrapper">
          <mat-form-field appearance="fill">
            <mat-label>{{ 'wizards.appOperation.destPath' | translate }}</mat-label>
            <mat-select
              matPrefix
              formControlName="pathType"
              class="path-prefix"
              [class.local]="destPathType === 'local'"
              [class.remote]="destPathType === 'currentRemote'"
              [class.other]="destPathType === 'otherRemote'"
              [attr.aria-label]="'wizards.appOperation.changeDestPathType' | translate"
              (selectionChange)="clearPathOnTypeChange('dest')"
            >
              <mat-select-trigger>
                @switch (destPathType) {
                  @case ('local') {
                    <mat-icon svgIcon="folder" class="purple"></mat-icon>
                    <span>{{ 'wizards.appOperation.localPath' | translate }}</span>
                  }
                  @case ('currentRemote') {
                    <mat-icon svgIcon="hard-drive" class="primary"></mat-icon>
                    <span>{{ currentRemoteName }}:</span>
                  }
                  @case ('otherRemote') {
                    <mat-icon svgIcon="cloud" class="accent"></mat-icon>
                    <span>{{ opFormGroup.get('dest.otherRemoteName')?.value }}:</span>
                  }
                }
              </mat-select-trigger>

              <mat-option value="local">
                <mat-icon svgIcon="folder" class="purple"></mat-icon>
                {{ 'wizards.appOperation.localPath' | translate }}
              </mat-option>
              <mat-option value="currentRemote">
                <mat-icon svgIcon="hard-drive" class="primary"></mat-icon>
                {{ currentRemoteName }}:
              </mat-option>

              @if (otherRemotes.length) {
                <mat-optgroup [label]="'wizards.appOperation.otherRemotes' | translate">
                  @for (remote of otherRemotes; track remote) {
                    <mat-option [value]="'otherRemote:' + remote">
                      <mat-icon class="accent" svgIcon="cloud"></mat-icon>
                      {{ remote }}:
                    </mat-option>
                  }
                </mat-optgroup>
              }
            </mat-select>

            <input
              matInput
              formControlName="path"
              [placeholder]="'wizards.appOperation.enterDestPath' | translate"
              [attr.aria-label]="'wizards.appOperation.destPath' | translate"
              (click)="$event.stopPropagation()"
              (input)="onInputChanged($event, 'dest')"
              [cdkMenuTriggerFor]="destAutocompleteMenu"
            />

            <!-- Picker Button -->
            <button
              matIconButton
              matSuffix
              (click)="selectRemotePath('dest'); $event.stopPropagation()"
              type="button"
              [attr.aria-label]="'wizards.appOperation.selectDestFolder' | translate"
            >
              <mat-icon
                svgIcon="folder"
                [class.purple]="destPathType === 'local'"
                [class.accent]="destPathType !== 'local'"
              ></mat-icon>
            </button>

            @if (opFormGroup.get('dest.path')?.hasError('required')) {
              <mat-error>{{ 'wizards.appOperation.destRequired' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>
      </div>
    }

    @if (isNewRemote) {
      <div class="message warning" role="alert">
        <mat-icon svgIcon="info" class="orange"></mat-icon>
        <span>{{ 'wizards.appOperation.completionNote' | translate }}</span>
      </div>
    }
  </div>
</div>

<!-- Source Path Autocomplete Menu -->
<ng-template #sourceAutocompleteMenu>
  @if (sourcePathState$ | async; as state) {
    <div class="material-context-menu" cdkMenu>
      @if (state.isLoading) {
        <div class="menu-item">
          <mat-spinner diameter="24"></mat-spinner>
          <span>{{ 'wizards.appOperation.loading' | translate }}</span>
        </div>
      } @else {
        @if (state.currentPath) {
          <button cdkMenuItem class="menu-item" (click)="goUp('source')">
            <mat-icon svgIcon="arrow-turn-up-left"></mat-icon>
            <span>{{ 'wizards.appOperation.upFolder' | translate }}</span>
          </button>
          <mat-divider></mat-divider>
        }
        @if (state.options.length === 0 && !state.isLoading) {
          <div class="empty-state">
            <span>{{ 'wizards.appOperation.noItemsFound' | translate }}</span>
          </div>
        }
        @for (entry of state.options; track trackByEntry($index, entry)) {
          <button
            cdkMenuItem
            class="menu-item"
            [disabled]="!entry.IsDir"
            (click)="entry.IsDir && onPathSelected(entry.Name, 'source')"
          >
            <mat-icon [svgIcon]="entry.IsDir ? 'folder' : 'file'"></mat-icon>
            <span>{{ entry.Name }}</span>
          </button>
        }
      }
    </div>
  }
</ng-template>

<!-- Destination Path Autocomplete Menu -->
<ng-template #destAutocompleteMenu>
  @if (destPathState$ | async; as state) {
    <div class="material-context-menu" cdkMenu>
      @if (state.isLoading) {
        <div class="menu-item">
          <mat-spinner diameter="24"></mat-spinner>
          <span>{{ 'wizards.appOperation.loading' | translate }}</span>
        </div>
      } @else {
        @if (state.currentPath) {
          <button cdkMenuItem class="menu-item" (click)="goUp('dest')">
            <mat-icon svgIcon="arrow-turn-up-left"></mat-icon>
            <span>{{ 'wizards.appOperation.upFolder' | translate }}</span>
          </button>
          <mat-divider></mat-divider>
        }
        @if (state.options.length === 0 && !state.isLoading) {
          <div class="empty-state">
            <span>{{ 'wizards.appOperation.noItemsFound' | translate }}</span>
          </div>
        }
        @for (entry of state.options; track trackByEntry($index, entry)) {
          <button
            cdkMenuItem
            class="menu-item"
            [disabled]="!entry.IsDir"
            (click)="entry.IsDir && onPathSelected(entry.Name, 'dest')"
          >
            <mat-icon [svgIcon]="entry.IsDir ? 'folder' : 'file'"></mat-icon>
            <span>{{ entry.Name }}</span>
          </button>
        }
      }
    </div>
  }
</ng-template>
