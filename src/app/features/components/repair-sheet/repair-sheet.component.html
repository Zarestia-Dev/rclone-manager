<mat-nav-list class="repair-sheet" [class.repairing]="installing()">
  <div class="sheet-header">
    <div class="repair-header-top">
      <div class="repair-icon">
        <mat-icon [svgIcon]="getRepairIcon()"></mat-icon>
      </div>

      <div class="repair-content">
        <h3>{{ data.title || 'Repair Required' }}</h3>
        <p>{{ data.message || 'A problem was detected. You can try repairing it below.' }}</p>
      </div>
    </div>

    @if (getRepairDetails()) {
      <div class="repair-details">
        @for (detail of getRepairDetails(); track $index) {
          <div class="detail-item">
            <mat-icon svgIcon="{{ detail.icon }}"></mat-icon>
            <span
              ><strong>{{ detail.label }}:</strong> {{ detail.value }}</span
            >
          </div>
        }
      </div>
    }

    @if (requiresPassword()) {
      <div class="password-row">
        <app-password-manager
          [password]="password()"
          [storePassword]="storePassword()"
          [isSubmitting]="isSubmittingPassword()"
          [hasError]="hasPasswordError()"
          [errorMessage]="passwordErrorMessage()"
          [showStoreOption]="!!data.showStoreOption"
          [disabled]="installing() || showConfigOptions()"
          (passwordChange)="password.set($event)"
          (storePasswordChange)="storePassword.set($event)"
          (unlock)="submitPassword()"
        ></app-password-manager>
      </div>

      <div class="advanced-toggle" style="margin-top: 1rem">
        <button
          matButton="filled"
          class="accent"
          (click)="toggleConfigOptions()"
          [disabled]="installing() || isSubmittingPassword()"
        >
          <mat-icon
            svgIcon="caret-down"
            [style.transform]="showConfigOptions() ? 'rotate(180deg)' : 'rotate(0deg)'"
            style="transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"
          ></mat-icon>
          {{ showConfigOptions() ? 'Hide Config Options' : 'Use Different Config File' }}
        </button>
      </div>

      @if (showConfigOptions()) {
        <app-installation-options
          [mode]="'config'"
          [tabOptions]="configTabOptions"
          [disabled]="installing()"
          (dataChange)="onInstallationOptionsChange($event)"
          (validChange)="onInstallationValidChange($event)"
        >
        </app-installation-options>
      }
    }

    @if (isRclonePathRepair()) {
      <div class="advanced-toggle">
        <button
          matButton="filled"
          class="accent"
          (click)="toggleInstallOptions()"
          [disabled]="installing()"
        >
          <mat-icon
            svgIcon="caret-down"
            [style.transform]="showAdvanced() ? 'rotate(180deg)' : 'rotate(0deg)'"
            style="transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)"
          ></mat-icon>
          {{ showAdvanced() ? 'Hide' : 'Show' }} Advanced Options
        </button>
      </div>

      @if (showAdvanced()) {
        <app-installation-options
          [mode]="'install'"
          [disabled]="installing()"
          (dataChange)="onInstallationOptionsChange($event)"
          (validChange)="onInstallationValidChange($event)"
        >
        </app-installation-options>
      }
    }
  </div>

  <div class="sheet-actions">
    <button
      matButton="filled"
      [disabled]="!canRepair()"
      class="repair-button"
      (click)="repair()"
      [attr.aria-label]="installing() ? 'Repairing in progress' : 'Start repair process'"
      [matTooltip]="
        !canRepair() && !installing() && !isSubmittingPassword()
          ? showConfigOptions()
            ? installationData().installLocation === 'custom' &&
              installationData().customPath.trim().length === 0
              ? 'Please select a config file first'
              : !installationValid()
                ? 'Please fix validation errors'
                : ''
            : requiresPassword() && !password()
              ? 'Please enter the configuration password first'
              : requiresPassword()
                ? 'Account is temporarily locked due to failed attempts'
                : installationData().installLocation === 'custom' &&
                    installationData().customPath.trim().length === 0
                  ? 'Please select an installation path first'
                  : installationData().installLocation === 'existing' &&
                      installationData().existingBinaryPath.trim().length === 0
                    ? 'Please select a binary file first'
                    : installationData().installLocation === 'existing' &&
                        installationData().binaryTestResult === 'invalid'
                      ? 'The selected file is not a valid rclone binary'
                      : installationData().installLocation === 'existing' &&
                          installationData().binaryTestResult === 'untested'
                        ? 'Please test the selected binary first'
                        : !installationValid()
                          ? 'Please fix validation errors'
                          : ''
          : ''
      "
    >
      {{
        installing() || isSubmittingPassword()
          ? isSubmittingPassword()
            ? 'Validating Password...'
            : repairProgressText()
          : repairButtonText()
      }}
      <mat-icon
        [svgIcon]="repairButtonIcon()"
        [class.animate-spin]="installing() || isSubmittingPassword()"
      ></mat-icon>
    </button>
  </div>
</mat-nav-list>
