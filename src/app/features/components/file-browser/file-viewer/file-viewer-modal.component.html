<div class="file-viewer-wrapper">
  <div class="file-viewer-header" data-tauri-drag-region>
    <div class="header-left">
      <span class="file-name">{{ data.name }}</span>
      <div class="file-info">
        <span class="file-counter">{{ data.currentIndex + 1 }} / {{ data.items.length }}</span>
        @if (fileSize()) {
          <span class="separator"></span>
          <span class="file-size">{{ fileSize() ?? 0 | formatFileSize }}</span>
        }
      </div>
    </div>
    <div class="header-actions">
      @if (!this.data.isLocal) {
        <button
          mat-icon-button
          class="header-button"
          [disabled]="isDownloading()"
          (click)="download(); $event.stopPropagation()"
          [attr.aria-label]="'Download ' + data.name"
        >
          @if (isDownloading()) {
            <mat-spinner diameter="20"></mat-spinner>
          } @else {
            <mat-icon svgIcon="download"></mat-icon>
          }
        </button>
      }
      <button
        mat-icon-button
        class="header-button close-button"
        (click)="closeViewer.emit(); $event.stopPropagation()"
        aria-label="Close viewer"
      >
        <mat-icon svgIcon="circle-xmark"></mat-icon>
      </button>
    </div>
  </div>

  <div class="file-viewer-content">
    @if (data.items.length > 1 && data.currentIndex > 0) {
      <button
        mat-icon-button
        class="nav-button prev"
        (click)="back(); $event.stopPropagation()"
        aria-label="Previous file"
        [attr.aria-keyshortcuts]="'ArrowLeft'"
      >
        <mat-icon svgIcon="chevron-left"></mat-icon>
      </button>
    }

    <main role="main" aria-live="polite">
      @if (isLoading()) {
        <div class="loading-spinner" role="status" aria-label="Loading content">
          <mat-spinner diameter="50"></mat-spinner>
        </div>
      }

      <div class="content-container" [class.loading]="isLoading()">
        @switch (data.fileType) {
          @case ('image') {
            <img
              [src]="sanitizedUrl"
              [alt]="data.name"
              class="preview-content image-content"
              (load)="onLoadComplete()"
              (error)="onLoadError()"
            />
          }
          @case ('video') {
            <video
              [src]="sanitizedUrl"
              controls
              class="preview-content video-content"
              (loadeddata)="onLoadComplete()"
              (error)="onLoadError()"
              [attr.aria-label]="'Video: ' + data.name"
            ></video>
          }
          @case ('audio') {
            <div class="audio-container">
              <div class="audio-icon-wrapper">
                <mat-icon svgIcon="music" aria-hidden="true"></mat-icon>
              </div>
              <audio
                [src]="sanitizedUrl"
                controls
                (loadeddata)="onLoadComplete()"
                (error)="onLoadError()"
                [attr.aria-label]="'Audio: ' + data.name"
              ></audio>
            </div>
          }
          @case ('pdf') {
            <iframe
              [src]="sanitizedUrl"
              class="pdf-viewer"
              (load)="onLoadComplete()"
              [attr.title]="'PDF: ' + data.name"
            ></iframe>
          }
          @case ('text') {
            <div class="text-container" role="document">
              <pre>{{ textContent() }}</pre>
            </div>
          }
          @case ('directory') {
            <div class="unsupported-container" role="status">
              <div class="icon-wrapper">
                <mat-icon svgIcon="folder" aria-hidden="true"></mat-icon>
              </div>
              @if (folderSize()) {
                <p class="unsupported-text">{{ data.name }}</p>
                <p class="unsupported-subtext">Contains {{ folderSize()?.count ?? 0 }} files</p>
                <p class="unsupported-subtext">
                  Total size: {{ folderSize()?.bytes ?? 0 | formatFileSize }}
                </p>
              } @else {
                <p class="unsupported-text">Calculating folder size...</p>
              }
            </div>
          }
          @case ('binary') {
            <div class="unsupported-container" role="status">
              <div class="icon-wrapper">
                <mat-icon svgIcon="file-zipper" aria-hidden="true"></mat-icon>
              </div>
              <p class="unsupported-text">Binary file</p>
              <p class="unsupported-subtext">{{ data.name }}</p>
            </div>
          }
          @default {
            <div class="unsupported-container" role="status">
              <div class="icon-wrapper">
                <mat-icon
                  [svgIcon]="iconService.getIconForFileType(data.fileType)"
                  aria-hidden="true"
                ></mat-icon>
              </div>
              <p class="unsupported-text">Preview not available for this file type</p>
              <p class="unsupported-subtext">{{ data.name }}</p>
            </div>
          }
        }
      </div>
    </main>

    @if (data.items.length > 1 && data.currentIndex < data.items.length - 1) {
      <button
        mat-icon-button
        class="nav-button next"
        (click)="next(); $event.stopPropagation()"
        aria-label="Next file"
        [attr.aria-keyshortcuts]="'ArrowRight'"
      >
        <mat-icon svgIcon="chevron-right"></mat-icon>
      </button>
    }
  </div>
</div>
