<div class="general-overview" animate.enter="fade-in-out-enter" animate.leave="fade-in-out-leave">
  <div class="overview-header" role="banner">
    <div class="header-content">
      <app-overview-header [mode]="'general'" (openBackendModal)="openBackendModal.emit()">
      </app-overview-header>
    </div>
  </div>

  <div class="overview-content" role="main">
    <div class="layout-grid">
      <mat-accordion multi cdkDropList (cdkDropListDropped)="drop($event)">
        @for (panel of dashboardPanels(); track panel.id) {
          @if (panel.visible || isEditingLayout()) {
            <div
              cdkDrag
              [cdkDragDisabled]="!isEditingLayout()"
              class="draggable-panel-wrapper"
              [class.editing]="isEditingLayout()"
            >
              <div class="custom-placeholder" *cdkDragPlaceholder></div>

              @if (isEditingLayout()) {
                <div
                  class="panel-edit-controls"
                  cdkDragHandle
                  animate.enter="expand-height-enter"
                  animate.leave="expand-height-leave"
                >
                  <div>
                    <mat-icon svgIcon="menu-bar"></mat-icon>
                  </div>
                  <span class="panel-label">{{ panel.title | translate }}</span>

                  <div class="visibility-toggle">
                    <span class="toggle-label">{{
                      panel.visible
                        ? ('generalOverview.layout.visible' | translate)
                        : ('generalOverview.layout.hidden' | translate)
                    }}</span>
                    <mat-slide-toggle
                      [checked]="panel.visible"
                      (change)="togglePanelVisibility(panel.id)"
                      class="primary"
                    >
                    </mat-slide-toggle>
                  </div>
                </div>
              }

              <div
                [class.panel-hidden-visual]="isEditingLayout() && !panel.visible"
                class="panel-content-wrapper"
              >
                @switch (panel.id) {
                  @case ('remotes') {
                    <!-- Quick Remote Access Panel -->
                    <app-remotes-panel
                      [title]="'generalOverview.panels.remotes' | translate"
                      [icon]="'cloud'"
                      [remotes]="remotes()"
                      [mode]="'general'"
                      [actionInProgress]="actionInProgress()"
                      [primaryActionLabel]="'actions.mount' | translate"
                      [activeIcon]="'mount'"
                      (remoteSelected)="onRemoteSelectedFromPanel($event)"
                      (openInFiles)="onOpenInFilesFromPanel($event)"
                      (startJob)="
                        startJob.emit({ type: $event.type, remoteName: $event.remoteName })
                      "
                      (stopJob)="
                        stopJob.emit({
                          type: $event.type,
                          remoteName: $event.remoteName,
                          profileName: $event.profileName,
                        })
                      "
                      role="region"
                      aria-labelledby="remotes-panel-title"
                    >
                    </app-remotes-panel>
                  }
                  @case ('bandwidth') {
                    <mat-expansion-panel
                      [expanded]="getPanelOpenState('bandwidth')"
                      (opened)="setPanelOpenState('bandwidth', true)"
                      (closed)="setPanelOpenState('bandwidth', false)"
                      class="bandwidth-panel"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <div class="panel-title-content">
                            <mat-icon
                              svgIcon="right-left"
                              class="primary"
                              aria-hidden="true"
                            ></mat-icon>
                            <span>{{ 'generalOverview.panels.bandwidth' | translate }}</span>
                          </div>
                        </mat-panel-title>
                        <mat-panel-description>
                          <span aria-live="polite">
                            @if (bandwidthLimit()?.loading) {
                              <span aria-busy="true">{{
                                'generalOverview.bandwidth.loading' | translate
                              }}</span>
                            } @else if (bandwidthLimit()?.error) {
                              <span class="error-text">{{
                                'generalOverview.bandwidth.error' | translate
                              }}</span>
                            } @else {
                              <span>{{ bandwidthLimit()?.rate | formatRateValue }}</span>
                            }
                          </span>
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      @if (bandwidthLimit()?.loading) {
                        <div class="loading fade-in" aria-live="polite">
                          <mat-spinner
                            diameter="24"
                            [attr.aria-label]="'generalOverview.bandwidth.aria.loading' | translate"
                          ></mat-spinner>
                          <span>{{ 'generalOverview.bandwidth.loading' | translate }}</span>
                        </div>
                      } @else if (bandwidthLimit()?.error) {
                        <div class="bandwidth-error" role="alert">
                          <mat-icon
                            class="warn"
                            svgIcon="circle-exclamation"
                            aria-hidden="true"
                          ></mat-icon>
                          <span>{{ bandwidthLimit()?.error }}</span>
                          <button
                            matIconButton
                            (click)="rcloneStatusService.loadBandwidthLimit()"
                            [matTooltip]="'generalOverview.bandwidth.retry' | translate"
                            [aria-label]="'generalOverview.bandwidth.retry' | translate"
                          >
                            <mat-icon
                              class="primary"
                              svgIcon="refresh"
                              aria-hidden="true"
                            ></mat-icon>
                          </button>
                        </div>
                      } @else {
                        <div class="bandwidth-content">
                          <div
                            class="bandwidth-status"
                            [class.limited]="isBandwidthLimited()"
                            [class.unlimited]="!isBandwidthLimited()"
                            aria-live="polite"
                          >
                            <div class="status-indicator" aria-hidden="true"></div>
                            <span class="status-text">{{
                              bandwidthLimit()?.rate | formatRateValue
                            }}</span>
                          </div>

                          @if (isBandwidthLimited()) {
                            <div class="bandwidth-details">
                              @for (
                                detail of [
                                  {
                                    label: ('generalOverview.bandwidth.upload' | translate),
                                    value: (bandwidthLimit()?.bytesPerSecondTx | formatRateValue),
                                  },
                                  {
                                    label: ('generalOverview.bandwidth.download' | translate),
                                    value: (bandwidthLimit()?.bytesPerSecondRx | formatRateValue),
                                  },
                                  {
                                    label: ('generalOverview.bandwidth.total' | translate),
                                    value: (bandwidthLimit()?.bytesPerSecond | formatRateValue),
                                  },
                                ];
                                track $index
                              ) {
                                <div class="detail-item">
                                  <span class="label">{{ detail.label }}</span>
                                  <span class="value">{{ detail.value }}</span>
                                </div>
                              }
                            </div>
                          }
                        </div>
                      }
                    </mat-expansion-panel>
                  }
                  @case ('system') {
                    <mat-expansion-panel
                      [expanded]="getPanelOpenState('system')"
                      (opened)="setPanelOpenState('system', true)"
                      (closed)="setPanelOpenState('system', false)"
                      class="system-info-panel"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <div class="panel-title-content">
                            <mat-icon
                              svgIcon="question"
                              class="orange"
                              aria-hidden="true"
                            ></mat-icon>
                            <span>{{ 'generalOverview.panels.system' | translate }}</span>
                          </div>
                        </mat-panel-title>
                        <mat-panel-description>
                          <div
                            class="status-indicator-small"
                            [ngClass]="rcloneStatus()"
                            aria-hidden="true"
                          ></div>
                          {{ 'generalOverview.system.' + rcloneStatus() | translate }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      @if (isLoadingStats()) {
                        <div class="loading fade-in" aria-live="polite">
                          <mat-spinner
                            diameter="24"
                            [attr.aria-label]="'generalOverview.system.aria.loading' | translate"
                          ></mat-spinner>
                          <span>{{ 'generalOverview.system.loading' | translate }}</span>
                        </div>
                      } @else {
                        <div class="info-grid" role="grid">
                          @for (
                            item of [
                              {
                                label: ('generalOverview.system.status' | translate),
                                value: ('generalOverview.system.' + rcloneStatus() | translate),
                                status: rcloneStatus(),
                              },
                              {
                                label: ('generalOverview.system.totalRemotes' | translate),
                                value: totalRemotes(),
                              },
                              {
                                label: ('generalOverview.system.activeJobs' | translate),
                                value: activeJobsCount(),
                              },
                              {
                                label: ('generalOverview.system.memoryUsage' | translate),
                                value: (systemStats().memoryUsage | formatMemoryUsage),
                              },
                              {
                                label: ('generalOverview.system.uptime' | translate),
                                value: (systemStats().uptime | formatTime),
                              },
                            ];
                            track $index
                          ) {
                            <div class="info-item" role="row">
                              <span class="label" role="gridcell">{{ item.label }}</span>
                              <span class="value" [ngClass]="item.status || ''" role="gridcell">{{
                                item.value
                              }}</span>
                            </div>
                          }
                        </div>
                      }
                    </mat-expansion-panel>
                  }
                  @case ('jobs') {
                    <mat-expansion-panel
                      [expanded]="getPanelOpenState('jobs')"
                      (opened)="setPanelOpenState('jobs', true)"
                      (closed)="setPanelOpenState('jobs', false)"
                      class="job-info-panel"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <div class="panel-title-content">
                            <mat-icon svgIcon="jobs" class="yellow" aria-hidden="true"></mat-icon>
                            <span>{{ 'generalOverview.panels.jobs' | translate }}</span>
                          </div>
                        </mat-panel-title>
                        <mat-panel-description>
                          <span [ngClass]="{ 'active-jobs-indicator': activeJobsCount() > 0 }">
                            {{
                              activeJobsCount() > 0
                                ? ('generalOverview.jobs.activeCount'
                                  | translate
                                    : {
                                        count: activeJobsCount(),
                                        s: activeJobsCount() !== 1 ? 's' : '',
                                      })
                                : ('generalOverview.jobs.noActive' | translate)
                            }}
                          </span>
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      @if (isLoadingStats()) {
                        <div class="loading fade-in" aria-live="polite">
                          <mat-spinner
                            diameter="24"
                            [attr.aria-label]="'generalOverview.jobs.aria.loading' | translate"
                          ></mat-spinner>
                          <span>{{ 'generalOverview.jobs.loading' | translate }}</span>
                        </div>
                      } @else {
                        <div class="job-grid" role="grid">
                          @if (jobStats().totalBytes > 0) {
                            <div class="job-progress-section" role="rowgroup">
                              <div class="progress-header" role="row">
                                <span class="label" role="gridcell">{{
                                  'generalOverview.jobs.progress' | translate
                                }}</span>
                                <span class="value" role="gridcell"
                                  >{{ jobCompletionPercentage() | number: '1.0-1' }}%</span
                                >
                              </div>
                              <mat-progress-bar
                                mode="determinate"
                                [value]="jobCompletionPercentage()"
                                role="progressbar"
                                [attr.aria-valuenow]="jobCompletionPercentage()"
                                aria-valuemin="0"
                                aria-valuemax="100"
                              ></mat-progress-bar>
                              <div class="progress-details" role="row">
                                <span role="gridcell"
                                  >{{ jobStats().bytes | formatBytes }}
                                  {{ 'generalOverview.jobs.of' | translate }}
                                  {{ jobStats().totalBytes | formatBytes }}</span
                                >
                                <span role="gridcell"
                                  >{{ 'generalOverview.jobs.eta' | translate }}
                                  {{ jobStats().eta | formatEta }}</span
                                >
                              </div>
                            </div>
                          }

                          <div class="job-stats-grid" role="grid">
                            @for (
                              item of [
                                {
                                  label: ('generalOverview.jobs.speed' | translate),
                                  value: (jobStats().speed | formatBytes),
                                },
                                {
                                  label: ('generalOverview.jobs.transfers' | translate),
                                  value: jobStats().transfers + ' / ' + jobStats().totalTransfers,
                                },
                                {
                                  label: ('generalOverview.jobs.checks' | translate),
                                  value: jobStats().checks + ' / ' + jobStats().totalChecks,
                                },
                                {
                                  label: ('generalOverview.jobs.errors' | translate),
                                  value: jobStats().errors,
                                  error: jobStats().errors > 0,
                                },
                                {
                                  label: ('generalOverview.jobs.deletes' | translate),
                                  value: jobStats().deletes,
                                },
                                {
                                  label: ('generalOverview.jobs.renames' | translate),
                                  value: jobStats().renames,
                                },
                                {
                                  label: ('generalOverview.jobs.serverCopies' | translate),
                                  value: jobStats().serverSideCopies,
                                },
                                {
                                  label: ('generalOverview.jobs.serverMoves' | translate),
                                  value: jobStats().serverSideMoves,
                                },
                              ];
                              track $index
                            ) {
                              <div class="info-item" role="row">
                                <span class="label" role="gridcell">{{ item.label }}</span>
                                <span class="value" [class.error]="item.error" role="gridcell">{{
                                  item.value
                                }}</span>
                              </div>
                            }
                          </div>

                          @if (jobStats().lastError) {
                            <div class="error-section" role="alert">
                              <div class="label">
                                {{ 'generalOverview.jobs.lastError' | translate }}
                              </div>
                              <div class="error-message">
                                <mat-icon
                                  svgIcon="circle-exclamation"
                                  class="error-icon warn"
                                  aria-hidden="true"
                                ></mat-icon>
                                <span
                                  matTooltip="{{ 'generalOverview.jobs.copyError' | translate }}"
                                  (click)="copyError(jobStats().lastError)"
                                  tabindex="0"
                                  role="button"
                                  class="error-text-content"
                                  >{{ jobStats().lastError }}</span
                                >
                              </div>
                            </div>
                          }

                          @if (activeJobsCount() === 0) {
                            <div class="no-jobs-message" role="status">
                              <mat-icon svgIcon="circle-info" aria-hidden="true"></mat-icon>
                              <span>{{ 'generalOverview.jobs.noRunning' | translate }}</span>
                            </div>
                          }
                        </div>
                      }
                    </mat-expansion-panel>
                  }
                  @case ('tasks') {
                    <mat-expansion-panel
                      [expanded]="getPanelOpenState('tasks')"
                      (opened)="setPanelOpenState('tasks', true)"
                      (closed)="setPanelOpenState('tasks', false)"
                      class="scheduled-tasks-panel"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <div class="panel-title-content">
                            <mat-icon svgIcon="clock" class="accent" aria-hidden="true"></mat-icon>
                            <span>{{ 'generalOverview.panels.tasks' | translate }}</span>
                          </div>
                        </mat-panel-title>
                        <mat-panel-description>
                          <span
                            [ngClass]="{
                              'active-tasks-indicator': activeScheduledTasksCount() > 0,
                            }"
                          >
                            {{
                              totalScheduledTasksCount() > 0
                                ? ('generalOverview.tasks.activeCount'
                                  | translate
                                    : {
                                        active: activeScheduledTasksCount(),
                                        total: totalScheduledTasksCount(),
                                      })
                                : ('generalOverview.tasks.noScheduled' | translate)
                            }}
                          </span>
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      @if (isLoadingScheduledTasks()) {
                        <div class="loading fade-in" aria-live="polite">
                          <mat-spinner
                            diameter="24"
                            [attr.aria-label]="'generalOverview.tasks.aria.loading' | translate"
                          ></mat-spinner>
                          <span>{{ 'generalOverview.tasks.loading' | translate }}</span>
                        </div>
                      } @else {
                        <div class="scheduled-tasks-content">
                          @if (totalScheduledTasksCount() === 0) {
                            <div class="no-tasks-message" role="status">
                              <mat-icon svgIcon="circle-info" aria-hidden="true"></mat-icon>
                              <span>{{ 'generalOverview.tasks.noConfigured' | translate }}</span>
                            </div>
                          } @else {
                            <div class="tasks-grid">
                              @for (task of scheduledTasks(); track task.id) {
                                <mat-card
                                  class="task-card"
                                  [class.disabled]="task.status === 'disabled'"
                                  [class.stopping]="task.status === 'stopping'"
                                  (click)="onTaskClick(task)"
                                  (keydown)="onTaskKeydown($event, task)"
                                  role="button"
                                  tabindex="0"
                                  [attr.aria-label]="
                                    'generalOverview.tasks.ariaLabel'
                                      | translate
                                        : {
                                            type: (task.taskType | titlecase),
                                            remote: task.args['remoteName'],
                                            status: (task.status | titlecase),
                                          }
                                  "
                                >
                                  <mat-card-header class="task-header">
                                    <div class="task-info-section">
                                      <div
                                        class="task-icon-wrapper"
                                        [class]="getTaskTypeColor(task.taskType)"
                                      >
                                        <mat-icon
                                          [svgIcon]="getTaskTypeIcon(task.taskType)"
                                        ></mat-icon>
                                      </div>
                                      <div class="task-title-section">
                                        <div class="task-name-row">
                                          <span class="task-name">{{ task.name }}</span>
                                          <span
                                            class="task-status-badge"
                                            [ngClass]="task.status"
                                            [matTooltip]="
                                              getTaskStatusTooltip(task.status) | translate
                                            "
                                          >
                                            {{ 'task.status.' + task.status | translate }}
                                          </span>
                                          @if (task.currentJobId) {
                                            <div class="task-running-badge">
                                              <mat-icon
                                                svgIcon="play"
                                                class="running-icon"
                                              ></mat-icon>
                                              <span>{{
                                                'generalOverview.tasks.running' | translate
                                              }}</span>
                                            </div>
                                          }
                                        </div>
                                        <span class="task-remote-name">{{
                                          task.args['remoteName']
                                        }}</span>
                                      </div>
                                    </div>
                                    <button
                                      mat-icon-button
                                      (click)="
                                        toggleScheduledTask(task.id); $event.stopPropagation()
                                      "
                                      [matTooltip]="getToggleTooltip(task.status) | translate"
                                      class="task-toggle-btn"
                                      [disabled]="task.status === 'stopping'"
                                    >
                                      <mat-icon [svgIcon]="getToggleIcon(task.status)"></mat-icon>
                                    </button>
                                  </mat-card-header>

                                  <mat-card-footer class="task-footer">
                                    <div class="task-stats">
                                      <div class="stat-item">
                                        <mat-icon
                                          svgIcon="circle-check"
                                          class="stat-icon success"
                                        ></mat-icon>
                                        <span class="stat-value">{{ task.successCount }}</span>
                                      </div>
                                      <div class="stat-item">
                                        <mat-icon
                                          svgIcon="circle-exclamation"
                                          class="stat-icon error"
                                        ></mat-icon>
                                        <span class="stat-value">{{ task.failureCount }}</span>
                                      </div>
                                      <div class="stat-item">
                                        <mat-icon svgIcon="clock" class="stat-icon"></mat-icon>
                                        <span class="stat-value">{{ task.runCount }}</span>
                                      </div>
                                    </div>

                                    <div class="task-schedule">
                                      <div class="schedule-item">
                                        <span class="schedule-label">{{
                                          'generalOverview.tasks.nextRun' | translate
                                        }}</span>
                                        <span class="schedule-value">{{
                                          getFormattedNextRun(task)
                                        }}</span>
                                      </div>
                                      @if (task.lastRun) {
                                        <div class="schedule-item">
                                          <span class="schedule-label">{{
                                            'generalOverview.tasks.lastRun' | translate
                                          }}</span>
                                          <span class="schedule-value">{{
                                            getFormattedLastRun(task)
                                          }}</span>
                                        </div>
                                      }
                                    </div>

                                    <div class="task-cron">
                                      <mat-icon svgIcon="terminal" class="cron-icon"></mat-icon>
                                      <code class="cron-expression">{{ task.cronExpression }}</code>
                                    </div>

                                    @if (task.lastError) {
                                      <div class="task-error">
                                        <mat-icon
                                          svgIcon="circle-exclamation"
                                          class="error-icon"
                                        ></mat-icon>
                                        <span class="error-text">{{ task.lastError }}</span>
                                      </div>
                                    }
                                  </mat-card-footer>
                                </mat-card>
                              }
                            </div>
                          }
                        </div>
                      }
                    </mat-expansion-panel>
                  }
                  @case ('serves') {
                    <mat-expansion-panel
                      [expanded]="getPanelOpenState('serves')"
                      (opened)="setPanelOpenState('serves', true)"
                      (closed)="setPanelOpenState('serves', false)"
                      class="serves-panel"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <div class="panel-title-content">
                            <mat-icon
                              svgIcon="satellite-dish"
                              class="green"
                              aria-hidden="true"
                            ></mat-icon>
                            <span>{{ 'generalOverview.panels.serves' | translate }}</span>
                          </div>
                        </mat-panel-title>
                        <mat-panel-description>
                          <span
                            [ngClass]="{
                              'active-serves-indicator': allRunningServes().length > 0,
                            }"
                          >
                            {{
                              allRunningServes().length > 0
                                ? ('generalOverview.serves.activeCount'
                                  | translate
                                    : {
                                        count: allRunningServes().length,
                                        s: allRunningServes().length !== 1 ? 's' : '',
                                      })
                                : ('generalOverview.serves.noActive' | translate)
                            }}
                          </span>
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      @if (isLoadingServes()) {
                        <div class="loading fade-in" aria-live="polite">
                          <mat-spinner
                            diameter="24"
                            [attr.aria-label]="'generalOverview.serves.aria.loading' | translate"
                          ></mat-spinner>
                          <span>{{ 'generalOverview.serves.loading' | translate }}</span>
                        </div>
                      } @else {
                        @if (allRunningServes().length === 0) {
                          <div class="no-serves-message" role="status">
                            <mat-icon svgIcon="circle-info" aria-hidden="true"></mat-icon>
                            <span>{{ 'generalOverview.serves.noRunning' | translate }}</span>
                          </div>
                        } @else {
                          <div class="serves-grid">
                            @for (serve of allRunningServes(); track serve.id) {
                              <app-serve-card
                                [serve]="serve"
                                [showRemoteName]="true"
                                (stopServe)="stopServe($event)"
                                (copyToClipboard)="handleCopyToClipboard($event)"
                                (cardClick)="handleServeCardClick($event)"
                              ></app-serve-card>
                            }
                          </div>
                        }
                      }
                    </mat-expansion-panel>
                  }
                }
              </div>
            </div>
          }
        }
      </mat-accordion>
    </div>

    <div class="layout-actions">
      <button
        mat-icon-button
        (click)="toggleEditLayout()"
        matTooltipPosition="left"
        matTooltipShowDelay="500"
        [matTooltip]="
          isEditingLayout()
            ? ('generalOverview.layout.save' | translate)
            : ('generalOverview.layout.edit' | translate)
        "
      >
        <mat-icon
          [class]="isEditingLayout() ? 'primary' : ''"
          [svgIcon]="isEditingLayout() ? 'circle-check' : 'pen'"
        ></mat-icon>
      </button>

      @if (isEditingLayout()) {
        <button
          mat-icon-button
          (click)="resetLayout()"
          matTooltipPosition="left"
          matTooltipShowDelay="500"
          [matTooltip]="'generalOverview.layout.reset' | translate"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
        >
          <mat-icon class="warn" svgIcon="rotate-right"></mat-icon>
        </button>
      }
    </div>
  </div>
</div>
