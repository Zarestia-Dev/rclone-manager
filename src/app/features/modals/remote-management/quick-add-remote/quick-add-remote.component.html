<div class="quick-add-modal">
  <div class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon
        [svgIcon]="iconService.getIconName(quickAddForm.get('setup.type')?.value)"
      ></mat-icon>
    </button>
    <p>{{ 'modals.quickAdd.title' | translate }}</p>
    <button mat-icon-button (click)="close()" [attr.aria-label]="'common.close' | translate">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <form class="form-container" [formGroup]="quickAddForm" (ngSubmit)="onSubmit()" novalidate>
    <div class="modal-content custom-scrollbar">
      @switch (currentStep()) {
        @case ('setup') {
          <div class="step-content">
            <app-remote-config-step
              [form]="$any(quickAddForm.get('setup'))"
              [remoteTypes]="remoteTypes"
              [existingRemotes]="existingRemotes"
              [useInteractiveMode]="quickAddForm.get('setup.useInteractiveMode')?.value"
              [showAdvancedToggle]="false"
              (interactiveModeToggled)="onInteractiveModeToggled($event)"
            />
          </div>
        }

        @case ('operations') {
          <div formGroupName="operations" class="step-content">
            <div class="section-group">
              <div class="operations-header">
                <h3 class="section-label">{{ 'modals.quickAdd.operations.title' | translate }}</h3>
                <p class="section-description">
                  {{ 'modals.quickAdd.operations.description' | translate }}
                </p>
              </div>

              <div class="tabs-container">
                <mat-tab-group>
                  @for (tab of operationTabs; track tab.type) {
                    <mat-tab [label]="tab.label | translate">
                      <div class="operation-config">
                        <app-operation-config
                          [opFormGroup]="$any(quickAddForm.get('operations.' + tab.type))"
                          [operationType]="tab.type"
                          [currentRemoteName]="quickAddForm.get('setup.name')?.value || 'remote'"
                          [existingRemotes]="existingRemotes"
                          [description]="tab.description | translate"
                          (destFolderSelected)="selectFolder(tab.type, 'dest')"
                          (sourceFolderSelected)="selectFolder(tab.type, 'source')"
                        ></app-operation-config>
                      </div>
                    </mat-tab>
                  }
                </mat-tab-group>
              </div>
            </div>
          </div>
        }

        @case ('interactive') {
          <div class="step-content">
            @if (interactiveFlowState().isActive && interactiveFlowState().question) {
              <section class="interactive-section">
                <app-interactive-config-step
                  [question]="interactiveFlowState().question"
                  [canceling]="isAuthCancelled()"
                  [processing]="interactiveFlowState().isProcessing"
                  (answerChange)="handleInteractiveAnswerUpdate($event)"
                />
              </section>
            }
          </div>
        }
      }
    </div>

    <!-- Message Bar Area -->
    <div class="message-area" aria-live="polite">
      @if (currentStep() === 'interactive' && !isAuthCancelled()) {
        <div class="message info">
          <mat-icon svgIcon="info"></mat-icon>
          <span>{{ 'modals.quickAdd.interactive.followSteps' | translate }}</span>
        </div>
      }
      @if (isAuthCancelled()) {
        <div class="message warning">
          <mat-spinner diameter="16"></mat-spinner>
          <span>{{ 'modals.quickAdd.interactive.cancelling' | translate }}</span>
        </div>
      }
      @if (isAuthInProgress() && !isAuthCancelled() && currentStep() !== 'interactive') {
        <div class="message info">
          <mat-icon svgIcon="globe"></mat-icon>
          <span>{{ 'modals.quickAdd.interactive.browserOpen' | translate }}</span>
        </div>
      }
    </div>

    <div class="modal-actions">
      @if (currentStep() === 'setup') {
        <button mat-button type="button" (click)="close()">
          {{ 'common.cancel' | translate }}
        </button>
        <button
          mat-flat-button
          class="primary"
          (click)="nextStep()"
          [disabled]="!isSetupStepValid()"
          type="button"
        >
          {{ 'common.nextStep' | translate }}
          <mat-icon iconPositionEnd svgIcon="right-arrow"></mat-icon>
        </button>
      }

      @if (currentStep() === 'operations') {
        <button mat-button type="button" (click)="prevStep()" [disabled]="isAuthInProgress()">
          <mat-icon iconPositionStart svgIcon="left-arrow"></mat-icon>
          {{ 'common.back' | translate }}
        </button>

        @if (isAuthInProgress() && !isAuthCancelled()) {
          <button mat-button class="warn" type="button" (click)="cancelAuth()">
            {{ 'common.cancel' | translate }}
          </button>
        }

        <button
          mat-flat-button
          class="primary"
          (click)="onSubmit()"
          [disabled]="isAuthInProgress() || quickAddForm.invalid"
          type="submit"
        >
          @if (isAuthInProgress() && !isAuthCancelled()) {
            <mat-spinner diameter="18" class="button-spinner"></mat-spinner>
          } @else {
            <mat-icon iconPositionEnd svgIcon="plus"></mat-icon>
          }
          {{ submitButtonText() | translate }}
        </button>
      }

      @if (currentStep() === 'interactive') {
        <button mat-button class="warn" type="button" (click)="cancelAuth()">
          {{ 'common.cancel' | translate }}
        </button>

        <button
          mat-flat-button
          class="primary"
          type="button"
          (click)="onInteractiveContinue(interactiveFlowState().answer)"
          [disabled]="isInteractiveContinueDisabled()"
        >
          @if (interactiveFlowState().isProcessing) {
            <mat-spinner diameter="18" class="button-spinner"></mat-spinner>
          }
          {{
            (interactiveFlowState().isProcessing
              ? 'modals.quickAdd.buttons.processing'
              : 'common.continue'
            ) | translate
          }}
        </button>
      }
    </div>
  </form>
</div>
