<div class="modal-container">
  <!-- Modal Header -->
  <header class="modal-header" data-tauri-drag-region>
    <button
      mat-icon-button
      (click)="toggleSearchVisibility()"
      [matTooltip]="'shared.search.toggle' | translate"
      [attr.aria-label]="'shared.search.toggle' | translate"
      [disabled]="interactiveFlowState().isActive"
      type="button"
    >
      <mat-icon svgIcon="search"></mat-icon>
    </button>
    <p data-tauri-drag-region>
      {{
        editTarget()
          ? ('modals.remoteConfig.title.edit' | translate: { target: editTarget() | titlecase })
          : ('modals.remoteConfig.title.add' | translate)
      }}
    </p>
    <button
      matIconButton
      (click)="close()"
      [attr.aria-label]="'common.close' | translate"
      [attr.title]="'common.close' | translate"
    >
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </header>

  <!-- Search Container -->
  <app-search-container
    [visible]="isSearchVisible()"
    [searchText]="searchQuery()"
    (searchTextChange)="onSearchInput($event)"
    [placeholder]="'shared.search.placeholder'"
    [ariaLabel]="'shared.search.ariaLabel'"
  ></app-search-container>

  <!-- Step Progress Indicator (Only shown during multi-step create flow) -->
  @if (!interactiveFlowState().isActive && !editTarget()) {
    <div class="step-indicator-container">
      <div
        class="step-indicator hide-scrollbar"
        role="tablist"
        [attr.aria-label]="'modals.remoteConfig.aria.stepIndicator' | translate"
      >
        @for (step of stepLabels; track step; let i = $index) {
          <button
            class="step"
            [ngClass]="getStepState(i + 1)"
            [class.clickable]="editTarget()"
            (click)="goToStep(i + 1)"
            [attr.tabindex]="editTarget() ? '0' : '-1'"
            role="tab"
            [disabled]="isAuthInProgress() || !remoteForm.valid"
            [attr.aria-selected]="currentStep() === i + 1"
          >
            <div class="step-number">
              @if (getStepState(i + 1) === 'completed') {
                <mat-icon svgIcon="circle-check"></mat-icon>
              } @else {
                <mat-icon [svgIcon]="stepIcons()[i]"></mat-icon>
              }
            </div>
            @if (getStepState(i + 1) === 'current') {
              <span class="step-label-animated">{{ step | translate }}</span>
            }
          </button>
        }
      </div>
    </div>
  }

  <!-- Modal Content -->
  <main class="modal-content">
    <!-- Interactive Configuration Flow -->
    @if (interactiveFlowState().isActive && interactiveFlowState().question) {
      <section class="step-container interactive" aria-live="polite" aria-busy="true">
        <app-interactive-config-step
          [question]="interactiveFlowState().question"
          [canceling]="isAuthCancelled()"
          [processing]="interactiveFlowState().isProcessing"
          (answerChange)="handleInteractiveAnswerUpdate($event)"
        />
      </section>
    }

    <!-- Non-Interactive Configuration Flow -->
    @if (!interactiveFlowState().isActive) {
      <!-- Step 1: Remote Configuration -->
      @if (currentStep() === 1) {
        <section class="step-container">
          <app-remote-config-step
            class="step"
            [form]="remoteForm"
            [remoteFields]="dynamicRemoteFields"
            [remoteTypes]="remoteTypes()"
            [isLoading]="isRemoteConfigLoading()"
            [existingRemotes]="existingRemotes()"
            [isTypeLocked]="!!editTarget() || cloneTarget()"
            [useInteractiveMode]="useInteractiveMode()"
            [searchQuery]="searchQuery()"
            (remoteTypeChanged)="onRemoteTypeChange()"
            (interactiveModeToggled)="onInteractiveModeToggled($event)"
            (fieldChanged)="onRemoteFieldChanged($event.fieldName, $event.isChanged)"
          />
        </section>
      }

      <!-- Shared Profile Template -->
      <ng-template #profileHeader let-flagType="type">
        <div class="profile-header">
          @if (getProfileState(flagType).mode === 'view') {
            <mat-form-field subscriptSizing="dynamic" class="profile-select">
              <mat-label>{{ 'modals.remoteConfig.profile.label' | translate }}</mat-label>
              <mat-select
                [value]="getSelectedProfile($any(flagType))"
                (selectionChange)="selectProfile($any(flagType), $event.value)"
              >
                @for (profile of getProfiles($any(flagType)); track profile.name) {
                  <mat-option [value]="profile.name">{{ profile.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <div class="profile-actions">
              <button
                mat-icon-button
                (click)="startAddProfile($any(flagType))"
                [attr.title]="'modals.remoteConfig.profile.add' | translate"
              >
                <mat-icon svgIcon="plus"></mat-icon>
              </button>
              <button
                mat-icon-button
                (click)="startEditProfile($any(flagType))"
                [attr.title]="'modals.remoteConfig.profile.rename' | translate"
                [disabled]="getSelectedProfile($any(flagType)).toLowerCase() === 'default'"
              >
                <mat-icon svgIcon="pen"></mat-icon>
              </button>
              <button
                mat-icon-button
                class="warn"
                (click)="deleteProfile($any(flagType), getSelectedProfile($any(flagType)))"
                [attr.title]="'modals.remoteConfig.profile.delete' | translate"
                [disabled]="
                  getProfiles($any(flagType)).length <= 1 ||
                  getSelectedProfile($any(flagType)).toLowerCase() === 'default'
                "
              >
                <mat-icon svgIcon="trash"></mat-icon>
              </button>
            </div>
          } @else {
            <!-- Edit/Add Mode -->
            <mat-form-field subscriptSizing="dynamic" class="profile-input">
              <mat-label>{{
                (getProfileState(flagType).mode === 'add'
                  ? 'modals.remoteConfig.profile.new'
                  : 'modals.remoteConfig.profile.rename'
                ) | translate
              }}</mat-label>
              <input
                matInput
                [ngModel]="getProfileState(flagType).tempName"
                (ngModelChange)="setProfileTempName(flagType, $event)"
                [ngModelOptions]="{ standalone: true }"
                (keyup.enter)="saveProfile($any(flagType))"
                (keyup.escape)="cancelProfileEdit($any(flagType))"
                autoFocus
              />
            </mat-form-field>

            <div class="profile-actions">
              <button
                mat-icon-button
                class="primary"
                (click)="saveProfile($any(flagType))"
                [attr.title]="'modals.remoteConfig.profile.save' | translate"
              >
                <mat-icon svgIcon="circle-check"></mat-icon>
              </button>
              <button
                mat-icon-button
                class="warn"
                (click)="cancelProfileEdit($any(flagType))"
                [attr.title]="'modals.remoteConfig.profile.cancel' | translate"
              >
                <mat-icon svgIcon="circle-xmark"></mat-icon>
              </button>
            </div>
          }
        </div>
      </ng-template>

      <!-- Linked Profiles Template (Collapsible) -->
      <ng-template #linkedProfiles let-configPath="configPath" let-showVfs="showVfs">
        <mat-expansion-panel class="linked-profiles-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon svgIcon="gear" class="panel-icon"></mat-icon>
              <span>{{ 'modals.remoteConfig.advancedProfiles.title' | translate }}</span>
            </mat-panel-title>
            <mat-panel-description>
              <span class="profile-count">{{
                'modals.remoteConfig.advancedProfiles.linked'
                  | translate: { count: showVfs ? '3' : '2' }
              }}</span>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="linked-profiles-content">
            @if (showVfs) {
              <mat-form-field subscriptSizing="dynamic">
                <mat-label>{{ 'modals.remoteConfig.advancedProfiles.vfs' | translate }}</mat-label>
                <mat-select
                  [formControl]="$any(remoteConfigForm.get(configPath)?.get('vfsProfile'))"
                >
                  @for (opt of getProfileOptions('vfs'); track opt) {
                    <mat-option [value]="opt">{{ opt }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            }

            <mat-form-field subscriptSizing="dynamic">
              <mat-label>{{ 'modals.remoteConfig.advancedProfiles.filter' | translate }}</mat-label>
              <mat-select
                [formControl]="$any(remoteConfigForm.get(configPath)?.get('filterProfile'))"
              >
                @for (opt of getProfileOptions('filter'); track opt) {
                  <mat-option [value]="opt">{{ opt }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field subscriptSizing="dynamic">
              <mat-label>{{
                'modals.remoteConfig.advancedProfiles.backend' | translate
              }}</mat-label>
              <mat-select
                [formControl]="$any(remoteConfigForm.get(configPath)?.get('backendProfile'))"
              >
                @for (opt of getProfileOptions('backend'); track opt) {
                  <mat-option [value]="opt">{{ opt }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </mat-expansion-panel>
      </ng-template>

      <!-- Flags and Serve Steps -->
      <!-- Step mapping: index + 2 (Remote is step 1, then FLAG_TYPES start at step 2) -->
      @for (flagType of FLAG_TYPES; track flagType; let i = $index) {
        @if (currentStep() === i + 2) {
          <section class="step-container">
            <!-- Profile Management Header -->
            <ng-container
              *ngTemplateOutlet="profileHeader; context: { type: flagType }"
            ></ng-container>

            <!-- Linked Profiles for Operations (Mount, Serve, Sync, Copy, Move, Bisync) -->
            @if (['mount', 'serve', 'sync', 'copy', 'move', 'bisync'].includes(flagType)) {
              <ng-container
                *ngTemplateOutlet="
                  linkedProfiles;
                  context: {
                    configPath: flagType + 'Config',
                    showVfs: flagType === 'mount' || flagType === 'serve',
                  }
                "
              ></ng-container>
            }

            <app-flag-config-step
              class="step"
              [form]="remoteConfigForm"
              [flagType]="flagType"
              [existingRemotes]="existingRemotes()"
              [dynamicFlagFields]="
                flagType === 'serve' ? dynamicServeFields : dynamicFlagFields[flagType]
              "
              [mountTypes]="mountTypes()"
              [currentRemoteName]="getRemoteName()"
              [isNewRemote]="!editTarget()"
              [getControlKey]="getUniqueControlKey.bind(this)"
              [availableServeTypes]="availableServeTypes()"
              [selectedServeType]="selectedServeType()"
              [isLoadingServeFields]="isLoadingServeFields()"
              [searchQuery]="searchQuery()"
              (sourceFolderSelected)="handleSourceFolderSelect(flagType)"
              (destFolderSelected)="handleDestFolderSelect(flagType)"
              (serveTypeChange)="onServeTypeChange($event)"
            />
          </section>
        }
      }
    }
  </main>

  <!-- Footer Buttons -->
  <footer class="button-container">
    <!-- Left Side: Back Button -->
    <div class="button-container-inner">
      @if (currentStep() > 1 && !editTarget() && !interactiveFlowState().isActive) {
        <button
          matButton="filled"
          class="accent"
          [disabled]="isAuthInProgress()"
          (click)="prevStep()"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          [attr.title]="'modals.remoteConfig.buttons.back' | translate"
          [attr.aria-label]="'modals.remoteConfig.buttons.back' | translate"
        >
          <mat-icon svgIcon="left-arrow"></mat-icon>
          {{ 'modals.remoteConfig.buttons.back' | translate }}
        </button>
      }
    </div>

    <!-- Center/Right Side: Action Buttons -->
    <div class="button-container-inner">
      <!-- Cancel Button (During Auth or Interactive Flow) -->
      @if ((isAuthInProgress() && !isAuthCancelled()) || interactiveFlowState().isActive) {
        <button
          matButton="filled"
          class="warn"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          (click)="cancelAuth()"
          [disabled]="
            (!isAuthInProgress() && !interactiveFlowState().isActive) || isAuthCancelled()
          "
          [attr.title]="'modals.remoteConfig.buttons.cancel' | translate"
          [attr.aria-label]="'modals.remoteConfig.buttons.cancel' | translate"
        >
          {{ 'modals.remoteConfig.buttons.cancel' | translate }}
        </button>
      }

      <!-- Cleanup Status (Shows when auth is cancelled) -->
      @if (isAuthCancelled()) {
        <span class="cleanup-status" aria-live="polite">
          {{ 'modals.remoteConfig.buttons.cleanup' | translate }}
          <mat-spinner diameter="16" aria-hidden="true"></mat-spinner>
        </span>
      }

      <!-- Save Button (Shown on step > 1 in create mode, or in edit mode) -->
      @if (
        ((currentStep() > 1 && !editTarget()) || editTarget()) && !interactiveFlowState().isActive
      ) {
        <button
          matButton="filled"
          (click)="onSubmit()"
          [disabled]="isSaveDisabled()"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          aria-live="polite"
          [attr.aria-label]="
            editTarget()
              ? ('modals.remoteConfig.buttons.saveChanges' | translate)
              : ('modals.remoteConfig.buttons.saveConfig' | translate)
          "
          [attr.title]="
            editTarget()
              ? ('modals.remoteConfig.buttons.saveChanges' | translate)
              : ('modals.remoteConfig.buttons.saveConfig' | translate)
          "
        >
          <!-- Loading State -->
          @if (isAuthInProgress() && !isAuthCancelled()) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }

          <!-- Button Label -->
          <span>{{ saveButtonLabel() | translate }}</span>
        </button>
      }

      @if (interactiveFlowState().isActive) {
        <button
          matButton="filled"
          (click)="onInteractiveContinue(interactiveFlowState().answer)"
          [disabled]="isInteractiveContinueDisabled()"
          class="continue-button"
          [class.loading]="interactiveFlowState().isProcessing || isAuthCancelled()"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          aria-live="polite"
          [attr.aria-label]="
            (interactiveFlowState().isProcessing
              ? 'modals.remoteConfig.buttons.processing'
              : 'modals.remoteConfig.buttons.continue'
            ) | translate
          "
          [attr.title]="
            (interactiveFlowState().isProcessing
              ? 'modals.remoteConfig.buttons.processing'
              : 'modals.remoteConfig.buttons.continue'
            ) | translate
          "
        >
          @if (interactiveFlowState().isProcessing && !isAuthCancelled()) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }
          <span>{{
            (interactiveFlowState().isProcessing
              ? 'modals.remoteConfig.buttons.processing'
              : 'modals.remoteConfig.buttons.continue'
            ) | translate
          }}</span>
        </button>
      }

      <!-- Next Button (Shown in create mode when not on last step) -->
      @if (
        currentStep() < currentTotalSteps() && !editTarget() && !interactiveFlowState().isActive
      ) {
        <button
          matButton="filled"
          class="accent"
          (click)="nextStep()"
          [disabled]="!remoteForm.valid || isAuthInProgress()"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          [attr.title]="'modals.remoteConfig.buttons.next' | translate"
          [attr.aria-label]="'modals.remoteConfig.buttons.next' | translate"
        >
          {{ 'modals.remoteConfig.buttons.next' | translate }}
          <mat-icon svgIcon="right-arrow"></mat-icon>
        </button>
      }
    </div>
  </footer>
</div>
