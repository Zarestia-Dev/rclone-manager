<div class="modal-container">
  <!-- Modal Header -->
  <header class="modal-header" data-tauri-drag-region>
    <button matIconButton aria-label="Help" title="Help">
      <mat-icon svgIcon="question"></mat-icon>
    </button>
    <p data-tauri-drag-region>
      <mat-icon svgIcon="hard-drive" aria-hidden="true"></mat-icon>
      <span>
        {{ editTarget ? 'Edit ' + (editTarget | titlecase) + ' Settings' : 'Add New Remote' }}
      </span>
    </p>
    <button matIconButton (click)="close()" aria-label="Close dialog" title="Close">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </header>

  <!-- Step Progress Indicator (Only shown during multi-step create flow) -->
  @if (!interactiveFlowState.isActive && !editTarget) {
    <div class="step-indicator-container">
      <div class="step-indicator hide-scrollbar" role="tablist" aria-label="Configuration Steps">
        @for (step of stepLabels; track step; let i = $index) {
          <button
            class="step"
            [ngClass]="getStepState(i + 1)"
            [class.clickable]="editTarget"
            (click)="goToStep(i + 1)"
            (keydown)="handleStepKeydown($event, i + 1)"
            [attr.tabindex]="editTarget ? '0' : '-1'"
            role="tab"
            [disabled]="!remoteForm.valid || isAuthInProgress"
            [attr.aria-selected]="currentStep === i + 1"
            [attr.aria-label]="getStepProgressAriaLabel()"
          >
            <div class="step-number">
              @if (getStepState(i + 1) === 'completed') {
                <mat-icon svgIcon="circle-check"></mat-icon>
              } @else {
                <mat-icon [svgIcon]="getStepIcon(i)"></mat-icon>
              }
            </div>
            @if (getStepState(i + 1) === 'current') {
              <span class="step-label-animated" @labelSlideIn>{{ step }}</span>
            }
          </button>
        }
      </div>
    </div>
  }

  <!-- Modal Content -->
  <main class="modal-content" [@slideAnimation]="currentStep">
    <!-- Interactive Configuration Flow -->
    @if (interactiveFlowState.isActive && interactiveFlowState.question) {
      <section class="step-container" aria-live="polite" aria-busy="true">
        <app-interactive-config-step
          [question]="interactiveFlowState.question"
          [canceling]="isAuthCancelled"
          [processing]="interactiveFlowState.isProcessing"
          (continue)="onInteractiveContinue($event)"
        />
      </section>
    }

    <!-- Non-Interactive Configuration Flow -->
    @if (!interactiveFlowState.isActive) {
      <!-- Step 1: Remote Configuration -->
      @if (editTarget === 'remote' || (!editTarget && currentStep === 1)) {
        <section class="step-container">
          <app-remote-config-step
            [form]="remoteForm"
            [remoteFields]="dynamicRemoteFields"
            [remoteTypes]="remoteTypes"
            [isLoading]="isRemoteConfigLoading"
            [existingRemotes]="existingRemotes"
            [restrictMode]="restrictMode"
            [useInteractiveMode]="useInteractiveMode"
            (remoteTypeChanged)="onRemoteTypeChange()"
            (interactiveModeToggled)="onInteractiveModeToggled($event)"
          />
        </section>
      }

      <!-- Steps 2-9: Flag Configurations (Mount, Copy, Sync, etc.) -->
      @for (flagType of flagConfigService.FLAG_TYPES; track flagType; let i = $index) {
        @if (editTarget === flagType || (!editTarget && currentStep === i + 2)) {
          <section class="step-container">
            <app-flag-config-step
              [form]="remoteConfigForm"
              [flagType]="flagType"
              [isEditMode]="!!editTarget"
              [existingRemotes]="existingRemotes"
              [sourceLoading]="pathSelectionService.getLoadingState(flagType + 'Config.source')"
              [destLoading]="pathSelectionService.getLoadingState(flagType + 'Config.dest')"
              [dynamicFlagFields]="dynamicFlagFields[flagType]"
              [mountTypes]="mountTypes"
              (sourceRemoteSelected)="onRemoteSelectedField($event, flagType + 'Config.source')"
              (destRemoteSelected)="onRemoteSelectedField($event, flagType + 'Config.dest')"
              (sourceOptionSelected)="
                onSourceOptionSelectedField($event, flagType + 'Config.source')
              "
              (destOptionSelected)="onDestOptionSelectedField($event, flagType + 'Config.dest')"
              (folderSelected)="selectLocalFolder($event.formPath, $event.requiredEmpty)"
              (remoteSelectionReset)="resetRemoteSelectionField($event)"
            />
          </section>
        }
      }
    }
  </main>

  <!-- Footer Buttons -->
  <footer class="button-container">
    <!-- Left Side: Back Button -->
    <div class="button-container-inner">
      @if (currentStep > 1 && !editTarget && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="accent"
          [disabled]="isAuthInProgress"
          (click)="prevStep()"
          @fadeInOut
          title="Go to previous step"
          aria-label="Previous step"
        >
          <mat-icon svgIcon="left-arrow"></mat-icon>
          Back
        </button>
      }
    </div>

    <!-- Center/Right Side: Action Buttons -->
    <div class="button-container-inner">
      <!-- Cancel Button (During Auth or Interactive Flow) -->
      @if ((isAuthInProgress && !isAuthCancelled) || interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="warn"
          @fadeInOut
          (click)="cancelAuth()"
          [disabled]="(!isAuthInProgress && !interactiveFlowState.isActive) || isAuthCancelled"
          title="Cancel the current operation"
          aria-label="Cancel current operation"
        >
          Cancel
        </button>
      }

      <!-- Cleanup Status (Shows when auth is cancelled) -->
      @if (isAuthCancelled) {
        <span class="cleanup-status" aria-live="polite">
          Cleaning up
          <mat-spinner diameter="16" aria-hidden="true"></mat-spinner>
        </span>
      }

      <!-- Save Button (Shown on step > 1 in create mode, or in edit mode) -->
      @if (((currentStep > 1 && !editTarget) || editTarget) && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          (click)="onSubmit()"
          [disabled]="isSaveDisabled"
          @fadeInOut
          aria-live="polite"
          [attr.aria-label]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
          [title]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
        >
          <!-- Loading State -->
          @if (isAuthInProgress && !isAuthCancelled) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }

          <!-- Button Label -->
          <span>{{ saveButtonLabel }}</span>
        </button>
      }

      <!-- Next Button (Shown in create mode when not on last step) -->
      @if (currentStep < TOTAL_STEPS && !editTarget && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="accent"
          (click)="nextStep()"
          [disabled]="!remoteForm.valid || isAuthInProgress"
          @fadeInOut
          title="Go to next step"
          aria-label="Next step"
        >
          Next
          <mat-icon svgIcon="right-arrow"></mat-icon>
        </button>
      }
    </div>
  </footer>
</div>
