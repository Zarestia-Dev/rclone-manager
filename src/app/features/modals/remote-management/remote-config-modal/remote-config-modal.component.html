<div class="modal-container">
  <!-- Modal Header -->
  <header class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon [svgIcon]="iconService.getIconName(remoteForm.get('type')?.value)"></mat-icon>
    </button>
    <p data-tauri-drag-region>
      {{ editTarget ? 'Edit ' + (editTarget | titlecase) + ' Settings' : 'Add New Remote' }}
    </p>
    <button matIconButton (click)="close()" aria-label="Close dialog" title="Close">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </header>

  <!-- Step Progress Indicator (Only shown during multi-step create flow) -->
  @if (!interactiveFlowState.isActive && !editTarget) {
    <div class="step-indicator-container">
      <div class="step-indicator hide-scrollbar" role="tablist" aria-label="Configuration Steps">
        @for (step of stepLabels; track step; let i = $index) {
          <button
            class="step"
            [ngClass]="getStepState(i + 1)"
            [class.clickable]="editTarget"
            (click)="goToStep(i + 1)"
            [attr.tabindex]="editTarget ? '0' : '-1'"
            role="tab"
            [disabled]="isAuthInProgress || !remoteForm.valid"
            [attr.aria-selected]="currentStep === i + 1"
          >
            <div class="step-number">
              @if (getStepState(i + 1) === 'completed') {
                <mat-icon svgIcon="circle-check"></mat-icon>
              } @else {
                <mat-icon [svgIcon]="stepIcons[i]"></mat-icon>
              }
            </div>
            @if (getStepState(i + 1) === 'current') {
              <span
                class="step-label-animated"
                animate.enter="label-slide-in-enter"
                animate.leave="label-slide-in-leave"
                >{{ step }}</span
              >
            }
          </button>
        }
      </div>
    </div>
  }

  <!-- Modal Content -->
  <main class="modal-content">
    <!-- Interactive Configuration Flow -->
    @if (interactiveFlowState.isActive && interactiveFlowState.question) {
      <section class="step-container interactive" aria-live="polite" aria-busy="true">
        <app-interactive-config-step
          [question]="interactiveFlowState.question"
          [canceling]="isAuthCancelled"
          [processing]="interactiveFlowState.isProcessing"
          (answerChange)="handleInteractiveAnswerUpdate($event)"
        />
      </section>
    }

    <!-- Non-Interactive Configuration Flow -->
    @if (!interactiveFlowState.isActive) {
      <!-- Step 1: Remote Configuration -->
      @if (currentStep === 1) {
        <section class="step-container">
          <app-remote-config-step
            class="step"
            [form]="remoteForm"
            [remoteFields]="dynamicRemoteFields"
            [remoteTypes]="remoteTypes"
            [isLoading]="isRemoteConfigLoading"
            [existingRemotes]="existingRemotes"
            [restrictMode]="restrictMode"
            [useInteractiveMode]="useInteractiveMode"
            (remoteTypeChanged)="onRemoteTypeChange()"
            (interactiveModeToggled)="onInteractiveModeToggled($event)"
            (fieldChanged)="onRemoteFieldChanged($event.fieldName, $event.isChanged)"
          />
        </section>
      }

      <!-- Shared Profile Template -->
      <ng-template #profileHeader let-flagType="type">
        <div class="profile-header">
          @if (getProfileState(flagType).mode === 'view') {
            <mat-form-field subscriptSizing="dynamic" class="profile-select">
              <mat-label>Profile</mat-label>
              <mat-select
                [value]="getSelectedProfile($any(flagType))"
                (selectionChange)="selectProfile($any(flagType), $event.value)"
              >
                @for (profile of getProfiles($any(flagType)); track profile.name) {
                  <mat-option [value]="profile.name">{{ profile.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <div class="profile-actions">
              <button mat-icon-button (click)="startAddProfile($any(flagType))" title="Add Profile">
                <mat-icon svgIcon="plus"></mat-icon>
              </button>
              <button
                mat-icon-button
                (click)="startEditProfile($any(flagType))"
                title="Rename Profile"
                [disabled]="getSelectedProfile($any(flagType)).toLowerCase() === 'default'"
              >
                <mat-icon svgIcon="pen"></mat-icon>
              </button>
              <button
                mat-icon-button
                class="warn"
                (click)="deleteProfile($any(flagType), getSelectedProfile($any(flagType)))"
                title="Delete Profile"
                [disabled]="
                  getProfiles($any(flagType)).length <= 1 ||
                  getSelectedProfile($any(flagType)).toLowerCase() === 'default'
                "
              >
                <mat-icon svgIcon="trash"></mat-icon>
              </button>
            </div>
          } @else {
            <!-- Edit/Add Mode -->
            <mat-form-field subscriptSizing="dynamic" class="profile-input">
              <mat-label>{{
                getProfileState(flagType).mode === 'add' ? 'New Profile Name' : 'Rename Profile'
              }}</mat-label>
              <input
                matInput
                [(ngModel)]="getProfileState(flagType).tempName"
                [ngModelOptions]="{ standalone: true }"
                (keyup.enter)="saveProfile($any(flagType))"
                (keyup.escape)="cancelProfileEdit($any(flagType))"
                autoFocus
              />
            </mat-form-field>

            <div class="profile-actions">
              <button
                mat-icon-button
                class="primary"
                (click)="saveProfile($any(flagType))"
                title="Save"
              >
                <mat-icon svgIcon="circle-check"></mat-icon>
              </button>
              <button
                mat-icon-button
                class="warn"
                (click)="cancelProfileEdit($any(flagType))"
                title="Cancel"
              >
                <mat-icon svgIcon="circle-xmark"></mat-icon>
              </button>
            </div>
          }
        </div>
      </ng-template>

      <!-- Linked Profiles Template (Collapsible) -->
      <ng-template #linkedProfiles let-configPath="configPath" let-showVfs="showVfs">
        <mat-expansion-panel class="linked-profiles-panel">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon svgIcon="gear" class="panel-icon"></mat-icon>
              <span>Advanced Profiles</span>
            </mat-panel-title>
            <mat-panel-description>
              <span class="profile-count">{{ showVfs ? '3' : '2' }} linked</span>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="linked-profiles-content">
            @if (showVfs) {
              <mat-form-field subscriptSizing="dynamic">
                <mat-label>VFS Profile</mat-label>
                <mat-select
                  [formControl]="$any(remoteConfigForm.get(configPath)?.get('vfsProfile'))"
                >
                  @for (opt of getProfileOptions('vfs'); track opt) {
                    <mat-option [value]="opt">{{ opt }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            }

            <mat-form-field subscriptSizing="dynamic">
              <mat-label>Filter Profile</mat-label>
              <mat-select
                [formControl]="$any(remoteConfigForm.get(configPath)?.get('filterProfile'))"
              >
                @for (opt of getProfileOptions('filter'); track opt) {
                  <mat-option [value]="opt">{{ opt }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field subscriptSizing="dynamic">
              <mat-label>Backend Profile</mat-label>
              <mat-select
                [formControl]="$any(remoteConfigForm.get(configPath)?.get('backendProfile'))"
              >
                @for (opt of getProfileOptions('backend'); track opt) {
                  <mat-option [value]="opt">{{ opt }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </mat-expansion-panel>
      </ng-template>

      <!-- Flags and Serve Steps -->
      <!-- Step mapping: index + 2 (Remote is step 1, then FLAG_TYPES start at step 2) -->
      @for (flagType of FLAG_TYPES; track flagType; let i = $index) {
        @if (currentStep === i + 2) {
          <section class="step-container">
            <!-- Profile Management Header -->
            <ng-container
              *ngTemplateOutlet="profileHeader; context: { type: flagType }"
            ></ng-container>

            <!-- Linked Profiles for Operations (Mount, Serve, Sync, Copy, Move, Bisync) -->
            @if (['mount', 'serve', 'sync', 'copy', 'move', 'bisync'].includes(flagType)) {
              <ng-container
                *ngTemplateOutlet="
                  linkedProfiles;
                  context: {
                    configPath: flagType + 'Config',
                    showVfs: flagType === 'mount' || flagType === 'serve',
                  }
                "
              ></ng-container>
            }

            <app-flag-config-step
              class="step"
              [form]="remoteConfigForm"
              [flagType]="flagType"
              [isEditMode]="!!editTarget"
              [existingRemotes]="existingRemotes"
              [dynamicFlagFields]="
                flagType === 'serve' ? dynamicServeFields : dynamicFlagFields[flagType]
              "
              [mountTypes]="mountTypes"
              [currentRemoteName]="getRemoteName()"
              [isNewRemote]="!editTarget"
              [getControlKey]="getUniqueControlKey.bind(this)"
              [availableServeTypes]="availableServeTypes"
              [selectedServeType]="selectedServeType"
              [isLoadingServeFields]="isLoadingServeFields"
              (sourceFolderSelected)="handleSourceFolderSelect(flagType)"
              (destFolderSelected)="handleDestFolderSelect(flagType)"
              (serveTypeChange)="onServeTypeChange($event)"
            />
          </section>
        }
      }
    }
  </main>

  <!-- Footer Buttons -->
  <footer class="button-container">
    <!-- Left Side: Back Button -->
    <div class="button-container-inner">
      @if (currentStep > 1 && !editTarget && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="accent"
          [disabled]="isAuthInProgress"
          (click)="prevStep()"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          title="Go to previous step"
          aria-label="Previous step"
        >
          <mat-icon svgIcon="left-arrow"></mat-icon>
          Back
        </button>
      }
    </div>

    <!-- Center/Right Side: Action Buttons -->
    <div class="button-container-inner">
      <!-- Cancel Button (During Auth or Interactive Flow) -->
      @if ((isAuthInProgress && !isAuthCancelled) || interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="warn"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          (click)="cancelAuth()"
          [disabled]="(!isAuthInProgress && !interactiveFlowState.isActive) || isAuthCancelled"
          title="Cancel the current operation"
          aria-label="Cancel current operation"
        >
          Cancel
        </button>
      }

      <!-- Cleanup Status (Shows when auth is cancelled) -->
      @if (isAuthCancelled) {
        <span class="cleanup-status" aria-live="polite">
          Cleaning up
          <mat-spinner diameter="16" aria-hidden="true"></mat-spinner>
        </span>
      }

      <!-- Save Button (Shown on step > 1 in create mode, or in edit mode) -->
      @if (((currentStep > 1 && !editTarget) || editTarget) && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          (click)="onSubmit()"
          [disabled]="isSaveDisabled"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          aria-live="polite"
          [attr.aria-label]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
          [title]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
        >
          <!-- Loading State -->
          @if (isAuthInProgress && !isAuthCancelled) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }

          <!-- Button Label -->
          <span>{{ saveButtonLabel }}</span>
        </button>
      }

      @if (interactiveFlowState.isActive) {
        <button
          matButton="filled"
          (click)="onInteractiveContinue(interactiveFlowState.answer)"
          [disabled]="isInteractiveContinueDisabled()"
          class="continue-button"
          [class.loading]="interactiveFlowState.isProcessing || isAuthCancelled"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          aria-live="polite"
          [attr.aria-label]="
            interactiveFlowState.isProcessing ? 'Processing...' : 'Continue to next step'
          "
          [title]="interactiveFlowState.isProcessing ? 'Processing...' : 'Continue to next step'"
        >
          @if (interactiveFlowState.isProcessing && !isAuthCancelled) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }
          <span>{{ interactiveFlowState.isProcessing ? 'Processing...' : 'Continue' }}</span>
        </button>
      }

      <!-- Next Button (Shown in create mode when not on last step) -->
      @if (currentStep < currentTotalSteps && !editTarget && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="accent"
          (click)="nextStep()"
          [disabled]="!remoteForm.valid || isAuthInProgress"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          title="Go to next step"
          aria-label="Next step"
        >
          Next
          <mat-icon svgIcon="right-arrow"></mat-icon>
        </button>
      }
    </div>
  </footer>
</div>
