<div class="modal-container">
  <!-- Modal Header -->
  <header class="modal-header" data-tauri-drag-region>
    <button matIconButton aria-label="Help" title="Help">
      <mat-icon svgIcon="question"></mat-icon>
    </button>
    <p data-tauri-drag-region>
      <mat-icon svgIcon="hard-drive" aria-hidden="true"></mat-icon>
      <span>
        {{ editTarget ? 'Edit ' + (editTarget | titlecase) + ' Settings' : 'Add New Remote' }}
      </span>
    </p>
    <button matIconButton (click)="close()" aria-label="Close dialog" title="Close">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </header>

  <!-- Step Progress Indicator (Only shown during multi-step create flow) -->
  @if (!interactiveFlowState.isActive && (!editTarget || isServeMode)) {
    <div class="step-indicator-container">
      <div class="step-indicator hide-scrollbar" role="tablist" aria-label="Configuration Steps">
        @for (step of currentStepLabels; track step; let i = $index) {
          <button
            class="step"
            [ngClass]="getStepState(i + 1)"
            [class.clickable]="editTarget"
            (click)="goToStep(i + 1)"
            (keydown)="handleStepKeydown($event, i + 1)"
            [attr.tabindex]="editTarget ? '0' : '-1'"
            role="tab"
            [disabled]="isAuthInProgress || (isServeMode ? false : !remoteForm.valid)"
            [attr.aria-selected]="currentStep === i + 1"
          >
            <div class="step-number">
              @if (getStepState(i + 1) === 'completed') {
                <mat-icon svgIcon="circle-check"></mat-icon>
              } @else {
                <mat-icon [svgIcon]="getStepIcon(i)"></mat-icon>
              }
            </div>
            @if (getStepState(i + 1) === 'current') {
              <span class="step-label-animated" [@labelSlideIn]>{{ step }}</span>
            }
          </button>
        }
      </div>
    </div>
  }

  <!-- Modal Content -->
  <main class="modal-content" [@slideAnimation]="currentStep">
    <!-- Interactive Configuration Flow -->
    @if (interactiveFlowState.isActive && interactiveFlowState.question) {
      <section class="step-container interactive" aria-live="polite" aria-busy="true">
        <app-interactive-config-step
          [question]="interactiveFlowState.question"
          [canceling]="isAuthCancelled"
          [processing]="interactiveFlowState.isProcessing"
          (answerChange)="handleInteractiveAnswerUpdate($event)"
        />
      </section>
    }

    <!-- Non-Interactive Configuration Flow -->
    @if (!interactiveFlowState.isActive) {
      <!-- Step 1: Remote Configuration or Serve Configuration -->
      @if (editTarget === 'remote' || (!editTarget && currentStep === 1 && !isServeMode)) {
        <section class="step-container">
          <app-remote-config-step
            class="step"
            [form]="remoteForm"
            [remoteFields]="dynamicRemoteFields"
            [remoteTypes]="remoteTypes"
            [isLoading]="isRemoteConfigLoading"
            [existingRemotes]="existingRemotes"
            [restrictMode]="restrictMode"
            [useInteractiveMode]="useInteractiveMode"
            (remoteTypeChanged)="onRemoteTypeChange()"
            (interactiveModeToggled)="onInteractiveModeToggled($event)"
            (fieldChanged)="onRemoteFieldChanged($event.fieldName, $event.isChanged)"
          />
        </section>
      }

      <!-- Step 1: Serve Configuration -->
      @if (currentStep === 1 && isServeMode) {
        <section class="step-container">
          <app-serve-config-step
            class="step"
            [form]="serveConfigForm"
            [remoteName]="getRemoteName()"
            [hasSavedServeConfig]="hasSavedServeConfig"
            [savedType]="savedType"
            [availableServeTypes]="availableServeTypes"
            [selectedType]="selectedServeType"
            [dynamicServeFields]="dynamicServeFields"
            [isLoadingFields]="isLoadingServeFields"
            [getControlKey]="getServeControlKey.bind(this)"
            (typeChange)="onServeTypeChange($event)"
          />
        </section>
      }

      <!-- Steps 2-9: Flag Configurations (Mount, Copy, Sync, etc.) or Serve Steps -->
      @if (!isServeMode) {
        @for (flagType of FLAG_TYPES; track flagType; let i = $index) {
          @if (editTarget === flagType || (!editTarget && currentStep === i + 2)) {
            <section class="step-container">
              <app-flag-config-step
                class="step"
                [form]="remoteConfigForm"
                [flagType]="flagType"
                [isEditMode]="!!editTarget"
                [existingRemotes]="existingRemotes"
                [dynamicFlagFields]="dynamicFlagFields[flagType]"
                [mountTypes]="mountTypes"
                [currentRemoteName]="getRemoteName()"
                [isNewRemote]="!editTarget"
                [getControlKey]="getUniqueControlKey.bind(this)"
                (sourceFolderSelected)="handleSourceFolderSelect(flagType)"
                (destFolderSelected)="handleDestFolderSelect(flagType)"
              />
            </section>
          }
        }
      }

      <!-- Serve Mode Steps -->
      @if (isServeMode) {
        <!-- Step 2: Filter -->
        @if (currentStep === 2) {
          <section class="step-container">
            <app-flag-config-step
              class="step"
              [form]="remoteConfigForm"
              [flagType]="'filter'"
              [isEditMode]="false"
              [existingRemotes]="existingRemotes"
              [dynamicFlagFields]="dynamicFlagFields['filter']"
              [mountTypes]="mountTypes"
              [currentRemoteName]="getRemoteName()"
              [isNewRemote]="true"
              [getControlKey]="getUniqueControlKey.bind(this)"
            />
          </section>
        }

        <!-- Step 3: VFS -->
        @if (currentStep === 3) {
          <section class="step-container">
            <app-flag-config-step
              class="step"
              [form]="remoteConfigForm"
              [flagType]="'vfs'"
              [isEditMode]="false"
              [existingRemotes]="existingRemotes"
              [dynamicFlagFields]="dynamicFlagFields['vfs']"
              [mountTypes]="mountTypes"
              [currentRemoteName]="getRemoteName()"
              [isNewRemote]="true"
              [getControlKey]="getUniqueControlKey.bind(this)"
            />
          </section>
        }

        <!-- Step 4: Backend -->
        @if (currentStep === 4) {
          <section class="step-container">
            <app-flag-config-step
              class="step"
              [form]="remoteConfigForm"
              [flagType]="'backend'"
              [isEditMode]="false"
              [existingRemotes]="existingRemotes"
              [dynamicFlagFields]="dynamicFlagFields['backend']"
              [mountTypes]="mountTypes"
              [currentRemoteName]="getRemoteName()"
              [isNewRemote]="true"
              [getControlKey]="getUniqueControlKey.bind(this)"
            />
          </section>
        }
      }
    }
  </main>

  <!-- Footer Buttons -->
  <footer class="button-container">
    <!-- Left Side: Back Button -->
    <div class="button-container-inner">
      @if (
        currentStep > 1 &&
        (!editTarget || (isServeMode && !isEditingSpecificServeSection)) &&
        !interactiveFlowState.isActive
      ) {
        <button
          matButton="filled"
          class="accent"
          [disabled]="isAuthInProgress"
          (click)="prevStep()"
          [@fadeInOut]
          title="Go to previous step"
          aria-label="Previous step"
        >
          <mat-icon svgIcon="left-arrow"></mat-icon>
          Back
        </button>
      }
    </div>

    <!-- Center/Right Side: Action Buttons -->
    <div class="button-container-inner">
      <!-- Cancel Button (During Auth or Interactive Flow) -->
      @if ((isAuthInProgress && !isAuthCancelled) || interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="warn"
          [@fadeInOut]
          (click)="cancelAuth()"
          [disabled]="(!isAuthInProgress && !interactiveFlowState.isActive) || isAuthCancelled"
          title="Cancel the current operation"
          aria-label="Cancel current operation"
        >
          Cancel
        </button>
      }

      <!-- Cleanup Status (Shows when auth is cancelled) -->
      @if (isAuthCancelled) {
        <span class="cleanup-status" aria-live="polite">
          Cleaning up
          <mat-spinner diameter="16" aria-hidden="true"></mat-spinner>
        </span>
      }

      <!-- Save Button (Shown on step > 1 in create mode, or in edit mode) -->
      @if (((currentStep > 1 && !editTarget) || editTarget) && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          (click)="onSubmit()"
          [disabled]="isSaveDisabled"
          [@fadeInOut]
          aria-live="polite"
          [attr.aria-label]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
          [title]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
        >
          <!-- Loading State -->
          @if (isAuthInProgress && !isAuthCancelled) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }

          <!-- Button Label -->
          <span>{{ saveButtonLabel }}</span>
        </button>
      }

      @if (interactiveFlowState.isActive) {
        <button
          matButton="filled"
          (click)="onInteractiveContinue(interactiveFlowState.answer)"
          [disabled]="isInteractiveContinueDisabled()"
          class="continue-button"
          [class.loading]="interactiveFlowState.isProcessing || isAuthCancelled"
          [@fadeInOut]
          aria-live="polite"
          [attr.aria-label]="
            interactiveFlowState.isProcessing ? 'Processing...' : 'Continue to next step'
          "
          [title]="interactiveFlowState.isProcessing ? 'Processing...' : 'Continue to next step'"
        >
          @if (interactiveFlowState.isProcessing && !isAuthCancelled) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }
          <span>{{ interactiveFlowState.isProcessing ? 'Processing...' : 'Continue' }}</span>
        </button>
      }

      <!-- Next Button (Shown in create mode when not on last step) -->
      @if (currentStep < currentTotalSteps && !editTarget && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="accent"
          (click)="nextStep()"
          [disabled]="!remoteForm.valid || isAuthInProgress"
          [@fadeInOut]
          title="Go to next step"
          aria-label="Next step"
        >
          Next
          <mat-icon svgIcon="right-arrow"></mat-icon>
        </button>
      }
    </div>
  </footer>
</div>
