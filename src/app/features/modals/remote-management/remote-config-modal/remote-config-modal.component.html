<div class="modal-container">
  <!-- Modal Header -->
  <header class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon [svgIcon]="iconService.getIconName(remoteForm.get('type')?.value)"></mat-icon>
    </button>
    <p data-tauri-drag-region>
      <span>
        {{ editTarget ? 'Edit ' + (editTarget | titlecase) + ' Settings' : 'Add New Remote' }}
      </span>
    </p>
    <button matIconButton (click)="close()" aria-label="Close dialog" title="Close">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </header>

  <!-- Step Progress Indicator (Only shown during multi-step create flow) -->
  @if (!interactiveFlowState.isActive && (!editTarget || isServeMode)) {
    <div class="step-indicator-container">
      <div class="step-indicator hide-scrollbar" role="tablist" aria-label="Configuration Steps">
        @for (step of currentStepLabels; track step; let i = $index) {
          <button
            class="step"
            [ngClass]="getStepState(i + 1)"
            [class.clickable]="editTarget"
            (click)="goToStep(i + 1)"
            (keydown)="handleStepKeydown($event, i + 1)"
            [attr.tabindex]="editTarget ? '0' : '-1'"
            role="tab"
            [disabled]="isAuthInProgress || (isServeMode ? false : !remoteForm.valid)"
            [attr.aria-selected]="currentStep === i + 1"
          >
            <div class="step-number">
              @if (getStepState(i + 1) === 'completed') {
                <mat-icon svgIcon="circle-check"></mat-icon>
              } @else {
                <mat-icon [svgIcon]="getStepIcon(i)"></mat-icon>
              }
            </div>
            @if (getStepState(i + 1) === 'current') {
              <span
                class="step-label-animated"
                animate.enter="label-slide-in-enter"
                animate.leave="label-slide-in-leave"
                >{{ step }}</span
              >
            }
          </button>
        }
      </div>
    </div>
  }

  <!-- Modal Content -->
  <main class="modal-content">
    <!-- Interactive Configuration Flow -->
    @if (interactiveFlowState.isActive && interactiveFlowState.question) {
      <section class="step-container interactive" aria-live="polite" aria-busy="true">
        <app-interactive-config-step
          [question]="interactiveFlowState.question"
          [canceling]="isAuthCancelled"
          [processing]="interactiveFlowState.isProcessing"
          (answerChange)="handleInteractiveAnswerUpdate($event)"
        />
      </section>
    }

    <!-- Non-Interactive Configuration Flow -->
    @if (!interactiveFlowState.isActive) {
      <!-- Step 1: Remote Configuration -->
      @if (currentStep === 1) {
        <section class="step-container">
          <app-remote-config-step
            class="step"
            [form]="remoteForm"
            [remoteFields]="dynamicRemoteFields"
            [remoteTypes]="remoteTypes"
            [isLoading]="isRemoteConfigLoading"
            [existingRemotes]="existingRemotes"
            [restrictMode]="restrictMode"
            [useInteractiveMode]="useInteractiveMode"
            (remoteTypeChanged)="onRemoteTypeChange()"
            (interactiveModeToggled)="onInteractiveModeToggled($event)"
            (fieldChanged)="onRemoteFieldChanged($event.fieldName, $event.isChanged)"
          />
        </section>
      }

      <!-- Flags and Serve Steps -->
      <!-- We iterate manually or use a smarter loop.
           Order: Remote(1), Mount(2), Serve(3), Copy(4), Sync(5), Bisync(6), Move(7), Filter(8), VFS(9), Backend(10)
           FlagTypes: mount(0), copy(1), sync(2), bisync(3), move(4), filter(5), vfs(6), backend(7)
      -->
      @for (flagType of FLAG_TYPES; track flagType; let i = $index) {
        <!-- Logic to determine step number for this flag type -->
        <!-- Mount is i=0 -> Step 2 -->
        <!-- Serve is Step 3 (Inserted manual) -->
        <!-- Others are i>=1 -> Step i+3 -->
        @let stepNum = i === 0 ? 2 : i + 3;

        @if (currentStep === stepNum) {
          <section class="step-container">
            <!-- Profile Management Header -->
            @if (PROFILE_SUPPORTED_TYPES.includes(flagType)) {
              <div class="profile-header">
                @if (profileState[flagType].mode === 'view') {
                  <mat-form-field
                    appearance="outline"
                    subscriptSizing="dynamic"
                    class="profile-select"
                  >
                    <mat-label>Profile</mat-label>
                    <mat-select
                      [value]="getSelectedProfile(flagType)"
                      (selectionChange)="selectProfile(flagType, $event.value)"
                    >
                      @for (profile of getProfiles(flagType); track profile.name) {
                        <mat-option [value]="profile.name">{{ profile.name }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  <div class="profile-actions">
                    <button
                      mat-icon-button
                      (click)="startAddProfile(flagType)"
                      title="Add Profile"
                      matTooltip="Add Profile"
                    >
                      <mat-icon svgIcon="plus"></mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      (click)="startEditProfile(flagType)"
                      title="Rename Profile"
                      matTooltip="Rename Profile"
                    >
                      <mat-icon svgIcon="pencil"></mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="deleteProfile(flagType, getSelectedProfile(flagType))"
                      title="Delete Profile"
                      matTooltip="Delete Profile"
                    >
                      <mat-icon svgIcon="trash"></mat-icon>
                    </button>
                  </div>
                } @else {
                  <!-- Edit/Add Mode -->
                  <mat-form-field
                    appearance="outline"
                    subscriptSizing="dynamic"
                    class="profile-input"
                  >
                    <mat-label>{{
                      profileState[flagType].mode === 'add' ? 'New Profile Name' : 'Rename Profile'
                    }}</mat-label>
                    <input
                      matInput
                      [(ngModel)]="profileState[flagType].tempName"
                      [ngModelOptions]="{ standalone: true }"
                      (keyup.enter)="saveProfile(flagType)"
                      (keyup.escape)="cancelProfileEdit(flagType)"
                      autoFocus
                    />
                  </mat-form-field>

                  <div class="profile-actions">
                    <button
                      mat-icon-button
                      color="primary"
                      (click)="saveProfile(flagType)"
                      title="Save"
                      matTooltip="Save"
                    >
                      <mat-icon svgIcon="check"></mat-icon>
                    </button>
                    <button
                      mat-icon-button
                      color="warn"
                      (click)="cancelProfileEdit(flagType)"
                      title="Cancel"
                      matTooltip="Cancel"
                    >
                      <mat-icon svgIcon="x"></mat-icon>
                    </button>
                  </div>
                }
              </div>
            }

            <!-- Linked Profiles for Operations (Mount, Sync, Copy, Move, Bisync) -->
            @if (['mount', 'sync', 'copy', 'move', 'bisync'].includes(flagType)) {
              <div class="linked-profiles-row">
                <!-- VFS Profile (Mount only) -->
                @if (flagType === 'mount') {
                  <mat-form-field appearance="outline" subscriptSizing="dynamic">
                    <mat-label>VFS Profile</mat-label>
                    <mat-select
                      [formControl]="
                        $any(remoteConfigForm.get(flagType + 'Config')?.get('vfsProfile'))
                      "
                    >
                      @for (opt of getProfileOptions('vfs'); track opt) {
                        <mat-option [value]="opt">{{ opt }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                }

                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Filter Profile</mat-label>
                  <mat-select
                    [formControl]="
                      $any(remoteConfigForm.get(flagType + 'Config')?.get('filterProfile'))
                    "
                  >
                    @for (opt of getProfileOptions('filter'); track opt) {
                      <mat-option [value]="opt">{{ opt }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" subscriptSizing="dynamic">
                  <mat-label>Backend Profile</mat-label>
                  <mat-select
                    [formControl]="
                      $any(remoteConfigForm.get(flagType + 'Config')?.get('backendProfile'))
                    "
                  >
                    @for (opt of getProfileOptions('backend'); track opt) {
                      <mat-option [value]="opt">{{ opt }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            }

            <app-flag-config-step
              class="step"
              [form]="remoteConfigForm"
              [flagType]="flagType"
              [isEditMode]="!!editTarget"
              [existingRemotes]="existingRemotes"
              [dynamicFlagFields]="dynamicFlagFields[flagType]"
              [mountTypes]="mountTypes"
              [currentRemoteName]="getRemoteName()"
              [isNewRemote]="!editTarget"
              [getControlKey]="getUniqueControlKey.bind(this)"
              (sourceFolderSelected)="handleSourceFolderSelect(flagType)"
              (destFolderSelected)="handleDestFolderSelect(flagType)"
            />
          </section>
        }
      }

      <!-- Serve Step (Step 3) -->
      @if (currentStep === 3) {
        <section class="step-container">
          <div class="profile-header">
            @if (profileState['serve'].mode === 'view') {
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="profile-select">
                <mat-label>Profile</mat-label>
                <mat-select
                  [value]="getSelectedProfile('serve')"
                  (selectionChange)="selectProfile('serve', $event.value)"
                >
                  @for (profile of getProfiles('serve'); track profile.name) {
                    <mat-option [value]="profile.name">{{ profile.name }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <div class="profile-actions">
                <button
                  mat-icon-button
                  (click)="startAddProfile('serve')"
                  title="Add Profile"
                  matTooltip="Add Profile"
                >
                  <mat-icon svgIcon="plus"></mat-icon>
                </button>
                <button
                  mat-icon-button
                  (click)="startEditProfile('serve')"
                  title="Rename Profile"
                  matTooltip="Rename Profile"
                >
                  <mat-icon svgIcon="pencil"></mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteProfile('serve', getSelectedProfile('serve'))"
                  title="Delete Profile"
                  matTooltip="Delete Profile"
                  [disabled]="getProfiles('serve').length <= 1"
                >
                  <mat-icon svgIcon="trash"></mat-icon>
                </button>
              </div>
            } @else {
              <!-- Edit/Add Mode -->
              <mat-form-field appearance="outline" subscriptSizing="dynamic" class="profile-input">
                <mat-label>{{
                  profileState['serve'].mode === 'add' ? 'New Profile Name' : 'Rename Profile'
                }}</mat-label>
                <input
                  matInput
                  [(ngModel)]="profileState['serve'].tempName"
                  [ngModelOptions]="{ standalone: true }"
                  (keyup.enter)="saveProfile('serve')"
                  (keyup.escape)="cancelProfileEdit('serve')"
                  autoFocus
                />
              </mat-form-field>

              <div class="profile-actions">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="saveProfile('serve')"
                  title="Save"
                  matTooltip="Save"
                >
                  <mat-icon svgIcon="check"></mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="cancelProfileEdit('serve')"
                  title="Cancel"
                  matTooltip="Cancel"
                >
                  <mat-icon svgIcon="x"></mat-icon>
                </button>
              </div>
            }
          </div>

          <!-- Linked Profiles for Serve -->
          <div class="linked-profiles-row">
            <mat-form-field appearance="outline" subscriptSizing="dynamic">
              <mat-label>VFS Profile</mat-label>
              <mat-select
                [formControl]="$any(remoteConfigForm.get('serveConfig')?.get('vfsProfile'))"
              >
                @for (opt of getProfileOptions('vfs'); track opt) {
                  <mat-option [value]="opt">{{ opt }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" subscriptSizing="dynamic">
              <mat-label>Filter Profile</mat-label>
              <mat-select
                [formControl]="$any(remoteConfigForm.get('serveConfig')?.get('filterProfile'))"
              >
                @for (opt of getProfileOptions('filter'); track opt) {
                  <mat-option [value]="opt">{{ opt }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" subscriptSizing="dynamic">
              <mat-label>Backend Profile</mat-label>
              <mat-select
                [formControl]="$any(remoteConfigForm.get('serveConfig')?.get('backendProfile'))"
              >
                @for (opt of getProfileOptions('backend'); track opt) {
                  <mat-option [value]="opt">{{ opt }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <app-serve-config-step
            class="step"
            [form]="getServeConfigForm()"
            [remoteName]="getRemoteName()"
            [hasSavedServeConfig]="hasSavedServeConfig"
            [savedType]="savedType"
            [availableServeTypes]="availableServeTypes"
            [selectedType]="selectedServeType"
            [dynamicServeFields]="dynamicServeFields"
            [isLoadingFields]="isLoadingServeFields"
            [getControlKey]="getServeControlKey.bind(this)"
            (typeChange)="onServeTypeChange($event)"
          />
        </section>
      }
    }
  </main>

  <!-- Footer Buttons -->
  <footer class="button-container">
    <!-- Left Side: Back Button -->
    <div class="button-container-inner">
      @if (
        currentStep > 1 &&
        (!editTarget || (isServeMode && !isEditingSpecificServeSection)) &&
        !interactiveFlowState.isActive
      ) {
        <button
          matButton="filled"
          class="accent"
          [disabled]="isAuthInProgress"
          (click)="prevStep()"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          title="Go to previous step"
          aria-label="Previous step"
        >
          <mat-icon svgIcon="left-arrow"></mat-icon>
          Back
        </button>
      }
    </div>

    <!-- Center/Right Side: Action Buttons -->
    <div class="button-container-inner">
      <!-- Cancel Button (During Auth or Interactive Flow) -->
      @if ((isAuthInProgress && !isAuthCancelled) || interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="warn"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          (click)="cancelAuth()"
          [disabled]="(!isAuthInProgress && !interactiveFlowState.isActive) || isAuthCancelled"
          title="Cancel the current operation"
          aria-label="Cancel current operation"
        >
          Cancel
        </button>
      }

      <!-- Cleanup Status (Shows when auth is cancelled) -->
      @if (isAuthCancelled) {
        <span class="cleanup-status" aria-live="polite">
          Cleaning up
          <mat-spinner diameter="16" aria-hidden="true"></mat-spinner>
        </span>
      }

      <!-- Save Button (Shown on step > 1 in create mode, or in edit mode) -->
      @if (((currentStep > 1 && !editTarget) || editTarget) && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          (click)="onSubmit()"
          [disabled]="isSaveDisabled"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          aria-live="polite"
          [attr.aria-label]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
          [title]="editTarget ? 'Save changes' : 'Save configuration and create remote'"
        >
          <!-- Loading State -->
          @if (isAuthInProgress && !isAuthCancelled) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }

          <!-- Button Label -->
          <span>{{ saveButtonLabel }}</span>
        </button>
      }

      @if (interactiveFlowState.isActive) {
        <button
          matButton="filled"
          (click)="onInteractiveContinue(interactiveFlowState.answer)"
          [disabled]="isInteractiveContinueDisabled()"
          class="continue-button"
          [class.loading]="interactiveFlowState.isProcessing || isAuthCancelled"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          aria-live="polite"
          [attr.aria-label]="
            interactiveFlowState.isProcessing ? 'Processing...' : 'Continue to next step'
          "
          [title]="interactiveFlowState.isProcessing ? 'Processing...' : 'Continue to next step'"
        >
          @if (interactiveFlowState.isProcessing && !isAuthCancelled) {
            <div class="saving-overlay" aria-hidden="true">
              <mat-spinner diameter="16"></mat-spinner>
            </div>
          }
          <span>{{ interactiveFlowState.isProcessing ? 'Processing...' : 'Continue' }}</span>
        </button>
      }

      <!-- Next Button (Shown in create mode when not on last step) -->
      @if (currentStep < currentTotalSteps && !editTarget && !interactiveFlowState.isActive) {
        <button
          matButton="filled"
          class="accent"
          (click)="nextStep()"
          [disabled]="!remoteForm.valid || isAuthInProgress"
          animate.enter="fade-in-out-enter"
          animate.leave="fade-in-out-leave"
          title="Go to next step"
          aria-label="Next step"
        >
          Next
          <mat-icon svgIcon="right-arrow"></mat-icon>
        </button>
      }
    </div>
  </footer>
</div>
