<div class="rclone-config-modal">
  <div class="modal-header" data-tauri-drag-region>
    <button mat-icon-button (click)="toggleSearchVisibility()" aria-label="Toggle Search">
      <mat-icon svgIcon="search"></mat-icon>
    </button>
    <p>{{ getPageTitle() }}</p>
    <button mat-icon-button (click)="close()" aria-label="Close">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  @if (isLoading) {
    <div class="loading-overlay">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

  <!-- HOME PAGE: GROUPED BY MAIN CATEGORIES -->
  @if (!isLoading && currentPage === 'home') {
    <div class="modal-content" #content>
      <div class="home-search-container">
        <app-search-container
          [visible]="isSearchVisible"
          [searchText]="homeSearchQuery"
          (searchTextChange)="onHomeSearchChange($event)"
          placeholder="Search all services..."
          ariaLabel="Search RClone services"
        ></app-search-container>
      </div>

      <mat-accordion>
        @for (
          mainCategory of ['General Settings', 'File System & Storage', 'Network & Servers'];
          track mainCategory
        ) {
          @if (getServicesByMainCategory()[mainCategory].length > 0) {
            <mat-expansion-panel [expanded]="false" class="main-category-panel">
              <mat-expansion-panel-header>
                <mat-panel-title class="main-category-title-text">
                  <div class="main-category-header">
                    <span class="category-name">{{ mainCategory }}</span>
                    <small class="category-desc">{{
                      getMainCategoryDescription(mainCategory)
                    }}</small>
                  </div>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="main-category-services">
                @for (service of getServicesByMainCategory()[mainCategory]; track service.name) {
                  <mat-expansion-panel
                    [expanded]="service.expanded"
                    (opened)="service.expanded = true"
                    (closed)="service.expanded = false"
                    class="service-panel"
                  >
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon [svgIcon]="getServiceIcon(service.name)"></mat-icon>
                        <div class="category-header-text">
                          <span class="category-title">{{ service.name | titlecase }}</span>
                          <small class="category-description">{{
                            getServiceDescription(service.name)
                          }}</small>
                        </div>
                      </mat-panel-title>
                    </mat-expansion-panel-header>

                    <div class="category-items">
                      @for (
                        categoryName of getServiceCategories(service.name);
                        track categoryName
                      ) {
                        <button
                          mat-button
                          class="config-item"
                          (click)="navigateTo(service.name, categoryName)"
                        >
                          <div class="config-item-content">
                            <mat-icon [svgIcon]="getCategoryIcon(categoryName)"></mat-icon>
                            <div class="config-item-text">
                              <span class="config-item-title">
                                {{ categoryName }}
                                @if (homeSearchQuery) {
                                  <span class="match-count">{{ globalSearchResults.length }}</span>
                                }
                              </span>
                              <small class="config-item-description">{{
                                getCategoryDescription(categoryName)
                              }}</small>
                            </div>
                          </div>
                          <mat-icon svgIcon="chevron-right"></mat-icon>
                        </button>
                      }
                    </div>
                  </mat-expansion-panel>
                }
              </div>
            </mat-expansion-panel>
          }
        }
      </mat-accordion>

      @if (!homeSearchQuery) {
        <div class="security-section">
          <button mat-button class="config-item security-item" (click)="navigateTo('security')">
            <div class="config-item-content">
              <mat-icon svgIcon="lock"></mat-icon>
              <div class="config-item-text">
                <span class="config-item-title">Security Settings</span>
                <small class="config-item-description"
                  >Configuration encryption and password management</small
                >
              </div>
            </div>
            <mat-icon svgIcon="chevron-right"></mat-icon>
          </button>
        </div>
      }

      @if (homeSearchQuery && filteredServices.length === 0) {
        <div class="no-results-home"></div>
      }
    </div>
  }

  <!-- SETTINGS PAGE: BASIC/ADVANCED SPLIT -->
  @if (currentPage !== 'home' && !isLoading) {
    <div class="overlay" [@slideOverlay]>
      <div class="overlay-header" data-tauri-drag-region>
        <button mat-icon-button (click)="navigateTo('home')">
          <mat-icon svgIcon="chevron-left"></mat-icon>
        </button>
        <p>{{ getPageTitle() }}</p>
        <button mat-icon-button (click)="close()">
          <mat-icon svgIcon="circle-xmark"></mat-icon>
        </button>
      </div>

      <div class="overlay-content">
        @if (isSecurityPage) {
          <app-security-settings></app-security-settings>
        } @else {
          <div class="settings-list">
            <app-search-container
              [visible]="isSearchVisible"
              [searchText]="searchQuery"
              (searchTextChange)="onSearchTextChange($event)"
              placeholder="Search settings..."
              ariaLabel="Search RClone settings"
            ></app-search-container>

            @if (hasSearchQuery) {
              <div class="search-results-info">
                <small
                  >Showing {{ filteredOptionsCount }} of {{ totalOptionsCount }} settings</small
                >
              </div>
            }

            @if (filteredOptionsCount === 0 && hasSearchQuery) {
              <div class="no-results">
                <mat-icon svgIcon="search"></mat-icon>
                <h4>No settings found</h4>
                <p>Try adjusting your search terms</p>
              </div>
            } @else {
              <!-- BASIC SETTINGS SECTION -->
              @if (filteredOptionsCount === 0 && hasSearchQuery) {
                <div class="no-results">
                  <mat-icon svgIcon="search"></mat-icon>
                  <h4>No settings found</h4>
                  <p>Try adjusting your search terms</p>
                </div>
              } @else {
                <div class="settings-list">
                  @for (
                    option of getRCloneOptionsForCurrentPage();
                    track trackByOptionName($index, option)
                  ) {
                    <ng-container
                      *ngTemplateOutlet="settingItem; context: { $implicit: option }"
                    ></ng-container>
                  }
                </div>
              }
            }
          </div>
        }
      </div>
    </div>
  }
</div>

<!-- SETTING ITEM TEMPLATE (reusable) -->
<ng-template #settingItem let-option>
  <div class="setting-item">
    @switch (option.Type) {
      @case ('bool') {
        <div class="setting-info">
          <strong>{{ option.FieldName }}</strong>
          <p>{{ option.Help }}</p>
          <small class="default-value">Default: {{ option.DefaultStr }}</small>
        </div>
        <div class="setting-control">
          <mat-slide-toggle
            [formControl]="$any(getRCloneOptionControl(option.Name))"
            [attr.aria-label]="option.Name"
            (change)="saveRCloneOption(option.Name)"
          >
            {{ getRCloneOptionControl(option.Name)?.value ? 'Enabled' : 'Disabled' }}
          </mat-slide-toggle>
        </div>
      }

      @case ('string') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
            <small class="default-value">Default: {{ option.DefaultStr }}</small>
          </div>
          <div class="setting-control">
            <mat-form-field class="input-field" appearance="outline">
              <input
                matInput
                [formControl]="$any(getRCloneOptionControl(option.Name))"
                [attr.aria-label]="option.Name"
                [placeholder]="option.DefaultStr || ''"
                (blur)="saveRCloneOption(option.Name)"
              />
              @if (
                getRCloneOptionControl(option.Name)?.invalid &&
                getRCloneOptionControl(option.Name)?.touched
              ) {
                <mat-error>{{
                  getRCloneOptionError(getRCloneOptionControl(option.Name))
                }}</mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      }

      @case ('Duration') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
            <small class="default-value">Default: {{ option.DefaultStr }}</small>
          </div>
          <div class="setting-control">
            <mat-form-field class="input-field" appearance="outline">
              <input
                matInput
                [formControl]="$any(getRCloneOptionControl(option.Name))"
                [attr.aria-label]="option.Name"
                [placeholder]="option.DefaultStr || ''"
                (blur)="saveRCloneOption(option.Name)"
              />
              <mat-hint>Format: 1h30m45s</mat-hint>
              @if (
                getRCloneOptionControl(option.Name)?.invalid &&
                getRCloneOptionControl(option.Name)?.touched
              ) {
                <mat-error>{{
                  getRCloneOptionError(getRCloneOptionControl(option.Name))
                }}</mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      }

      @case ('SizeSuffix') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
            <small class="default-value">Default: {{ option.DefaultStr }}</small>
          </div>
          <div class="setting-control">
            <mat-form-field class="input-field" appearance="outline">
              <input
                matInput
                [formControl]="$any(getRCloneOptionControl(option.Name))"
                [attr.aria-label]="option.Name"
                [placeholder]="option.DefaultStr || ''"
                (blur)="saveRCloneOption(option.Name)"
              />
              <mat-hint>Format: 100Ki, 16Mi, 1Gi</mat-hint>
              @if (
                getRCloneOptionControl(option.Name)?.invalid &&
                getRCloneOptionControl(option.Name)?.touched
              ) {
                <mat-error>{{
                  getRCloneOptionError(getRCloneOptionControl(option.Name))
                }}</mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      }

      @case ('FileMode') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
            <small class="default-value">Default: {{ option.DefaultStr }}</small>
          </div>
          <div class="setting-control">
            <mat-form-field class="input-field" appearance="outline">
              <input
                matInput
                [formControl]="$any(getRCloneOptionControl(option.Name))"
                [attr.aria-label]="option.Name"
                [placeholder]="option.DefaultStr || ''"
                (blur)="saveRCloneOption(option.Name)"
              />
              @if (
                getRCloneOptionControl(option.Name)?.invalid &&
                getRCloneOptionControl(option.Name)?.touched
              ) {
                <mat-error>{{
                  getRCloneOptionError(getRCloneOptionControl(option.Name))
                }}</mat-error>
              }
            </mat-form-field>
          </div>
        </div>
      }

      @case ('int') {
        <div class="setting-info">
          <strong>{{ option.FieldName }}</strong>
          <p>{{ option.Help }}</p>
          <small class="default-value">Default: {{ option.DefaultStr }}</small>
        </div>
        <div class="setting-control">
          <mat-form-field class="input-field" appearance="outline">
            <input
              matInput
              type="number"
              [formControl]="$any(getRCloneOptionControl(option.Name))"
              [attr.aria-label]="option.Name"
              [placeholder]="option.DefaultStr || ''"
              (blur)="saveRCloneOption(option.Name)"
            />
            @if (
              getRCloneOptionControl(option.Name)?.invalid &&
              getRCloneOptionControl(option.Name)?.touched
            ) {
              <mat-error>{{ getRCloneOptionError(getRCloneOptionControl(option.Name)) }}</mat-error>
            }
          </mat-form-field>
        </div>
      }

      @case ('int64') {
        <div class="setting-info">
          <strong>{{ option.FieldName }}</strong>
          <p>{{ option.Help }}</p>
          <small class="default-value">Default: {{ option.DefaultStr }}</small>
        </div>
        <div class="setting-control">
          <mat-form-field class="input-field" appearance="outline">
            <input
              matInput
              type="number"
              [formControl]="$any(getRCloneOptionControl(option.Name))"
              [attr.aria-label]="option.Name"
              [placeholder]="option.DefaultStr || ''"
              (blur)="saveRCloneOption(option.Name)"
            />
            @if (
              getRCloneOptionControl(option.Name)?.invalid &&
              getRCloneOptionControl(option.Name)?.touched
            ) {
              <mat-error>{{ getRCloneOptionError(getRCloneOptionControl(option.Name)) }}</mat-error>
            }
          </mat-form-field>
        </div>
      }

      @case ('uint32') {
        <div class="setting-info">
          <strong>{{ option.FieldName }}</strong>
          <p>{{ option.Help }}</p>
          <small class="default-value">Default: {{ option.DefaultStr }}</small>
        </div>
        <div class="setting-control">
          <mat-form-field class="input-field" appearance="outline">
            <input
              matInput
              type="number"
              [formControl]="$any(getRCloneOptionControl(option.Name))"
              [attr.aria-label]="option.Name"
              [placeholder]="option.DefaultStr || ''"
              (blur)="saveRCloneOption(option.Name)"
            />
            @if (
              getRCloneOptionControl(option.Name)?.invalid &&
              getRCloneOptionControl(option.Name)?.touched
            ) {
              <mat-error>{{ getRCloneOptionError(getRCloneOptionControl(option.Name)) }}</mat-error>
            }
          </mat-form-field>
        </div>
      }

      @case ('float64') {
        <div class="setting-info">
          <strong>{{ option.FieldName }}</strong>
          <p>{{ option.Help }}</p>
          <small class="default-value">Default: {{ option.DefaultStr }}</small>
        </div>
        <div class="setting-control">
          <mat-form-field class="input-field" appearance="outline">
            <input
              matInput
              type="number"
              step="any"
              [formControl]="$any(getRCloneOptionControl(option.Name))"
              [attr.aria-label]="option.Name"
              [placeholder]="option.DefaultStr || ''"
              (blur)="saveRCloneOption(option.Name)"
            />
            @if (
              getRCloneOptionControl(option.Name)?.invalid &&
              getRCloneOptionControl(option.Name)?.touched
            ) {
              <mat-error>{{ getRCloneOptionError(getRCloneOptionControl(option.Name)) }}</mat-error>
            }
          </mat-form-field>
        </div>
      }

      @case ('stringArray') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
          </div>
          <div class="array-items">
            @for (control of getFormArrayControls(option.Name); track $index) {
              <div class="array-item">
                <mat-form-field appearance="outline" class="array-input">
                  <input
                    matInput
                    [formControl]="$any(control)"
                    [attr.aria-label]="option.Name + ' item ' + ($index + 1)"
                    (blur)="saveRCloneOption(option.Name)"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    (click)="removeArrayItem(option.Name, $index)"
                    [attr.aria-label]="'Remove ' + option.Name + ' item'"
                  >
                    <mat-icon svgIcon="trash"></mat-icon>
                  </button>
                </mat-form-field>
              </div>
            }
            <button
              mat-stroked-button
              class="add-array-item-btn"
              (click)="addArrayItem(option.Name)"
            >
              <mat-icon svgIcon="plus"></mat-icon>
              Add Item
            </button>
          </div>
        </div>
      }

      @case ('LogLevel') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
            <small class="default-value">Default: {{ option.DefaultStr }}</small>
          </div>
          <div class="setting-control">
            <mat-form-field class="input-field" appearance="outline">
              <mat-select
                [formControl]="$any(getRCloneOptionControl(option.Name))"
                [attr.aria-label]="option.Name"
                (selectionChange)="saveRCloneOption(option.Name)"
              >
                @for (example of option.Examples; track example.Value) {
                  <mat-option [value]="example.Value">{{ example.Value }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      }

      @case ('CacheMode') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
            <small class="default-value">Default: {{ option.DefaultStr }}</small>
          </div>
          <div class="setting-control">
            <mat-form-field class="input-field" appearance="outline">
              <mat-select
                [formControl]="$any(getRCloneOptionControl(option.Name))"
                [attr.aria-label]="option.Name"
                (selectionChange)="saveRCloneOption(option.Name)"
              >
                @for (example of option.Examples; track example.Value) {
                  <mat-option [value]="example.Value">{{ example.Value }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      }

      @case ('DumpFlags') {
        <div class="setting-full-width">
          <div class="setting-info">
            <strong>{{ option.FieldName }}</strong>
            <p>{{ option.Help }}</p>
            <small class="default-value">Default: {{ option.DefaultStr }}</small>
          </div>
          <div class="setting-control">
            <mat-form-field class="input-field" appearance="outline">
              <mat-select
                [multiple]="true"
                [formControl]="$any(getRCloneOptionControl(option.Name))"
                [attr.aria-label]="option.Name"
                (selectionChange)="saveRCloneOption(option.Name)"
              >
                @for (example of option.Examples; track example.Value) {
                  <mat-option [value]="example.Value">{{ example.Value }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      }

      @default {
        @if (
          option.Exclusive &&
          option.Examples &&
          !['LogLevel', 'CacheMode', 'DumpFlags'].includes(option.Type)
        ) {
          <div class="setting-full-width">
            <div class="setting-info">
              <strong>{{ option.FieldName }}</strong>
              <p>{{ option.Help }}</p>
              <small class="default-value">Default: {{ option.DefaultStr }}</small>
            </div>
            <div class="setting-control">
              <mat-form-field class="input-field" appearance="outline">
                <mat-select
                  [formControl]="$any(getRCloneOptionControl(option.Name))"
                  [attr.aria-label]="option.Name"
                  (selectionChange)="saveRCloneOption(option.Name)"
                >
                  @for (example of option.Examples; track example.Value) {
                    <mat-option [value]="example.Value">{{ example.Value }}</mat-option>
                  }
                </mat-select>
                @if (
                  getRCloneOptionControl(option.Name)?.invalid &&
                  getRCloneOptionControl(option.Name)?.touched
                ) {
                  <mat-error>{{
                    getRCloneOptionError(getRCloneOptionControl(option.Name))
                  }}</mat-error>
                }
              </mat-form-field>
            </div>
          </div>
        } @else if (!(option.Exclusive && option.Examples)) {
          <div class="setting-full-width">
            <div class="setting-info">
              <strong>{{ option.FieldName }}</strong>
              <p>{{ option.Help }}</p>
              <small class="type-info">Type: {{ option.Type }} (not implemented)</small>
              <small class="default-value">Default: {{ option.DefaultStr }}</small>
            </div>
          </div>
        }
      }
    }
  </div>
</ng-template>
