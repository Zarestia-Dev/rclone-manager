<div class="rclone-config-modal">
  <div class="modal-header" data-tauri-drag-region>
    <button
      mat-icon-button
      (click)="toggleSearchVisibility()"
      [attr.aria-label]="'modals.rcloneConfig.search.toggle' | translate"
    >
      <mat-icon svgIcon="search"></mat-icon>
    </button>
    <p>
      @if (currentPage() === 'home') {
        {{ 'modals.rcloneConfig.pageTitle.home' | translate }}
      } @else if (currentCategory()) {
        {{
          'modals.rcloneConfig.pageTitle.category'
            | translate: { page: currentPage() | uppercase, category: currentCategory() }
        }}
      } @else {
        {{ 'modals.rcloneConfig.pageTitle.backend' | translate }}
      }
    </p>
    <button mat-icon-button (click)="close()" [attr.aria-label]="'common.close' | translate">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <app-search-container
    [visible]="isSearchVisible()"
    [searchText]="searchQuery()"
    (searchTextChange)="onSearchInput($event)"
    [placeholder]="getSearchPlaceholder() | translate"
    [ariaLabel]="'modals.rcloneConfig.search.label' | translate"
  ></app-search-container>

  @if (isLoading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

  @if (!isLoading() && currentPage() === 'home') {
    <div class="modal-content">
      @if (searchQuery()) {
        @if (globalSearchResults().length > 0) {
          <cdk-virtual-scroll-viewport itemSize="25" class="virtual-scroll-viewport">
            <div class="virtual-scroll-content">
              @for (result of globalSearchResults(); track trackBySearchResult($index, result)) {
                <div
                  class="config-item search-result-item"
                  (click)="navigateTo(result.service, result.category, result.option.Name)"
                  (keydown)="
                    handleKeyboardNavigation(
                      $event,
                      result.service,
                      result.category,
                      result.option.Name
                    )
                  "
                  [tabindex]="0"
                  [attr.aria-label]="
                    'Navigate to ' + result.option.FieldName + ' in ' + result.service
                  "
                >
                  <div class="config-item-content">
                    <mat-icon [svgIcon]="getServiceIcon(result.service)"></mat-icon>
                    <div class="config-item-text">
                      <span class="config-item-title">
                        {{ result.option.FieldName }}
                      </span>
                      <small class="config-item-description">
                        {{ result.service | titlecase }} > {{ result.category }}
                      </small>
                      <small class="config-item-description result-help">
                        {{ result.option.Help }}
                      </small>
                    </div>
                  </div>
                  <mat-icon svgIcon="chevron-right"></mat-icon>
                </div>
              }
            </div>
          </cdk-virtual-scroll-viewport>
        } @else {
          <div class="empty-state">
            <mat-icon svgIcon="search"></mat-icon>
            <span>{{ 'modals.rcloneConfig.search.emptyResult' | translate }}</span>
          </div>
        }
      } @else {
        <mat-accordion>
          @for (
            mainCategory of ['General Settings', 'File System & Storage', 'Network & Servers'];
            track mainCategory
          ) {
            @if (servicesByMainCategory()[mainCategory].length > 0) {
              <mat-expansion-panel [expanded]="false" class="main-category-panel">
                <mat-expansion-panel-header>
                  <mat-panel-title class="main-category-title-text">
                    <div class="main-category-header">
                      <span class="category-name">{{
                        getMainCategoryTitle(mainCategory) | translate
                      }}</span>
                      <small class="category-desc">{{
                        getMainCategoryDescription(mainCategory) | translate
                      }}</small>
                    </div>
                  </mat-panel-title>
                </mat-expansion-panel-header>

                <div class="main-category-services">
                  @for (service of servicesByMainCategory()[mainCategory]; track service.name) {
                    <mat-expansion-panel
                      [expanded]="service.expanded"
                      (opened)="service.expanded = true"
                      (closed)="service.expanded = false"
                      class="service-panel"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon [svgIcon]="getServiceIcon(service.name)"></mat-icon>
                          <div class="category-header-text">
                            <span class="category-title">{{ service.name | titlecase }}</span>
                            <small class="category-description">{{
                              getServiceDescription(service.name) | translate
                            }}</small>
                          </div>
                        </mat-panel-title>
                      </mat-expansion-panel-header>

                      <div class="category-items">
                        @for (
                          categoryName of getServiceCategories(service.name);
                          track categoryName
                        ) {
                          <div
                            class="config-item"
                            (click)="navigateTo(service.name, categoryName)"
                            (keydown)="handleKeyboardNavigation($event, service.name, categoryName)"
                            [tabindex]="0"
                            [attr.aria-label]="
                              'Navigate to ' + categoryName + ' in ' + service.name
                            "
                          >
                            <div class="config-item-content">
                              <mat-icon [svgIcon]="getCategoryIcon(categoryName)"></mat-icon>
                              <div class="config-item-text">
                                <span class="config-item-title">
                                  {{ categoryName }}
                                </span>
                                <small class="config-item-description">{{
                                  getCategoryDescription(categoryName) | translate
                                }}</small>
                              </div>
                            </div>
                            <mat-icon svgIcon="chevron-right"></mat-icon>
                          </div>
                        }
                      </div>
                    </mat-expansion-panel>
                  }
                </div>
              </mat-expansion-panel>
            }
          }
        </mat-accordion>

        <div class="actions">
          <button
            mat-raised-button
            class="warn"
            (click)="resetAllOptions()"
            [disabled]="isResetting()"
            [attr.aria-label]="'modals.rcloneConfig.reset.aria' | translate"
          >
            @if (isResetting()) {
              <mat-spinner diameter="16" class="inline-spinner"></mat-spinner>
            } @else {
              <mat-icon svgIcon="rotate-left"></mat-icon>
            }
            {{ 'modals.rcloneConfig.reset.button' | translate }}
          </button>
        </div>
      }
    </div>
  }

  <!-- SETTINGS PAGE: Category Settings Display -->
  @if (currentPage() !== 'home' && !isLoading()) {
    <div class="overlay" animate.enter="slide-overlay-enter" animate.leave="slide-overlay-leave">
      <div class="modal-header" data-tauri-drag-region>
        <button
          mat-icon-button
          (click)="navigateTo('home')"
          [attr.aria-label]="'modals.remoteConfig.buttons.back' | translate"
        >
          <mat-icon svgIcon="chevron-left"></mat-icon>
        </button>
        <p>
          @if (currentPage() === 'home') {
            {{ 'modals.rcloneConfig.pageTitle.home' | translate }}
          } @else if (currentCategory()) {
            {{
              'modals.rcloneConfig.pageTitle.category'
                | translate: { page: currentPage() | uppercase, category: currentCategory() }
            }}
          } @else {
            {{ 'modals.rcloneConfig.pageTitle.backend' | translate }}
          }
        </p>
        <button mat-icon-button (click)="close()" [attr.aria-label]="'common.close' | translate">
          <mat-icon svgIcon="circle-xmark"></mat-icon>
        </button>
      </div>

      <div class="modal-content">
        @if (hasSearchQuery()) {
          <div class="search-results-info">
            <small>{{
              'modals.rcloneConfig.search.showing'
                | translate: { count: filteredOptionsCount(), total: totalOptionsCount() }
            }}</small>
          </div>
        }

        @if (filteredOptionsCount() === 0 && hasSearchQuery()) {
          <div class="empty-state">
            <mat-icon svgIcon="search"></mat-icon>
            <span>{{ 'modals.rcloneConfig.search.emptySettings' | translate }}</span>
            <p>{{ 'modals.rcloneConfig.search.adjustTerms' | translate }}</p>
          </div>
        } @else {
          <!-- VIRTUAL SCROLL IMPLEMENTATION -->
          <cdk-virtual-scroll-viewport [itemSize]="20" class="virtual-scroll-viewport">
            <form [formGroup]="rcloneOptionsForm">
              @for (option of virtualScrollData(); track trackByOptionIndex($index, option)) {
                <app-setting-control
                  [id]="'setting-' + option.Name"
                  [option]="option"
                  [formControlName]="getUniqueControlKey(option)"
                  (valueCommit)="
                    saveRCloneOption(
                      getUniqueControlKey(option),
                      isOptionAtDefault(getUniqueControlKey(option))
                    )
                  "
                  (valueChanged)="onOptionValueChanged(getUniqueControlKey(option), $event)"
                ></app-setting-control>
              }
            </form>
          </cdk-virtual-scroll-viewport>
        }
      </div>
    </div>
  }
</div>
