<div class="log-modal-wrapper">
  <!-- Header Section -->
  <div class="modal-header" data-tauri-drag-region>
    <button [attr.aria-label]="'modals.logs.aria.terminalLogs' | translate">
      <mat-icon svgIcon="terminal"></mat-icon>
    </button>
    <p data-tauri-drag-region>
      {{ 'modals.logs.remoteLogs' | translate: { name: data.remoteName } }}
    </p>
    <button
      (click)="close()"
      matIconButton
      matTooltipPosition="below"
      [attr.aria-label]="'common.close' | translate"
    >
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <!-- Controls Toolbar -->
  <div class="toolbar-section">
    <div class="filter-controls">
      <mat-form-field class="compact">
        <mat-label>{{ 'modals.logs.logLevel' | translate }}</mat-label>
        <mat-select [value]="selectedLevel()" (selectionChange)="selectedLevel.set($event.value)">
          <mat-option value="">{{ 'modals.logs.allLevels' | translate }}</mat-option>
          @for (level of logLevels; track level.value) {
            <mat-option [value]="level.value">{{ level.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-icon matPrefix svgIcon="search"></mat-icon>
        <input
          matInput
          [ngModel]="searchText()"
          (ngModelChange)="searchText.set($event)"
          [placeholder]="'modals.logs.searchPlaceholder' | translate"
        />
        @if (searchText()) {
          <button mat-icon-button matSuffix (click)="searchText.set('')">
            <mat-icon svgIcon="close"></mat-icon>
          </button>
        }
      </mat-form-field>
    </div>

    <div class="action-controls">
      <button
        mat-icon-button
        (click)="clearLogs()"
        [matTooltip]="'modals.logs.clearAll' | translate"
        class="warn-btn"
      >
        <mat-icon svgIcon="trash"></mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="loadLogs()"
        [matTooltip]="'common.refresh' | translate"
        [disabled]="loading()"
      >
        <mat-icon [class.spinning]="loading()" svgIcon="refresh"></mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="scrollToTop()"
        [matTooltip]="'modals.logs.scrollTop' | translate"
      >
        <mat-icon svgIcon="chewron-up"></mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="scrollToBottom()"
        [matTooltip]="'modals.logs.scrollBottom' | translate"
      >
        <mat-icon svgIcon="chewron-down"></mat-icon>
      </button>
    </div>
  </div>

  <!-- Terminal Viewport -->
  <div class="terminal-viewport">
    <!-- Loading Overlay -->
    @if (loading() && logs().length === 0) {
      <div class="empty-state">
        <mat-spinner diameter="40"></mat-spinner>
        <span>{{ 'modals.logs.fetching' | translate }}</span>
      </div>
    }

    <!-- Empty State -->
    @else if (filteredLogs().length === 0) {
      <div class="empty-state" style="color: color-mix(in srgb, white 55%, transparent)">
        <mat-icon svgIcon="search"></mat-icon>
        <span>{{ 'modals.logs.noLogsFound' | translate }}</span>
        <p>{{ 'modals.logs.adjustFilters' | translate }}</p>
      </div>
    }

    <!-- Log Content -->
    @else {
      <div #terminalLogArea class="log-scroller">
        @for (log of filteredLogs(); track getLogId(log)) {
          <div
            class="log-entry"
            [class.expanded]="isExpanded(log)"
            [class.has-context]="!!log.context"
            [class]="log.level"
          >
            <!-- Log Header Line -->
            <div
              class="log-header"
              role="button"
              tabindex="0"
              (click)="log.context ? toggleDetails(log) : null"
              (keydown.enter)="log.context ? toggleDetails(log) : null"
            >
              <span class="timestamp">{{ log.timestamp | date: 'HH:mm:ss.SSS' }}</span>
              <span class="level-tag">{{ log.level | uppercase }}</span>
              <span class="message" [title]="translateLogMessage(log.message)">{{
                translateLogMessage(log.message)
              }}</span>

              <div class="actions-hover">
                <mat-icon
                  svgIcon="copy"
                  (click)="$event.stopPropagation(); copyLog(log)"
                ></mat-icon>
                @if (log.context) {
                  <mat-icon
                    class="expand-icon"
                    svgIcon="caret-down"
                    [style.transform]="isExpanded(log) ? 'rotate(180deg)' : 'rotate(0deg)'"
                  ></mat-icon>
                }
              </div>
            </div>

            <!-- Log Detail Body (Expanded) -->
            @if (isExpanded(log) && log.context) {
              <div class="log-body">
                <!-- 1. Command Output (The one with ANSI colors) -->
                @if (getCommandOutput(log); as output) {
                  <div class="detail-block output">
                    <div class="block-label">{{ 'modals.logs.terminalOutput' | translate }}</div>
                    <div class="code-block terminal-theme" [innerHTML]="output | ansiToHtml"></div>
                  </div>
                }

                <!-- 2. Raw JSON Data -->
                <div class="detail-block json">
                  <div class="block-label">{{ 'modals.logs.logContext' | translate }}</div>
                  <div class="code-block json-theme">
                    <pre>{{ formatContext(log.context) }}</pre>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
</div>
