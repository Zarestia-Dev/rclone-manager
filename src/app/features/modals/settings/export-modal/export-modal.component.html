<div class="export-modal">
  <div class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon svgIcon="export"></mat-icon>
    </button>
    <p>Export Settings</p>
    <button mat-icon-button (click)="close()" aria-label="Close">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Preparing export options...</p>
    </div>
  } @else {
    <div class="modal-content custom-scrollbar">
      <div class="section-group">
        <h3 class="section-label">Select Export Type</h3>

        <mat-radio-group
          [ngModel]="selectedOption()"
          (ngModelChange)="onExportOptionChange($event)"
          class="options-grid"
        >
          @for (option of exportOptions; track option.value) {
            <mat-radio-button
              [value]="option.value"
              class="option-card-radio"
              [class.selected]="selectedOption() === option.value"
            >
              <div class="option-card-content">
                <div class="icon-wrapper">
                  <mat-icon [svgIcon]="option.icon"></mat-icon>
                </div>
                <div class="text-wrapper">
                  <span class="option-label">{{ option.label }}</span>
                  <span class="option-desc">{{ option.description }}</span>
                </div>
              </div>
            </mat-radio-button>
          }
        </mat-radio-group>
      </div>

      <div class="section-group config-section">
        @if (showSpecificRemoteSection()) {
          <div class="form-row">
            <mat-form-field class="full-width">
              <mat-label>Select Remote to Export</mat-label>
              <mat-icon matPrefix svgIcon="hard-drive" class="field-icon"></mat-icon>
              <mat-select
                [ngModel]="selectedRemoteName()"
                (ngModelChange)="onRemoteSelectionChange($event)"
                [disabled]="isExporting()"
                placeholder="Choose a remote..."
              >
                @for (remote of remotes(); track remote) {
                  <mat-option [value]="remote">
                    {{ remote }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        }

        <div class="form-row">
          <mat-form-field class="full-width">
            <mat-label>Destination Folder</mat-label>
            <mat-icon matPrefix svgIcon="folder" class="field-icon"></mat-icon>
            <input
              matInput
              [value]="exportPath()"
              readonly
              placeholder="Select destination..."
              [disabled]="isExporting()"
            />
            <button
              mat-icon-button
              matSuffix
              (click)="selectFolder()"
              [disabled]="isExporting()"
              matTooltip="Browse Folder"
            >
              <mat-icon svgIcon="folder"></mat-icon>
            </button>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field class="full-width">
            <mat-label>Backup Note (Optional)</mat-label>
            <mat-icon matPrefix svgIcon="note-sticky" class="field-icon"></mat-icon>
            <textarea
              matInput
              [ngModel]="userNote()"
              (ngModelChange)="onNoteChange($event)"
              rows="1"
              placeholder="Add a description..."
              [disabled]="isExporting()"
            ></textarea>
          </mat-form-field>
        </div>
      </div>

      <div class="section-group security-section">
        <div class="security-header">
          <mat-slide-toggle
            [ngModel]="withPassword()"
            (ngModelChange)="onPasswordProtectionChange($event)"
            [disabled]="!sevenZipSupported() || isExporting()"
          >
            Encrypt Export
          </mat-slide-toggle>
          @if (!sevenZipSupported()) {
            <span class="security-warning">
              <mat-icon svgIcon="warning" class="warn-icon"></mat-icon>
              7-Zip required
            </span>
          }
        </div>

        @if (showPasswordField()) {
          <div class="password-field-wrapper">
            <mat-form-field class="full-width">
              <mat-label>Encryption Password</mat-label>
              <mat-icon matPrefix svgIcon="lock" class="field-icon"></mat-icon>
              <input
                matInput
                [ngModel]="password()"
                (ngModelChange)="onPasswordChange($event)"
                [type]="showPassword() ? 'text' : 'password'"
                [disabled]="isExporting()"
                placeholder="Enter password"
                autocomplete="new-password"
              />
              <button mat-icon-button matSuffix (click)="togglePasswordVisibility()" type="button">
                <mat-icon [svgIcon]="showPassword() ? 'eye-slash' : 'eye'"></mat-icon>
              </button>
            </mat-form-field>
            <p class="security-hint">
              <mat-icon svgIcon="info"></mat-icon>
              This password will be required to restore the backup.
            </p>
          </div>
        }
      </div>
    </div>

    <div class="modal-actions">
      <button mat-button (click)="close()" [disabled]="isExporting()">Cancel</button>
      <button
        mat-flat-button
        class="primary"
        (click)="onExport()"
        [disabled]="!canExport() || isExporting()"
      >
        @if (isExporting()) {
          <mat-spinner diameter="18" class="button-spinner"></mat-spinner>
          Exporting...
        } @else {
          <ng-container>
            <mat-icon svgIcon="export"></mat-icon>
            Export Now
          </ng-container>
        }
      </button>
    </div>
  }
</div>
