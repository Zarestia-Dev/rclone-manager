<div class="restore-preview-modal">
  <!-- Modal Header -->
  <div class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon svgIcon="box-archive"></mat-icon>
    </button>
    <p>{{ 'backup.restore.title' | translate }}</p>
    <button
      matIconButton
      (click)="close()"
      [attr.aria-label]="'backup.restore.ariaClose' | translate"
    >
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <div class="modal-content">
    <!-- Backup Information Card -->
    <div class="info-card">
      <div class="card-header">
        <mat-icon svgIcon="circle-info" class="card-icon"></mat-icon>
        <h4>{{ 'backup.restore.info' | translate }}</h4>
      </div>

      <div class="info-grid">
        <div class="info-item">
          <div class="info-icon-wrapper">
            <mat-icon svgIcon="calendar" class="info-icon"></mat-icon>
          </div>
          <div class="info-content">
            <span class="label">{{ 'backup.restore.created' | translate }}</span>
            <span class="value">
              @if (analysis.createdAt) {
                {{ analysis.createdAt | date: 'medium' }}
              } @else {
                {{ 'backup.restore.unknown' | translate }}
              }
            </span>
          </div>
        </div>

        <div class="info-item">
          <div class="info-icon-wrapper">
            <mat-icon svgIcon="tag" class="info-icon"></mat-icon>
          </div>
          <div class="info-content">
            <span class="label">{{ 'backup.restore.type' | translate }}</span>
            <span class="value">{{
              analysis.backupType || ('backup.restore.unknown' | translate)
            }}</span>
          </div>
        </div>

        <div class="info-item">
          <div class="info-icon-wrapper">
            <mat-icon svgIcon="file-zipper" class="info-icon"></mat-icon>
          </div>
          <div class="info-content">
            <span class="label">{{ 'backup.restore.format' | translate }}</span>
            <span class="value"
              >{{ analysis.archiveType | uppercase }} Â· v{{ analysis.formatVersion }}</span
            >
          </div>
        </div>

        <div class="info-item">
          <div class="info-icon-wrapper" [class.encrypted]="isEncrypted()">
            <mat-icon [svgIcon]="isEncrypted() ? 'lock' : 'lock-open'" class="info-icon"></mat-icon>
          </div>
          <div class="info-content">
            <span class="label">{{ 'backup.restore.security' | translate }}</span>
            <span class="value" [class.encrypted]="isEncrypted()">
              @if (isEncrypted()) {
                <span class="badge">
                  <mat-icon svgIcon="shield" class="badge-icon"></mat-icon>
                  {{ 'backup.restore.encrypted' | translate }}
                </span>
              } @else {
                <span class="badge badge-default">
                  <mat-icon svgIcon="shield-halved" class="badge-icon"></mat-icon>
                  {{ 'backup.restore.notEncrypted' | translate }}
                </span>
              }
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Legacy Backup Info Banner -->
    @if (isLegacy()) {
      <div class="info-card legacy-banner">
        <div class="banner-content">
          <div class="banner-icon-wrapper">
            <mat-icon svgIcon="clock-rotate-left" class="banner-icon"></mat-icon>
          </div>
          <div class="banner-text">
            <h4 class="banner-title">{{ 'backup.restore.legacy.title' | translate }}</h4>
            <p class="banner-description">{{ 'backup.restore.legacy.description' | translate }}</p>
            <div class="banner-details">
              <mat-icon svgIcon="circle-info" class="detail-icon"></mat-icon>
              <span>{{ 'backup.restore.legacy.defaultProfile' | translate }}</span>
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Contents Card -->
    @if (hasContents()) {
      <div class="info-card contents-card">
        <div class="card-header">
          <mat-icon svgIcon="file-lines" class="card-icon"></mat-icon>
          <h4>{{ 'backup.restore.contents' | translate }}</h4>
          <span class="items-count">{{
            'backup.restore.itemCount' | translate: { count: getItemCount() }
          }}</span>
        </div>

        <div class="contents-list">
          @if (analysis.contents!.settings) {
            <div class="content-item">
              <div class="item-icon-wrapper">
                <mat-icon svgIcon="gear" class="item-icon"></mat-icon>
              </div>
              <div class="item-content">
                <span class="item-title">{{ 'backup.restore.settings.title' | translate }}</span>
                <span class="item-description">{{
                  'backup.restore.settings.description' | translate
                }}</span>
              </div>
              <mat-icon svgIcon="circle-check" class="check-icon accent"></mat-icon>
            </div>
          }

          @if (analysis.contents!.backendConfig) {
            <div class="content-item">
              <div class="item-icon-wrapper">
                <mat-icon svgIcon="server" class="item-icon"></mat-icon>
              </div>
              <div class="item-content">
                <span class="item-title">{{
                  'backup.restore.backendConfig.title' | translate
                }}</span>
                <span class="item-description">{{
                  'backup.restore.backendConfig.description' | translate
                }}</span>
              </div>
              <mat-icon svgIcon="circle-check" class="check-icon accent"></mat-icon>
            </div>
          }

          @if (analysis.contents!.rcloneConfig) {
            <div class="content-item">
              <div class="item-icon-wrapper">
                <mat-icon svgIcon="rclone-symbolic" class="item-icon"></mat-icon>
              </div>
              <div class="item-content">
                <span class="item-title">{{
                  'backup.restore.rcloneConfig.title' | translate
                }}</span>
                <span class="item-description">{{
                  'backup.restore.rcloneConfig.description' | translate
                }}</span>
              </div>
              <mat-icon svgIcon="circle-check" class="check-icon accent"></mat-icon>
            </div>
          }

          @if (analysis.contents!.remoteCount) {
            <div class="content-item">
              <div class="item-icon-wrapper">
                <mat-icon svgIcon="cloud" class="item-icon"></mat-icon>
              </div>
              <div class="item-content">
                <span class="item-title">
                  {{ 'backup.restore.remoteConfigs.title' | translate }}
                  @if (shouldShowRemoteCount()) {
                    <span class="count-badge">{{ analysis.contents!.remoteCount }}</span>
                  }
                </span>
                @if (
                  shouldShowRemoteDetails() &&
                  analysis.contents!.remoteNames &&
                  analysis.contents!.remoteNames.length > 0
                ) {
                  <span class="item-description">{{
                    analysis.contents!.remoteNames.join(', ')
                  }}</span>
                }
              </div>
              <mat-icon svgIcon="circle-check" class="check-icon accent"></mat-icon>
            </div>
          }

          @if (analysis.contents!.profiles && analysis.contents!.profiles.length > 0) {
            <div class="content-item">
              <div class="item-icon-wrapper">
                <mat-icon svgIcon="users" class="item-icon"></mat-icon>
              </div>
              <div class="item-content">
                <span class="item-title">
                  {{ 'backup.restore.profiles.title' | translate }}
                  <span class="count-badge">{{ analysis.contents!.profiles.length }}</span>
                </span>
                <span class="item-description">{{ analysis.contents!.profiles.join(', ') }}</span>
              </div>
              <mat-icon svgIcon="circle-check" class="check-icon accent"></mat-icon>
            </div>
          }
        </div>
      </div>
    }

    <!-- User Note Card -->
    @if (hasUserNote()) {
      <div class="info-card note-card">
        <div class="card-header">
          <mat-icon svgIcon="note-sticky" class="card-icon"></mat-icon>
          <h4>{{ 'backup.restore.note' | translate }}</h4>
        </div>
        <div class="user-note">
          <mat-icon svgIcon="comment" class="quote-icon"></mat-icon>
          <pre [attr.aria-label]="'backup.restore.note' | translate">{{ analysis.userNote }}</pre>
        </div>
      </div>
    }

    <!-- Restore Options Card -->
    @if (profiles().length > 0 && !isLegacy()) {
      <div class="info-card options-card">
        <div class="card-header">
          <mat-icon svgIcon="sliders" class="card-icon"></mat-icon>
          <h4>{{ 'backup.restore.options' | translate }}</h4>
        </div>

        <div class="options-content">
          <div class="form-row">
            <mat-radio-group
              [ngModel]="restoreScope()"
              (change)="toggleRestoreScope($event.value)"
              color="primary"
              class="scope-radio-group"
            >
              <mat-radio-button value="all" class="scope-radio">{{
                'backup.restore.scope.all' | translate
              }}</mat-radio-button>
              <mat-radio-button value="profile" class="scope-radio">{{
                'backup.restore.scope.profile' | translate
              }}</mat-radio-button>
            </mat-radio-group>
          </div>

          @if (restoreScope() === 'profile') {
            <div class="form-row profile-select-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ 'backup.restore.selectProfile' | translate }}</mat-label>
                <mat-select
                  [value]="selectedProfile()"
                  (selectionChange)="selectedProfile.set($event.value)"
                >
                  @for (profile of profiles(); track profile) {
                    <mat-option [value]="profile">{{ profile }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          }
        </div>
      </div>
    }

    <!-- Password Section -->
    @if (isEncrypted()) {
      <div class="info-card password-card">
        <div class="card-header warning">
          <mat-icon svgIcon="lock" class="card-icon"></mat-icon>
          <h4>{{ 'backup.restore.passwordRequired' | translate }}</h4>
        </div>

        <div class="password-content">
          <div class="warning-banner">
            <mat-icon svgIcon="shield-halved" class="warning-icon"></mat-icon>
            <p>{{ 'backup.restore.encryptedWarning' | translate }}</p>
          </div>

          @if (passwordError()) {
            <div class="password-error">
              <mat-icon svgIcon="warning"></mat-icon>
              <span>{{ passwordError() }}</span>
            </div>
          }
          <mat-form-field appearance="fill">
            <mat-label>{{ 'backup.restore.passwordRequired' | translate }}</mat-label>
            <input
              matInput
              [ngModel]="password()"
              (ngModelChange)="onPasswordChange($event)"
              [type]="showPassword() ? 'text' : 'password'"
              [placeholder]="'backup.restore.passwordPlaceholder' | translate"
              [disabled]="isVerifying()"
              (keyup.enter)="verifyAndRestore()"
              autocomplete="current-password"
            />
            <mat-icon matPrefix svgIcon="key"></mat-icon>
            <button
              matIconButton
              matSuffix
              (click)="togglePasswordVisibility()"
              [attr.aria-label]="
                showPassword()
                  ? ('backup.restore.hidePassword' | translate)
                  : ('backup.restore.showPassword' | translate)
              "
              [disabled]="isVerifying()"
            >
              <mat-icon [svgIcon]="showPassword() ? 'eye-slash' : 'eye'"></mat-icon>
            </button>
          </mat-form-field>
        </div>
      </div>
    }
  </div>

  <!-- Modal Actions -->
  <div class="modal-actions">
    <button mat-stroked-button (click)="close()" [disabled]="isVerifying()" class="cancel-btn">
      {{ 'backup.restore.cancel' | translate }}
    </button>

    <button
      mat-flat-button
      class="primary"
      (click)="verifyAndRestore()"
      [disabled]="isVerifying() || (isEncrypted() && !password())"
      class="restore-btn"
    >
      @if (isVerifying()) {
        <mat-spinner diameter="20"></mat-spinner>
        <span>{{ 'backup.restore.verifying' | translate }}</span>
      } @else {
        <span>{{
          isEncrypted()
            ? ('backup.restore.decryptAndRestore' | translate)
            : ('backup.restore.restoreAction' | translate)
        }}</span>
      }
    </button>
  </div>
</div>
