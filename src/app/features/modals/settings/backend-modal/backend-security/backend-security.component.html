<div class="security-container" [formGroup]="securityForm">
  <!-- Status Banner -->
  <div class="status-banner" [class.encrypted]="isConfigEncrypted() === true">
    <div class="status-icon">
      <mat-icon [svgIcon]="isConfigEncrypted() === true ? 'security' : 'shield'"></mat-icon>
    </div>
    <div class="status-text">
      <strong>{{
        (isConfigEncrypted() === true
          ? 'modals.backend.security.encrypted'
          : 'modals.backend.security.notEncrypted'
        ) | translate
      }}</strong>
      <span>{{
        (isConfigEncrypted() === true
          ? 'modals.backend.security.credentialsProtected'
          : 'modals.backend.security.credentialsPlainText'
        ) | translate
      }}</span>
      @if (isConfigEncrypted() === true && hasStoredPassword()) {
        <span class="keyring-status">
          <mat-icon svgIcon="key"></mat-icon>
          {{ 'modals.backend.security.passwordStoredInKeyring' | translate }}
        </span>
      }
    </div>
  </div>

  @if (isConfigEncrypted() === true) {
    <!-- ENCRYPTED STATE -->

    <!-- Keychain Card (Standalone) -->
    <div class="action-card">
      <div class="card-header">
        <mat-icon svgIcon="key"></mat-icon>
        <div class="card-title">
          <strong>{{ 'modals.backend.security.systemKeychain' | translate }}</strong>
          <span>{{ 'modals.backend.security.autoUnlock' | translate }}</span>
        </div>
        <mat-slide-toggle
          [checked]="hasStoredPassword()"
          (change)="onKeychainToggle($event)"
          [disabled]="encryptionLoading()"
        ></mat-slide-toggle>
      </div>

      @if (showKeychainInput()) {
        <div class="card-form">
          <mat-form-field>
            <mat-label>{{ 'modals.backend.security.configPassword' | translate }}</mat-label>
            <input
              matInput
              formControlName="keychainPassword"
              type="password"
              (keyup.enter)="submitKeychainStore()"
            />
            @if (securityForm.get('keychainPassword')?.hasError('required')) {
              <mat-error>
                {{ 'common.required' | translate }}
              </mat-error>
            }
          </mat-form-field>
          <div class="form-actions">
            <button mat-button (click)="cancelKeychainStore()">
              {{ 'common.cancel' | translate }}
            </button>
            <button
              mat-flat-button
              (click)="submitKeychainStore()"
              [disabled]="encryptionLoading() || securityForm.get('keychainPassword')?.invalid"
            >
              {{ 'modals.backend.security.saveToKeychain' | translate }}
            </button>
          </div>
        </div>
      }
    </div>

    <!-- Accordion for Actions -->
    <mat-accordion class="security-accordion" multi="false">
      <!-- Change Password Panel -->
      <mat-expansion-panel (opened)="onPanelOpened()">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-panel-title>
              <mat-icon svgIcon="refresh"></mat-icon>
              <span>{{
                'modals.backend.security.changePassword' | translate
              }}</span></mat-panel-title
            >
            <mat-panel-description>
              <span>{{ 'modals.backend.security.updatePasswordDesc' | translate }}</span>
            </mat-panel-description>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <mat-form-field>
          <mat-label>{{ 'modals.backend.security.currentPassword' | translate }}</mat-label>
          <input
            matInput
            [type]="showSecurityPassword() ? 'text' : 'password'"
            formControlName="currentPassword"
          />
          <button
            mat-icon-button
            matSuffix
            (click)="toggleSecurityPasswordVisibility()"
            type="button"
          >
            <mat-icon [svgIcon]="showSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
          </button>
          @if (securityForm.get('currentPassword')?.hasError('required')) {
            <mat-error>
              {{ 'common.required' | translate }}
            </mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>{{ 'modals.backend.security.newPassword' | translate }}</mat-label>
          <input
            matInput
            [type]="showNewSecurityPassword() ? 'text' : 'password'"
            formControlName="newPassword"
          />
          <button
            mat-icon-button
            matSuffix
            (click)="toggleNewSecurityPasswordVisibility()"
            type="button"
          >
            <mat-icon [svgIcon]="showNewSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
          </button>
          @if (securityForm.get('newPassword')?.hasError('required')) {
            <mat-error>
              {{ 'common.required' | translate }}
            </mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>{{ 'modals.backend.security.confirmNewPassword' | translate }}</mat-label>
          <input
            matInput
            [type]="showNewSecurityPassword() ? 'text' : 'password'"
            formControlName="confirmPassword"
          />
          @if (securityForm.get('confirmPassword')?.hasError('required')) {
            <mat-error>
              {{ 'common.required' | translate }}
            </mat-error>
          }
          @if (
            !securityForm.get('confirmPassword')?.hasError('required') &&
            securityForm.hasError('passwordMismatch')
          ) {
            <mat-error>
              {{ 'modals.backend.security.passwordsMismatch' | translate }}
            </mat-error>
          }
        </mat-form-field>

        <div class="form-actions">
          <button
            mat-flat-button
            (click)="submitChangePassword()"
            [disabled]="encryptionLoading() || isFormInvalidForChangePassword()"
          >
            @if (encryptionLoading()) {
              <mat-spinner diameter="18"></mat-spinner>
            } @else {
              {{ 'modals.backend.security.updatePassword' | translate }}
            }
          </button>
        </div>
      </mat-expansion-panel>

      <!-- Remove Encryption Panel -->
      <mat-expansion-panel (opened)="onPanelOpened()">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-panel-title>
              <mat-icon svgIcon="lock-open"></mat-icon>
              <span>{{
                'modals.backend.security.removeEncryption' | translate
              }}</span></mat-panel-title
            >
            <mat-panel-description>
              <span>{{ 'modals.backend.security.storePlainText' | translate }}</span>
            </mat-panel-description>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <p class="warning-text">
          <mat-icon svgIcon="circle-exclamation"></mat-icon>
          {{ 'modals.backend.security.decryptWarning' | translate }}
        </p>

        <mat-form-field>
          <mat-label>{{ 'modals.backend.security.currentPassword' | translate }}</mat-label>
          <input
            matInput
            [type]="showSecurityPassword() ? 'text' : 'password'"
            formControlName="currentPassword"
          />
          <button
            mat-icon-button
            matSuffix
            (click)="toggleSecurityPasswordVisibility()"
            type="button"
          >
            <mat-icon [svgIcon]="showSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
          </button>
          @if (securityForm.get('currentPassword')?.hasError('required')) {
            <mat-error>
              {{ 'common.required' | translate }}
            </mat-error>
          }
        </mat-form-field>

        <div class="form-actions">
          <button
            mat-flat-button
            class="warn"
            (click)="submitDecrypt()"
            [disabled]="encryptionLoading() || securityForm.get('currentPassword')?.invalid"
          >
            @if (encryptionLoading()) {
              <mat-spinner diameter="18"></mat-spinner>
            } @else {
              {{ 'modals.backend.security.removeEncryption' | translate }}
            }
          </button>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  } @else if (isConfigEncrypted() === false) {
    <!-- UNENCRYPTED STATE -->
    <div class="action-card highlight">
      <div class="card-header">
        <mat-icon svgIcon="lock"></mat-icon>
        <div class="card-title">
          <strong>{{ 'modals.backend.security.enableEncryption' | translate }}</strong>
          <span>{{ 'modals.backend.security.protectCredentials' | translate }}</span>
        </div>
      </div>

      <div class="card-form">
        <mat-form-field>
          <mat-label>{{ 'modals.backend.security.password' | translate }}</mat-label>
          <input
            matInput
            [type]="showNewSecurityPassword() ? 'text' : 'password'"
            formControlName="newPassword"
          />
          <button
            mat-icon-button
            matSuffix
            (click)="toggleNewSecurityPasswordVisibility()"
            type="button"
          >
            <mat-icon [svgIcon]="showNewSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
          </button>
          @if (securityForm.get('newPassword')?.hasError('required')) {
            <mat-error>
              {{ 'common.required' | translate }}
            </mat-error>
          }
        </mat-form-field>

        <mat-form-field>
          <mat-label>{{ 'modals.backend.security.confirmPassword' | translate }}</mat-label>
          <input
            matInput
            [type]="showNewSecurityPassword() ? 'text' : 'password'"
            formControlName="confirmPassword"
          />
          @if (securityForm.get('confirmPassword')?.hasError('required')) {
            <mat-error>
              {{ 'common.required' | translate }}
            </mat-error>
          }
          @if (
            !securityForm.get('confirmPassword')?.hasError('required') &&
            securityForm.hasError('passwordMismatch')
          ) {
            <mat-error>
              {{ 'modals.backend.security.passwordsMismatch' | translate }}
            </mat-error>
          }
        </mat-form-field>

        <div class="form-actions">
          <button
            mat-flat-button
            (click)="submitEncrypt()"
            [disabled]="encryptionLoading() || isFormInvalidForEncrypt()"
          >
            @if (encryptionLoading()) {
              <mat-spinner diameter="18"></mat-spinner>
            } @else {
              {{ 'modals.backend.security.enableEncryption' | translate }}
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
