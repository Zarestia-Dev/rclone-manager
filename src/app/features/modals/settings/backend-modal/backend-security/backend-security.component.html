<div class="security-container" [formGroup]="securityForm">
  <!-- Status Banner -->
  <div class="status-banner" [class.encrypted]="isConfigEncrypted() === true">
    <div class="status-icon">
      <mat-icon [svgIcon]="isConfigEncrypted() === true ? 'shield-halved' : 'shield'"></mat-icon>
    </div>
    <div class="status-text">
      <strong>{{ isConfigEncrypted() === true ? 'Encrypted' : 'Not Encrypted' }}</strong>
      <span>{{
        isConfigEncrypted() === true
          ? 'Your credentials are protected'
          : 'Credentials stored in plain text'
      }}</span>
    </div>
  </div>

  @if (isConfigEncrypted() === true) {
    <!-- ENCRYPTED STATE -->

    <!-- Keychain Card (Standalone) -->
    <div class="action-card">
      <div class="card-header">
        <mat-icon svgIcon="key"></mat-icon>
        <div class="card-title">
          <strong>System Keychain</strong>
          <span>Auto-unlock on startup</span>
        </div>
        <mat-slide-toggle
          color="primary"
          [checked]="hasStoredPassword()"
          (change)="onKeychainToggle($event)"
          [disabled]="encryptionLoading()"
        ></mat-slide-toggle>
      </div>

      @if (showKeychainInput()) {
        <div class="card-form">
          <mat-form-field>
            <mat-label>Config Password</mat-label>
            <input
              matInput
              formControlName="keychainPassword"
              type="password"
              (keyup.enter)="submitKeychainStore()"
            />
          </mat-form-field>
          <div class="form-actions">
            <button mat-button (click)="cancelKeychainStore()">Cancel</button>
            <button
              mat-flat-button
              color="primary"
              (click)="submitKeychainStore()"
              [disabled]="encryptionLoading()"
            >
              Save to Keychain
            </button>
          </div>
        </div>
      }
    </div>

    <!-- Accordion for Actions -->
    <mat-accordion class="security-accordion" multi="false">
      <!-- Change Password Panel -->
      <mat-expansion-panel (opened)="onPanelOpened()" class="action-card">
        <mat-expansion-panel-header>
          <mat-panel-title class="card-header">
            <mat-icon svgIcon="refresh"></mat-icon>
            <div class="card-title">
              <strong>Change Password</strong>
              <span>Update your encryption password</span>
            </div>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="card-form">
          <mat-form-field>
            <mat-label>Current Password</mat-label>
            <input
              matInput
              [type]="showSecurityPassword() ? 'text' : 'password'"
              formControlName="currentPassword"
            />
            <button
              mat-icon-button
              matSuffix
              (click)="toggleSecurityPasswordVisibility()"
              type="button"
            >
              <mat-icon [svgIcon]="showSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field>
            <mat-label>New Password</mat-label>
            <input
              matInput
              [type]="showNewSecurityPassword() ? 'text' : 'password'"
              formControlName="newPassword"
            />
            <button
              mat-icon-button
              matSuffix
              (click)="toggleNewSecurityPasswordVisibility()"
              type="button"
            >
              <mat-icon [svgIcon]="showNewSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field>
            <mat-label>Confirm New Password</mat-label>
            <input
              matInput
              [type]="showNewSecurityPassword() ? 'text' : 'password'"
              formControlName="confirmPassword"
            />
          </mat-form-field>

          <div class="form-actions">
            <button
              mat-flat-button
              color="primary"
              (click)="submitChangePassword()"
              [disabled]="encryptionLoading()"
            >
              @if (encryptionLoading()) {
                <mat-spinner diameter="18"></mat-spinner>
              } @else {
                Update Password
              }
            </button>
          </div>
        </div>
      </mat-expansion-panel>

      <!-- Remove Encryption Panel -->
      <mat-expansion-panel (opened)="onPanelOpened()" class="action-card danger">
        <mat-expansion-panel-header>
          <mat-panel-title class="card-header">
            <mat-icon svgIcon="lock-open"></mat-icon>
            <div class="card-title">
              <strong>Remove Encryption</strong>
              <span>Store credentials in plain text</span>
            </div>
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="card-form">
          <p class="warning-text">
            <mat-icon svgIcon="circle-exclamation"></mat-icon>
            This will decrypt your rclone configuration. Your credentials will be visible to anyone
            with access to your files.
          </p>

          <mat-form-field>
            <mat-label>Current Password</mat-label>
            <input
              matInput
              [type]="showSecurityPassword() ? 'text' : 'password'"
              formControlName="currentPassword"
            />
            <button
              mat-icon-button
              matSuffix
              (click)="toggleSecurityPasswordVisibility()"
              type="button"
            >
              <mat-icon [svgIcon]="showSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
            </button>
          </mat-form-field>

          <div class="form-actions">
            <button
              mat-flat-button
              color="warn"
              (click)="submitDecrypt()"
              [disabled]="encryptionLoading()"
            >
              @if (encryptionLoading()) {
                <mat-spinner diameter="18"></mat-spinner>
              } @else {
                Remove Encryption
              }
            </button>
          </div>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  } @else if (isConfigEncrypted() === false) {
    <!-- UNENCRYPTED STATE -->
    <div class="action-card highlight">
      <div class="card-header">
        <mat-icon svgIcon="lock"></mat-icon>
        <div class="card-title">
          <strong>Enable Encryption</strong>
          <span>Protect your credentials with a password</span>
        </div>
      </div>

      <div class="card-form">
        <mat-form-field>
          <mat-label>Password</mat-label>
          <input
            matInput
            [type]="showNewSecurityPassword() ? 'text' : 'password'"
            formControlName="newPassword"
          />
          <button
            mat-icon-button
            matSuffix
            (click)="toggleNewSecurityPasswordVisibility()"
            type="button"
          >
            <mat-icon [svgIcon]="showNewSecurityPassword() ? 'eye-slash' : 'eye'"></mat-icon>
          </button>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Confirm Password</mat-label>
          <input
            matInput
            [type]="showNewSecurityPassword() ? 'text' : 'password'"
            formControlName="confirmPassword"
          />
        </mat-form-field>

        <div class="form-actions">
          <button
            mat-flat-button
            color="primary"
            (click)="submitEncrypt()"
            [disabled]="encryptionLoading()"
          >
            @if (encryptionLoading()) {
              <mat-spinner diameter="18"></mat-spinner>
            } @else {
              Enable Encryption
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
