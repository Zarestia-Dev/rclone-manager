<div class="modal">
  <div class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon svgIcon="server"></mat-icon>
    </button>
    <p>{{ 'modals.backend.title' | translate }}</p>
    <button mat-icon-button (click)="close()" [attr.aria-label]="'common.close' | translate">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <div class="modal-content">
    @if (isLoading()) {
      <div class="loading-overlay">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

    <!-- Backend List -->
    @if (formState().mode === null) {
      <div class="backends-list">
        @for (backend of backends(); track backend.name) {
          <div
            class="backend-card"
            [class.active]="backend.isActive"
            [class.switching]="switchingTo() === backend.name"
            (click)="!backend.isActive && switchToBackend(backend.name)"
            (keydown.enter)="!backend.isActive && switchToBackend(backend.name)"
            tabindex="0"
            [attr.aria-label]="'modals.backend.switchTitle' | translate: { name: backend.name }"
          >
            <!-- Backend Icon with Status -->
            <div
              class="backend-icon"
              [class.local]="backend.isLocal"
              [class]="getStatusClass(backend)"
              [matTooltip]="getStatusTooltip(backend)"
            >
              <mat-icon [svgIcon]="getBackendIcon(backend)"></mat-icon>
              <span class="status-dot" [class]="getStatusClass(backend)"></span>
            </div>

            <!-- Backend Info -->
            <div class="backend-info">
              <div class="backend-title">
                <span class="name">{{ backend.name }}</span>
                @if (backend.isActive) {
                  <span class="badge active">{{ 'modals.backend.active' | translate }}</span>
                }
              </div>
              <div class="backend-subtitle">
                <span class="address">{{ backend.host }}:{{ backend.port }}</span>
                @if (backend.version) {
                  <span class="separator">•</span>
                  <span class="version">{{ backend.version }}</span>
                }
                @if (backend.os) {
                  <span class="separator">•</span>
                  <span class="os">{{ backend.os }}</span>
                }
                @if (backend.runtimeConfigPath) {
                  <span class="separator">•</span>
                  <mat-icon
                    svgIcon="file-lines"
                    [matTooltip]="
                      ('modals.backend.activeConfigPath' | translate) +
                      ': ' +
                      backend.runtimeConfigPath
                    "
                  ></mat-icon>
                }
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="backend-actions">
              <button
                mat-icon-button
                (click)="$event.stopPropagation(); startEdit(backend)"
                [matTooltip]="'modals.backend.editBackend' | translate"
                [attr.aria-label]="'modals.backend.editBackend' | translate"
              >
                <mat-icon svgIcon="pen"></mat-icon>
              </button>

              <button
                mat-icon-button
                (click)="$event.stopPropagation(); testBackend(backend.name)"
                [disabled]="testingBackend() !== null"
                [matTooltip]="'modals.backend.testConnection' | translate"
                [attr.aria-label]="'modals.backend.testConnection' | translate"
              >
                @if (testingBackend() === backend.name) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  <mat-icon svgIcon="bolt"></mat-icon>
                }
              </button>

              @if (backend.name !== 'Local') {
                <button
                  mat-icon-button
                  class="warn"
                  (click)="$event.stopPropagation(); removeBackend(backend.name)"
                  [disabled]="backend.isActive"
                  [matTooltip]="
                    backend.isActive
                      ? ('modals.backend.switchFirst' | translate)
                      : ('modals.backend.removeTooltip' | translate)
                  "
                >
                  <mat-icon svgIcon="trash"></mat-icon>
                </button>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Add/Edit Form -->
    @if (formState().mode !== null) {
      <form [formGroup]="backendForm" (ngSubmit)="saveBackend()">
        <mat-tab-group>
          <!-- Tab 1: Connection Settings -->
          <mat-tab [label]="'modals.backend.connectionTab' | translate">
            <div class="tab-content">
              <!-- Header Section: Copy Options & Name -->
              @if (formState().editingName !== 'Local') {
                @if (formState().mode === 'add') {
                  <div class="copy-options-section">
                    <mat-expansion-panel>
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon svgIcon="copy"></mat-icon>
                          <span>{{ 'modals.backend.copyOptions.title' | translate }}</span>
                        </mat-panel-title>
                        <mat-panel-description>{{
                          'modals.backend.copyOptions.description' | translate
                        }}</mat-panel-description>
                      </mat-expansion-panel-header>

                      <div class="copy-panel-content">
                        <div class="copy-selects">
                          <mat-form-field appearance="fill" subscriptSizing="dynamic">
                            <mat-label>{{
                              'modals.backend.copyOptions.backendConfig' | translate
                            }}</mat-label>
                            <mat-icon matPrefix svgIcon="file-lines"></mat-icon>
                            <mat-select [(value)]="copyBackendFrom">
                              <mat-option value="none">{{
                                'modals.backend.copyOptions.fromZero' | translate
                              }}</mat-option>
                              @for (backend of backends(); track backend.name) {
                                <mat-option [value]="backend.name">
                                  {{ backend.name }}
                                  @if (backend.isLocal) {
                                    <span class="badge">{{
                                      'modals.backend.local' | translate
                                    }}</span>
                                  }
                                </mat-option>
                              }
                            </mat-select>
                          </mat-form-field>
                          <mat-form-field appearance="fill" subscriptSizing="dynamic">
                            <mat-label>{{
                              'modals.backend.copyOptions.remotesConfig' | translate
                            }}</mat-label>
                            <mat-icon matPrefix svgIcon="cloud"></mat-icon>
                            <mat-select [(value)]="copyRemotesFrom">
                              <mat-option value="none">{{
                                'modals.backend.copyOptions.fromZero' | translate
                              }}</mat-option>
                              @for (backend of backends(); track backend.name) {
                                <mat-option [value]="backend.name">
                                  {{ backend.name }}
                                  @if (backend.isLocal) {
                                    <span class="badge">{{
                                      'modals.backend.local' | translate
                                    }}</span>
                                  }
                                </mat-option>
                              }
                            </mat-select>
                          </mat-form-field>
                        </div>
                      </div>
                    </mat-expansion-panel>
                  </div>
                }

                <mat-form-field appearance="fill">
                  <mat-label>{{ 'modals.backend.name' | translate }}</mat-label>
                  <mat-icon matPrefix svgIcon="tag"></mat-icon>
                  <input matInput formControlName="name" />
                  @if (hasDuplicateName()) {
                    <mat-error>{{ 'modals.backend.nameExists' | translate }}</mat-error>
                  }
                </mat-form-field>
              }

              <!-- Dynamic Groups Loop -->
              @for (group of fieldGroups(); track group.name) {
                <!-- Connection & Advanced Row -->
                @if (group.name === 'connection' || group.name === 'advanced') {
                  <div class="form-row wrap">
                    @for (field of group.fields; track field.key) {
                      <ng-container
                        *ngTemplateOutlet="
                          fieldTemplate;
                          context: { field: field, group: group.name, form: backendForm }
                        "
                      ></ng-container>
                    }
                  </div>
                }
                <!-- Authentication Panel -->
                @else if (group.name === 'authentication') {
                  <div class="auth-group">
                    <mat-expansion-panel
                      [expanded]="backendForm.get('has_auth')?.value"
                      (opened)="setAuthStatus(true)"
                      (closed)="setAuthStatus(false)"
                      hideToggle="true"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title
                          ><mat-icon svgIcon="key"></mat-icon>
                          {{ 'modals.backend.enableAuth' | translate }}</mat-panel-title
                        >
                        <mat-panel-description>
                          <mat-slide-toggle
                            [checked]="backendForm.get('has_auth')?.value"
                            (change)="setAuthStatus($event.checked)"
                            (click)="$event.stopPropagation()"
                          ></mat-slide-toggle>
                        </mat-panel-description>
                      </mat-expansion-panel-header>
                      <div class="auth-fields">
                        @for (field of group.fields; track field.key) {
                          <ng-container
                            *ngTemplateOutlet="
                              fieldTemplate;
                              context: { field: field, group: group.name, form: backendForm }
                            "
                          ></ng-container>
                        }
                      </div>
                    </mat-expansion-panel>
                  </div>
                }
                <!-- OAuth Group -->
                @else if (group.name === 'oauth' && formState().editingName === 'Local') {
                  <div class="oauth-group">
                    <h4>{{ 'modals.backend.oauthSettings' | translate }}</h4>
                    <div class="form-row">
                      @for (field of group.fields; track field.key) {
                        <ng-container
                          *ngTemplateOutlet="
                            fieldTemplate;
                            context: { field: field, group: group.name, form: backendForm }
                          "
                        ></ng-container>
                      }
                    </div>
                  </div>
                }
              }
            </div>
          </mat-tab>

          <!-- Tab 2: Security -->
          <mat-tab [label]="'modals.backend.securityTab' | translate">
            <div class="tab-content">
              @if (formState().editingName === 'Local') {
                <app-backend-security></app-backend-security>
              } @else {
                <!-- Remote Security Fields -->
                @for (group of fieldGroups(); track group.name) {
                  @if (group.name === 'security') {
                    @for (field of group.fields; track field.key) {
                      <ng-container
                        *ngTemplateOutlet="
                          fieldTemplate;
                          context: { field: field, group: group.name, form: backendForm }
                        "
                      ></ng-container>
                    }
                  }
                }

                <div class="info-card">
                  <mat-icon svgIcon="circle-info"></mat-icon>
                  <p>{{ 'modals.backend.remoteSecurity.limitation' | translate }}</p>
                </div>

                @if (formState().mode === 'edit') {
                  <div
                    class="status-banner"
                    [class.encrypted]="hasConfigPassword()"
                    [class.unencrypted]="!hasConfigPassword()"
                  >
                    <div class="status-icon">
                      <mat-icon
                        [svgIcon]="hasConfigPassword() ? 'shield-halved' : 'shield'"
                      ></mat-icon>
                    </div>
                    <div class="status-text">
                      <strong>{{
                        (hasConfigPassword()
                          ? 'modals.backend.remoteSecurity.passwordStored'
                          : 'modals.backend.remoteSecurity.noPasswordStored'
                        ) | translate
                      }}</strong>
                    </div>
                  </div>

                  <div class="actions">
                    <button
                      mat-flat-button
                      class="warn"
                      (click)="removeConfigPassword()"
                      [disabled]="!hasConfigPassword() || formState().isLoading"
                    >
                      @if (formState().isLoading) {
                        <mat-spinner diameter="18"></mat-spinner>
                      } @else {
                        {{ 'modals.backend.remoteSecurity.removePassword' | translate }}
                      }
                    </button>
                  </div>
                }
              }
            </div>
          </mat-tab>
        </mat-tab-group>
        <!-- Shared Field Template (Inside form to preserve injection context) -->
        <ng-template #fieldTemplate let-field="field" let-group="group" let-form="form">
          <div [formGroup]="form" [ngClass]="getFieldClasses(field, group)">
            @if (
              field.meta.metadata['input_type'] === 'password' || field.key === 'config_password'
            ) {
              <mat-form-field appearance="fill">
                @if (getFieldIcon(field.key)) {
                  <mat-icon matPrefix [svgIcon]="getFieldIcon(field.key) || ''"></mat-icon>
                }
                <mat-label>{{ field.meta.metadata['label'] || field.key }}</mat-label>
                <input
                  matInput
                  [type]="isPasswordVisible(field.key) ? 'text' : 'password'"
                  [formControlName]="field.key"
                  [placeholder]="field.meta.metadata['placeholder'] || ''"
                />
                <button
                  mat-icon-button
                  matSuffix
                  (click)="toggleFieldPassword(field.key)"
                  type="button"
                >
                  <mat-icon
                    [svgIcon]="isPasswordVisible(field.key) ? 'eye-slash' : 'eye'"
                  ></mat-icon>
                </button>
                @if (backendForm.get(field.key)?.hasError('required')) {
                  <mat-error>{{ 'common.required' | translate }}</mat-error>
                }
              </mat-form-field>
            } @else if (field.meta.metadata['input_type'] === 'file_path') {
              <mat-form-field class="full-width" appearance="fill">
                <mat-label>{{ field.meta.metadata['label'] || field.key }}</mat-label>
                <mat-icon
                  matPrefix
                  svgIcon="file-lines"
                  [class.primary]="getEditingBackendRuntimePath()"
                  [matTooltip]="
                    getEditingBackendRuntimePath()
                      ? ('modals.backend.activeConfigPath' | translate) +
                        ': ' +
                        getEditingBackendRuntimePath()
                      : ''
                  "
                ></mat-icon>
                <input
                  matInput
                  [formControlName]="field.key"
                  [placeholder]="field.meta.metadata['placeholder'] || ''"
                />
                <button
                  mat-icon-button
                  matSuffix
                  (click)="selectConfigFile()"
                  type="button"
                  [disabled]="!isConfigSelectionAllowed()"
                  [matTooltip]="
                    isConfigSelectionAllowed()
                      ? ('modals.backend.selectConfigFile' | translate)
                      : ('modals.backend.notifications.onlyActiveBackend' | translate)
                  "
                >
                  <mat-icon svgIcon="file"></mat-icon>
                </button>
                @if (field.meta.metadata['description']) {
                  <mat-hint>{{ field.meta.metadata['description'] }}</mat-hint>
                }
              </mat-form-field>
            } @else {
              <mat-form-field appearance="fill">
                <mat-label>{{ field.meta.metadata['label'] || field.key }}</mat-label>
                @if (getFieldIcon(field.key)) {
                  <mat-icon matPrefix [svgIcon]="getFieldIcon(field.key) || ''"></mat-icon>
                }
                <input
                  matInput
                  [type]="field.meta.metadata['input_type'] === 'number' ? 'number' : 'text'"
                  [formControlName]="field.key"
                  [placeholder]="field.meta.metadata['placeholder'] || ''"
                />
                @if (field.key === 'host' && hasDuplicateHost()) {
                  <mat-error>{{ 'modals.backend.hostExists' | translate }}</mat-error>
                }
                @if (field.meta.metadata['description']) {
                  <mat-hint>{{ field.meta.metadata['description'] }}</mat-hint>
                }
              </mat-form-field>
            }
          </div>
        </ng-template>
      </form>
    }
  </div>

  <div class="modal-footer">
    @if (formState().mode === null) {
      <button mat-flat-button class="primary" (click)="toggleAddForm()">
        <mat-icon svgIcon="plus"></mat-icon>
        {{ 'modals.backend.addBackend' | translate }}
      </button>
    }
    @if (formState().mode !== null) {
      <button mat-stroked-button (click)="cancelEdit()">{{ 'common.cancel' | translate }}</button>
      <button
        mat-flat-button
        class="primary"
        [disabled]="backendForm.invalid || hasDuplicateName() || hasDuplicateHost()"
        (click)="saveBackend()"
      >
        {{ 'modals.backend.save' | translate }}
      </button>
    }
  </div>
</div>
