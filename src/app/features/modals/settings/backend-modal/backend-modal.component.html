<div class="modal">
  <div class="modal-header" data-tauri-drag-region>
    <button>
      <mat-icon svgIcon="server"></mat-icon>
    </button>
    <p>Backend Management</p>
    <button mat-icon-button (click)="close()" aria-label="Close">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <div class="modal-content">
    @if (isLoading()) {
      <div class="loading-overlay">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

    <!-- Backend List -->
    @if (formState().mode === 'closed') {
      <div class="backends-list">
        @for (backend of backends(); track backend.name) {
          <div
            class="backend-card"
            [class.active]="backend.is_active"
            [class.switching]="switchingTo() === backend.name"
            (click)="!backend.is_active && switchToBackend(backend.name)"
            (keydown.enter)="!backend.is_active && switchToBackend(backend.name)"
            tabindex="0"
            [attr.aria-label]="'Switch to ' + backend.name"
          >
            <!-- Backend Icon with Status -->
            <div
              class="backend-icon"
              [class.local]="backend.is_local"
              [class]="getStatusClass(backend)"
              [matTooltip]="getStatusTooltip(backend)"
            >
              <mat-icon [svgIcon]="getBackendIcon(backend)"></mat-icon>
              <span class="status-dot" [class]="getStatusClass(backend)"></span>
            </div>

            <!-- Backend Info -->
            <div class="backend-info">
              <div class="backend-title">
                <span class="name">{{ backend.name }}</span>
                @if (backend.is_active) {
                  <span class="badge active">Active</span>
                }
              </div>
              <div class="backend-subtitle">
                <span class="address">{{ backend.host }}:{{ backend.port }}</span>
                @if (backend.version) {
                  <span class="separator">•</span>
                  <span class="version">{{ backend.version }}</span>
                }
                @if (backend.os) {
                  <span class="separator">•</span>
                  <span class="os">{{ backend.os }}</span>
                }
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="backend-actions">
              <button
                mat-icon-button
                (click)="$event.stopPropagation(); startEdit(backend)"
                matTooltip="Edit"
              >
                <mat-icon svgIcon="pen"></mat-icon>
              </button>

              <button
                mat-icon-button
                (click)="$event.stopPropagation(); testBackend(backend.name)"
                [disabled]="testingBackend() !== null"
                matTooltip="Test Connection"
              >
                @if (testingBackend() === backend.name) {
                  <mat-spinner diameter="18"></mat-spinner>
                } @else {
                  <mat-icon svgIcon="bolt"></mat-icon>
                }
              </button>

              @if (backend.name !== 'Local') {
                <button
                  mat-icon-button
                  class="warn"
                  (click)="$event.stopPropagation(); removeBackend(backend.name)"
                  [disabled]="backend.is_active"
                  [matTooltip]="backend.is_active ? 'Switch to another backend first' : 'Remove'"
                >
                  <mat-icon svgIcon="trash"></mat-icon>
                </button>
              }
            </div>
          </div>
        }
      </div>
    }

    <!-- Add/Edit Form -->
    @if (formState().mode !== 'closed') {
      <div class="form-header">
        <h3>{{ formState().mode === 'edit' ? 'Edit' : 'Add' }} Backend</h3>
      </div>

      <form [formGroup]="backendForm" (ngSubmit)="saveBackend()">
        <!-- Tabbed Interface for Local Backend -->
        @if (formState().editingName === 'Local') {
          <mat-tab-group animationDuration="0ms" class="local-backend-tabs">
            <!-- Tab 1: Connection & OAuth -->
            <mat-tab label="Connection">
              <div class="tab-content">
                <div class="form-row">
                  <mat-form-field class="host-field" appearance="fill">
                    <mat-label>Host</mat-label>
                    <mat-icon matPrefix svgIcon="globe"></mat-icon>
                    <input matInput formControlName="host" />
                  </mat-form-field>

                  <mat-form-field class="port-field" appearance="fill">
                    <mat-label>Port</mat-label>
                    <input matInput type="number" formControlName="port" />
                  </mat-form-field>
                </div>

                <div class="auth-group">
                  <mat-checkbox formControlName="has_auth">Enable Authentication</mat-checkbox>
                  @if (backendForm.get('has_auth')?.value) {
                    <div class="auth-fields">
                      <mat-form-field appearance="fill">
                        <mat-label>Username</mat-label>
                        <input matInput formControlName="username" />
                      </mat-form-field>
                      <mat-form-field appearance="fill">
                        <mat-label>Password</mat-label>
                        <input
                          matInput
                          [type]="showPassword() ? 'text' : 'password'"
                          formControlName="password"
                        />
                        <button
                          mat-icon-button
                          matSuffix
                          (click)="togglePasswordVisibility()"
                          type="button"
                        >
                          <mat-icon [svgIcon]="showPassword() ? 'eye-slash' : 'eye'"></mat-icon>
                        </button>
                      </mat-form-field>
                    </div>
                  }
                </div>

                <div class="oauth-group">
                  <h4>OAuth Settings</h4>
                  <div class="form-row">
                    <mat-form-field class="host-field" appearance="fill">
                      <mat-label>OAuth Host</mat-label>
                      <input matInput formControlName="oauth_host" />
                    </mat-form-field>

                    <mat-form-field class="port-field" appearance="fill">
                      <mat-label>OAuth Port</mat-label>
                      <input matInput type="number" formControlName="oauth_port" />
                    </mat-form-field>
                  </div>
                </div>
              </div>
            </mat-tab>

            <mat-tab label="Security">
              <div class="tab-content security-tab">
                <app-backend-security></app-backend-security>
              </div>
            </mat-tab>
          </mat-tab-group>
        } @else {
          <!-- Standard Form for Remote Backends -->
          <mat-form-field appearance="fill">
            <mat-label>Name</mat-label>
            <mat-icon matPrefix svgIcon="tag"></mat-icon>
            <input matInput formControlName="name" />
            @if (hasDuplicateName()) {
              <mat-error>Name exists</mat-error>
            }
          </mat-form-field>

          <div class="form-row">
            <mat-form-field class="host-field" appearance="fill">
              <mat-label>Host</mat-label>
              <mat-icon matPrefix svgIcon="globe"></mat-icon>
              <input matInput formControlName="host" />
            </mat-form-field>

            <mat-form-field class="port-field" appearance="fill">
              <mat-label>Port</mat-label>
              <input matInput type="number" formControlName="port" />
            </mat-form-field>
          </div>

          <div class="auth-group">
            <mat-checkbox formControlName="has_auth">Enable Authentication</mat-checkbox>
            @if (backendForm.get('has_auth')?.value) {
              <div class="auth-fields">
                <mat-form-field appearance="fill">
                  <mat-label>Username</mat-label>
                  <input matInput formControlName="username" />
                </mat-form-field>
                <mat-form-field appearance="fill">
                  <mat-label>Password</mat-label>
                  <input
                    matInput
                    [type]="showPassword() ? 'text' : 'password'"
                    formControlName="password"
                  />
                  <button
                    mat-icon-button
                    matSuffix
                    (click)="togglePasswordVisibility()"
                    type="button"
                  >
                    <mat-icon [svgIcon]="showPassword() ? 'eye-slash' : 'eye'"></mat-icon>
                  </button>
                </mat-form-field>
              </div>
            }
          </div>

          <mat-form-field appearance="fill">
            <mat-label>Config Password (Optional)</mat-label>
            <input
              matInput
              [type]="showConfigPassword() ? 'text' : 'password'"
              formControlName="config_password"
            />
            <button
              mat-icon-button
              matSuffix
              (click)="toggleConfigPasswordVisibility()"
              type="button"
            >
              <mat-icon [svgIcon]="showConfigPassword() ? 'eye-slash' : 'eye'"></mat-icon>
            </button>
          </mat-form-field>
        }
      </form>
    }
  </div>

  <div class="modal-footer">
    @if (formState().mode === 'closed') {
      <button mat-flat-button class="primary" (click)="toggleAddForm()">
        <mat-icon svgIcon="plus"></mat-icon>
        Add Backend
      </button>
    }
    @if (formState().mode !== 'closed') {
      <button mat-button (click)="cancelEdit()">Cancel</button>
      <button
        mat-flat-button
        class="primary"
        [disabled]="backendForm.invalid || hasDuplicateName() || hasDuplicateHost()"
        (click)="saveBackend()"
      >
        Save
      </button>
    }
  </div>
</div>
