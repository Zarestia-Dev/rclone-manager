<div class="modal">
  <div class="modal-header" data-tauri-drag-region>
    <button
      matIconButton
      (click)="toggleSearch()"
      [attr.aria-label]="
        searchVisible
          ? ('modals.preferences.hideSearch' | translate)
          : ('modals.preferences.showSearch' | translate)
      "
      [class.active]="searchVisible"
    >
      <mat-icon svgIcon="search"></mat-icon>
    </button>

    @if (bottomTabs) {
      <p class="modal-title">{{ 'modals.preferences.title' | translate }}</p>
    } @else {
      @if (!hasSearchResults) {
        <div class="tabs desktop-tabs" data-tauri-drag-region role="tablist">
          @for (tab of filteredTabs; track tab.key; let i = $index) {
            <button
              (click)="selectTab(i)"
              [class.selected]="selectedTabIndex === i"
              [attr.aria-selected]="selectedTabIndex === i"
              [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
              role="tab"
            >
              <mat-icon [svgIcon]="tab.icon"></mat-icon>
              <span class="tab-label">{{ 'modals.preferences.tabs.' + tab.key | translate }}</span>
            </button>
          }
        </div>
      } @else {
        <h2 class="modal-title search-title">
          {{ 'modals.preferences.searchResults' | translate }}
        </h2>
      }
    }

    <button matIconButton (click)="close()" [aria-label]="'common.close' | translate">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <app-search-container
    [visible]="searchVisible"
    [searchText]="searchQuery"
    (searchTextChange)="onSearchTextChange($event)"
    [placeholder]="'modals.preferences.searchPlaceholder' | translate"
    [ariaLabel]="'modals.preferences.searchPlaceholder' | translate"
  ></app-search-container>

  @if (isLoading) {
    <div class="loading-overlay">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

  @if (!isLoading) {
    <main class="modal-content">
      <div class="tab-content">
        <div class="settings-list" role="list">
          @if (hasSearchResults) {
            @for (result of searchResults; track result.category + '.' + result.key) {
              <div
                class="setting-item"
                role="listitem"
                [class.layout-row]="
                  getMetadata(result.category, result.key).value_type === 'bool' ||
                  getMetadata(result.category, result.key).value_type === 'int'
                "
              >
                <ng-container
                  [ngTemplateOutlet]="settingTemplate"
                  [ngTemplateOutletContext]="{
                    category: result.category,
                    key: result.key,
                    showCategory: true,
                  }"
                ></ng-container>
              </div>
            }
          }

          @if (!searchQuery) {
            @for (category of getObjectKeys(settingsForm.controls); track category) {
              @if (selectedTabKey === category) {
                <div class="tab-content" role="tabpanel">
                  <div class="settings-list" role="list">
                    @for (key of getObjectKeys(settingsForm.get(category)?.value); track key) {
                      <div
                        class="setting-item"
                        role="listitem"
                        [class.layout-row]="
                          getMetadata(category, key).value_type === 'bool' ||
                          getMetadata(category, key).value_type === 'int'
                        "
                      >
                        <ng-container
                          [ngTemplateOutlet]="settingTemplate"
                          [ngTemplateOutletContext]="{
                            category: category,
                            key: key,
                            showCategory: false,
                          }"
                        ></ng-container>
                      </div>
                    }
                    @if (isGeneralTab) {
                      <div class="actions">
                        <button
                          mat-raised-button
                          class="warn"
                          (click)="resetSettings()"
                          [attr.aria-label]="'modals.preferences.aria.resetAll' | translate"
                        >
                          <mat-icon svgIcon="rotate-left"></mat-icon>
                          {{ 'modals.preferences.resetAll' | translate }}
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          }

          @if (hasEmptySearchResults) {
            <div class="empty-state" role="status" aria-live="polite">
              <mat-icon svgIcon="search"></mat-icon>
              <p>
                {{ 'modals.preferences.noSettingsFound' | translate }}
                <strong>"{{ searchQuery }}"</strong>
              </p>
              <div class="search-suggestions">
                <small>{{ 'modals.preferences.trySearching' | translate }}</small>
                <div class="suggestion-chips">
                  @for (suggestion of searchSuggestions; track suggestion) {
                    <button
                      class="chip"
                      (click)="onSearchTextChange(suggestion)"
                      [attr.aria-label]="
                        'modals.preferences.aria.searchFor' | translate: { suggestion: suggestion }
                      "
                    >
                      {{ suggestion }}
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>

      @if (hasPendingRestartChanges) {
        <div class="pending-changes-section">
          <div class="pending-changes-header">
            <div class="header-info">
              <mat-icon svgIcon="circle-exclamation" class="warn"></mat-icon>
              <div class="header-text">
                <h3>{{ 'modals.preferences.restartRequiredHeader' | translate }}</h3>
                <p>{{ 'modals.preferences.restartRequiredDesc' | translate }}</p>
              </div>
            </div>
          </div>
          <div class="pending-changes-list">
            @for (change of getPendingChangesList(); track change.category + '.' + change.key) {
              <div class="pending-change-item">
                <div class="change-info">
                  <strong>{{ change.displayName }}</strong>
                  <span class="change-category">{{ getCategoryDisplayName(change.category) }}</span>
                </div>
                <div class="change-value">
                  @if (change.value === true || change.value === false) {
                    <span class="boolean-value" [class.enabled]="change.value">
                      {{
                        change.value
                          ? ('modals.preferences.enabled' | translate)
                          : ('modals.preferences.disabled' | translate)
                      }}
                    </span>
                  } @else if (isArray(change.value)) {
                    <span class="array-value"
                      >{{ asArray(change.value).length }}
                      {{ 'modals.preferences.items' | translate }}</span
                    >
                  } @else {
                    <span class="text-value">{{ change.value }}</span>
                  }
                </div>
              </div>
            }
          </div>
          <div class="pending-changes-actions">
            <button
              matButton
              (click)="discardPendingChanges()"
              [disabled]="isDiscardingChanges"
              [attr.aria-label]="'modals.preferences.aria.discardChanges' | translate"
            >
              @if (isDiscardingChanges) {
                <mat-spinner diameter="16" class="inline-spinner"></mat-spinner>
              }
              @if (!isDiscardingChanges) {
                <mat-icon svgIcon="close"></mat-icon>
              }
              {{
                isDiscardingChanges
                  ? ('modals.preferences.discarding' | translate)
                  : ('modals.preferences.discardChanges' | translate)
              }}
            </button>
            <button
              mat-raised-button
              class="warn"
              (click)="savePendingChanges()"
              [attr.aria-label]="'modals.preferences.aria.saveAndRestart' | translate"
            >
              <mat-icon svgIcon="rotate-left"></mat-icon>
              {{ 'modals.preferences.saveAndRestart' | translate }}
            </button>
          </div>
        </div>
      }
    </main>
  }

  @if (bottomTabs && !hasSearchResults) {
    <div
      class="tabs bottom-tabs"
      role="tablist"
      [attr.aria-label]="'modals.preferences.aria.settingsCategories' | translate"
    >
      @for (tab of filteredTabs; track tab.key; let i = $index) {
        <button
          (click)="selectTab(i)"
          [class.selected]="selectedTabIndex === i"
          [attr.aria-selected]="selectedTabIndex === i"
          [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
          role="tab"
          [attr.aria-controls]="'tab-panel-' + tab.key"
        >
          <mat-icon [svgIcon]="tab.icon"></mat-icon>
          <span class="tab-label">{{ 'modals.preferences.tabs.' + tab.key | translate }}</span>
        </button>
      }
    </div>
  }

  <ng-template
    #settingTemplate
    let-category="category"
    let-key="key"
    let-showCategory="showCategory"
  >
    @if (getMetadata(category, key); as meta) {
      <div class="setting-item-header">
        <div class="setting-info">
          <strong>{{ getSettingLabel(category, key, meta) }}</strong>
          <p>{{ getSettingDescription(category, key, meta) }}</p>
          @if (showCategory) {
            <small class="setting-category">{{ getCategoryDisplayName(category) }}</small>
          }
        </div>
        @if (isModified(category, key)) {
          <button
            mat-icon-button
            class="reset-btn"
            (click)="resetSetting(category, key)"
            [attr.aria-label]="
              ('modals.preferences.resetToDefault' | translate) + ': ' + meta.display_name
            "
            [matTooltip]="'modals.preferences.resetToDefault' | translate"
            matTooltipPosition="above"
          >
            <mat-icon svgIcon="rotate-left"></mat-icon>
          </button>
        }
      </div>

      <div class="setting-control">
        <div class="control-with-reset">
          <div class="control-field">
            @switch (meta.value_type) {
              @case ('bool') {
                <mat-slide-toggle
                  [formControl]="$any(getFormControl(category, key))"
                  (change)="onValueChange(category, key)"
                >
                </mat-slide-toggle>
              }
              @case ('int') {
                <div class="stepper">
                  <button
                    mat-icon-button
                    class="stepper-btn"
                    (mousedown)="startHold('decrement', meta.step || 1, category, key, meta)"
                    (touchstart.prevent)="
                      startHold('decrement', meta.step || 1, category, key, meta)
                    "
                    (mouseup)="stopHold()"
                    (mouseleave)="stopHold()"
                    (touchend)="stopHold()"
                    [disabled]="
                      (+getFormControl(category, key).value || 0) <= (meta.min_value ?? 0)
                    "
                  >
                    <mat-icon svgIcon="remove"></mat-icon>
                  </button>
                  <mat-form-field appearance="fill" class="number-input">
                    <input
                      matInput
                      type="number"
                      [formControl]="$any(getFormControl(category, key))"
                      (keydown)="onIntegerInput($event)"
                      (blur)="onBlur(category, key)"
                      [attr.aria-label]="meta.display_name"
                    />
                    @if (
                      getFormControl(category, key).invalid && getFormControl(category, key).touched
                    ) {
                      <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                    }
                  </mat-form-field>
                  <button
                    mat-icon-button
                    class="stepper-btn"
                    (mousedown)="startHold('increment', meta.step || 1, category, key, meta)"
                    (touchstart.prevent)="
                      startHold('increment', meta.step || 1, category, key, meta)
                    "
                    (mouseup)="stopHold()"
                    (mouseleave)="stopHold()"
                    (touchend)="stopHold()"
                    [disabled]="
                      (+getFormControl(category, key).value || 0) >=
                      (meta.max_value ?? 1000000000000)
                    "
                  >
                    <mat-icon svgIcon="plus"></mat-icon>
                  </button>
                </div>
              }
              @case ('string') {
                <mat-form-field class="input-field" appearance="fill">
                  @if (meta.options) {
                    <mat-select
                      [formControl]="$any(getFormControl(category, key))"
                      [attr.aria-label]="meta.display_name"
                      (selectionChange)="onValueChange(category, key)"
                    >
                      @for (option of meta.options; track option.value || option) {
                        <mat-option [value]="option.value ?? option">{{
                          getOptionLabel(category, key, option)
                        }}</mat-option>
                      }
                    </mat-select>
                  } @else {
                    <input
                      matInput
                      [formControl]="$any(getFormControl(category, key))"
                      [attr.aria-label]="meta.display_name"
                      [placeholder]="meta.placeholder || ''"
                      (blur)="onBlur(category, key)"
                    />
                  }
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
              @case ('select') {
                <mat-form-field class="input-field" appearance="fill">
                  <mat-select
                    [formControl]="$any(getFormControl(category, key))"
                    [attr.aria-label]="meta.display_name"
                    (selectionChange)="onValueChange(category, key)"
                  >
                    @for (option of meta.options; track option.value || option) {
                      <mat-option [value]="option.value ?? option">{{
                        getOptionLabel(category, key, option)
                      }}</mat-option>
                    }
                  </mat-select>
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
              @case ('bandwidth') {
                <mat-form-field class="input-field" appearance="fill">
                  <input
                    matInput
                    [formControl]="$any(getFormControl(category, key))"
                    [attr.aria-label]="meta.display_name"
                    [placeholder]="meta.placeholder || ''"
                    (blur)="onBlur(category, key)"
                  />
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
              @case ('string[]') {
                <div class="array-control-wrapper">
                  <div class="array-items">
                    @for (item of getFormControl(category, key).value; track $index) {
                      <div class="array-item">
                        <mat-form-field appearance="fill" class="input-field">
                          <input
                            matInput
                            [formControl]="getArrayItemControl(category, key, $index)"
                            [attr.aria-label]="
                              'modals.preferences.aria.itemIndex' | translate: { index: $index + 1 }
                            "
                            (blur)="onBlur(category, key)"
                          />
                          <button
                            matIconButton
                            matSuffix
                            (click)="removeArrayItem(category, key, $index)"
                            [attr.aria-label]="
                              'modals.preferences.aria.removeItemIndex'
                                | translate: { index: $index + 1 }
                            "
                          >
                            <mat-icon svgIcon="close"></mat-icon>
                          </button>
                        </mat-form-field>
                      </div>
                    }
                  </div>
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error class="array-error">{{
                      getValidationMessage(category, key)
                    }}</mat-error>
                  }
                  <button
                    mat-stroked-button
                    (click)="addArrayItem(category, key)"
                    [attr.aria-label]="
                      'modals.preferences.aria.addNewItem' | translate: { name: meta.display_name }
                    "
                  >
                    <mat-icon svgIcon="plus"></mat-icon>
                    {{ 'modals.preferences.addItem' | translate }}
                  </button>
                </div>
              }
              @case ('file') {
                <mat-form-field appearance="fill" class="input-field">
                  <input
                    matInput
                    [formControl]="$any(getFormControl(category, key))"
                    (input)="onPathInput(category, key)"
                    (blur)="onBlur(category, key)"
                    [attr.aria-label]="
                      'modals.preferences.aria.filePathFor' | translate: { name: meta.display_name }
                    "
                  />
                  <button
                    matIconButton
                    matSuffix
                    (click)="openFilePicker(category, key)"
                    [attr.aria-label]="
                      'modals.preferences.aria.browseFor' | translate: { name: meta.display_name }
                    "
                  >
                    <mat-icon svgIcon="file"></mat-icon>
                  </button>
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
              @case ('folder') {
                <mat-form-field appearance="fill" class="input-field">
                  <input
                    matInput
                    [formControl]="$any(getFormControl(category, key))"
                    (input)="onPathInput(category, key)"
                    (blur)="onBlur(category, key)"
                    [attr.aria-label]="
                      'modals.preferences.aria.folderPathFor'
                        | translate: { name: meta.display_name }
                    "
                  />
                  <button
                    matIconButton
                    matSuffix
                    (click)="openFolderPicker(category, key)"
                    [attr.aria-label]="
                      'modals.preferences.aria.browseFor' | translate: { name: meta.display_name }
                    "
                  >
                    <mat-icon svgIcon="folder"></mat-icon>
                  </button>
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
            }
          </div>
        </div>
      </div>
    }
  </ng-template>

  @if (hasPendingRestartChanges) {
    <button
      class="floating-pending-indicator"
      (click)="scrollToPendingChanges()"
      [matTooltip]="
        'modals.preferences.pendingChangesTooltip'
          | translate: { count: pendingRestartChanges.size }
      "
      matTooltipPosition="left"
      matTooltipClass="pending-changes-tooltip"
      [attr.aria-label]="'modals.preferences.aria.scrollToPending' | translate"
    >
      <mat-icon svgIcon="circle-exclamation" class="warning-icon"></mat-icon>
      <span class="pending-count">{{ pendingRestartChanges.size }}</span>
    </button>
  }
</div>
