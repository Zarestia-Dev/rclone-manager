<div class="modal">
  <div class="modal-header" data-tauri-drag-region>
    <button
      matIconButton
      (click)="toggleSearch()"
      [attr.aria-label]="searchVisible ? 'Hide search' : 'Show search'"
      [class.active]="searchVisible"
    >
      <mat-icon svgIcon="search"></mat-icon>
    </button>

    @if (bottomTabs) {
      <p class="modal-title">Preferences</p>
    } @else {
      @if (!hasSearchResults) {
        <div class="tabs desktop-tabs" data-tauri-drag-region role="tablist">
          @for (tab of filteredTabs; track tab.key; let i = $index) {
            <button
              (click)="selectTab(i)"
              [class.selected]="selectedTabIndex === i"
              [attr.aria-selected]="selectedTabIndex === i"
              [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
              role="tab"
            >
              <mat-icon [svgIcon]="tab.icon"></mat-icon>
              <span class="tab-label">{{ tab.label }}</span>
            </button>
          }
        </div>
      } @else {
        <h2 class="modal-title search-title">Search Results</h2>
      }
    }

    <button matIconButton (click)="close()" aria-label="Close preferences dialog">
      <mat-icon svgIcon="circle-xmark"></mat-icon>
    </button>
  </div>

  <app-search-container
    [visible]="searchVisible"
    [searchText]="searchQuery"
    (searchTextChange)="onSearchTextChange($event)"
    placeholder="Search settings..."
    ariaLabel="Search preferences settings"
  ></app-search-container>

  @if (isLoading) {
    <div class="loading-overlay">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }

  @if (!isLoading) {
    <main class="modal-content">
      <div class="tab-content">
        <div class="settings-list" role="list">
          @if (hasSearchResults) {
            @for (result of searchResults; track result.category + '.' + result.key) {
              <div
                class="setting-item"
                role="listitem"
                [class.layout-row]="
                  getMetadata(result.category, result.key).value_type === 'bool' ||
                  getMetadata(result.category, result.key).value_type === 'int'
                "
              >
                <ng-container
                  [ngTemplateOutlet]="settingTemplate"
                  [ngTemplateOutletContext]="{
                    category: result.category,
                    key: result.key,
                    showCategory: true,
                  }"
                ></ng-container>
              </div>
            }
          }

          @if (!searchQuery) {
            @for (category of getObjectKeys(settingsForm.controls); track category) {
              @if (selectedTabKey === category) {
                <div class="tab-content" role="tabpanel">
                  <div class="settings-list" role="list">
                    @for (key of getObjectKeys(settingsForm.get(category)?.value); track key) {
                      <div
                        class="setting-item"
                        role="listitem"
                        [class.layout-row]="
                          getMetadata(category, key).value_type === 'bool' ||
                          getMetadata(category, key).value_type === 'int'
                        "
                      >
                        <ng-container
                          [ngTemplateOutlet]="settingTemplate"
                          [ngTemplateOutletContext]="{
                            category: category,
                            key: key,
                            showCategory: false,
                          }"
                        ></ng-container>
                      </div>
                    }
                    @if (isGeneralTab) {
                      <div class="actions">
                        <button
                          mat-button
                          class="reset-button"
                          (click)="resetSettings()"
                          aria-label="Reset all settings to default values"
                        >
                          <mat-icon svgIcon="arrow-rotate-left"></mat-icon>
                          Reset All Settings
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            }
          }

          @if (hasEmptySearchResults) {
            <div class="no-results" role="status" aria-live="polite">
              <mat-icon svgIcon="search"></mat-icon>
              <p>
                No settings found matching <strong>"{{ searchQuery }}"</strong>
              </p>
              <div class="search-suggestions">
                <small>Try searching for:</small>
                <div class="suggestion-chips">
                  @for (suggestion of searchSuggestions; track suggestion) {
                    <button
                      class="chip"
                      (click)="onSearchTextChange(suggestion)"
                      [attr.aria-label]="'Search for ' + suggestion"
                    >
                      {{ suggestion }}
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      </div>

      @if (hasPendingRestartChanges) {
        <div class="pending-changes-section">
          <div class="pending-changes-header">
            <div class="header-info">
              <mat-icon svgIcon="circle-exclamation" class="warn"></mat-icon>
              <div class="header-text">
                <h3>Settings Requiring Restart</h3>
                <p>The following changes require an engine restart to take effect:</p>
              </div>
            </div>
          </div>
          <div class="pending-changes-list">
            @for (change of getPendingChangesList(); track change.category + '.' + change.key) {
              <div class="pending-change-item">
                <div class="change-info">
                  <strong>{{ change.displayName }}</strong>
                  <span class="change-category">{{ getCategoryDisplayName(change.category) }}</span>
                </div>
                <div class="change-value">
                  @if (change.value === true || change.value === false) {
                    <span class="boolean-value" [class.enabled]="change.value">
                      {{ change.value ? 'Enabled' : 'Disabled' }}
                    </span>
                  } @else if (isArray(change.value)) {
                    <span class="array-value">{{ asArray(change.value).length }} items</span>
                  } @else {
                    <span class="text-value">{{ change.value }}</span>
                  }
                </div>
              </div>
            }
          </div>
          <div class="pending-changes-actions">
            <button
              matButton
              (click)="discardPendingChanges()"
              [disabled]="isDiscardingChanges"
              aria-label="Discard pending changes"
            >
              @if (isDiscardingChanges) {
                <mat-spinner diameter="16" class="inline-spinner"></mat-spinner>
              }
              @if (!isDiscardingChanges) {
                <mat-icon svgIcon="close"></mat-icon>
              }
              {{ isDiscardingChanges ? 'Discarding...' : 'Discard Changes' }}
            </button>
            <button
              mat-raised-button
              class="warn"
              (click)="savePendingChanges()"
              aria-label="Save changes and restart engine"
            >
              <mat-icon svgIcon="arrow-rotate-left"></mat-icon>
              Save & Restart Engine
            </button>
          </div>
        </div>
      }
    </main>
  }

  @if (bottomTabs && !hasSearchResults) {
    <div class="tabs bottom-tabs" role="tablist" aria-label="Settings categories">
      @for (tab of filteredTabs; track tab.key; let i = $index) {
        <button
          (click)="selectTab(i)"
          [class.selected]="selectedTabIndex === i"
          [attr.aria-selected]="selectedTabIndex === i"
          [attr.tabindex]="selectedTabIndex === i ? 0 : -1"
          role="tab"
          [attr.aria-controls]="'tab-panel-' + tab.key"
        >
          <mat-icon [svgIcon]="tab.icon"></mat-icon>
          <span class="tab-label">{{ tab.label }}</span>
        </button>
      }
    </div>
  }

  <ng-template
    #settingTemplate
    let-category="category"
    let-key="key"
    let-showCategory="showCategory"
  >
    @if (getMetadata(category, key); as meta) {
      <div class="setting-item-header">
        <div class="setting-info">
          <strong>{{ meta.display_name }}</strong>
          <p>{{ meta.help_text }}</p>
          @if (showCategory) {
            <small class="setting-category">{{ getCategoryDisplayName(category) }}</small>
          }
        </div>
        @if (isModified(category, key)) {
          <button
            mat-icon-button
            class="reset-btn"
            (click)="resetSetting(category, key)"
            [attr.aria-label]="'Reset ' + meta.display_name + ' to default'"
            matTooltip="Reset to default"
            matTooltipPosition="above"
          >
            <mat-icon svgIcon="arrow-rotate-left"></mat-icon>
          </button>
        }
      </div>

      <div class="setting-control">
        <div class="control-with-reset">
          <div class="control-field">
            @switch (meta.value_type) {
              @case ('bool') {
                <mat-slide-toggle [formControl]="$any(getFormControl(category, key))">
                </mat-slide-toggle>
              }
              @case ('int') {
                <div class="stepper">
                  <button
                    mat-icon-button
                    class="stepper-btn"
                    (mousedown)="startHold('decrement', meta.step || 1, category, key, meta)"
                    (touchstart.prevent)="
                      startHold('decrement', meta.step || 1, category, key, meta)
                    "
                    (mouseup)="stopHold()"
                    (mouseleave)="stopHold()"
                    (touchend)="stopHold()"
                    [disabled]="
                      (+getFormControl(category, key).value || 0) <= (meta.min_value ?? 0)
                    "
                  >
                    <mat-icon svgIcon="remove"></mat-icon>
                  </button>
                  <mat-form-field appearance="fill" class="number-input">
                    <input
                      matInput
                      type="number"
                      [formControl]="$any(getFormControl(category, key))"
                      (keydown)="onIntegerInput($event)"
                      [attr.aria-label]="meta.display_name"
                    />
                    @if (
                      getFormControl(category, key).invalid && getFormControl(category, key).touched
                    ) {
                      <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                    }
                  </mat-form-field>
                  <button
                    mat-icon-button
                    class="stepper-btn"
                    (mousedown)="startHold('increment', meta.step || 1, category, key, meta)"
                    (touchstart.prevent)="
                      startHold('increment', meta.step || 1, category, key, meta)
                    "
                    (mouseup)="stopHold()"
                    (mouseleave)="stopHold()"
                    (touchend)="stopHold()"
                    [disabled]="
                      (+getFormControl(category, key).value || 0) >=
                      (meta.max_value ?? 1000000000000)
                    "
                  >
                    <mat-icon svgIcon="add"></mat-icon>
                  </button>
                </div>
              }
              @case ('string') {
                <mat-form-field class="input-field" appearance="fill">
                  @if (meta.options) {
                    <mat-select
                      [formControl]="$any(getFormControl(category, key))"
                      [attr.aria-label]="meta.display_name"
                    >
                      @for (option of meta.options; track option) {
                        <mat-option [value]="option">{{ option }}</mat-option>
                      }
                    </mat-select>
                  } @else {
                    <input
                      matInput
                      [formControl]="$any(getFormControl(category, key))"
                      [attr.aria-label]="meta.display_name"
                      [placeholder]="meta.placeholder || ''"
                    />
                  }
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
              @case ('bandwidth') {
                <mat-form-field class="input-field" appearance="fill">
                  <input
                    matInput
                    [formControl]="$any(getFormControl(category, key))"
                    [attr.aria-label]="meta.display_name"
                    [placeholder]="meta.placeholder || ''"
                  />
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
              @case ('string[]') {
                <div class="array-control-wrapper">
                  <div class="array-items">
                    @for (item of getFormControl(category, key).value; track $index) {
                      <div class="array-item">
                        <mat-form-field appearance="fill" class="input-field">
                          <input
                            matInput
                            [formControl]="getArrayItemControl(category, key, $index)"
                            [attr.aria-label]="'Item ' + ($index + 1)"
                          />
                          <button
                            matIconButton
                            matSuffix
                            (click)="removeArrayItem(category, key, $index)"
                            [attr.aria-label]="'Remove item ' + ($index + 1)"
                          >
                            <mat-icon svgIcon="close"></mat-icon>
                          </button>
                        </mat-form-field>
                      </div>
                    }
                  </div>
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error class="array-error">{{
                      getValidationMessage(category, key)
                    }}</mat-error>
                  }
                  <button
                    mat-stroked-button
                    (click)="addArrayItem(category, key)"
                    [attr.aria-label]="'Add new ' + meta.display_name + ' item'"
                  >
                    <mat-icon svgIcon="add"></mat-icon> Add Item
                  </button>
                </div>
              }
              @case ('file') {
                <mat-form-field appearance="fill" class="input-field">
                  <input
                    matInput
                    [formControl]="$any(getFormControl(category, key))"
                    (input)="onPathInput(category, key)"
                    [attr.aria-label]="'File path for ' + meta.display_name"
                  />
                  <button
                    matIconButton
                    matSuffix
                    (click)="openFilePicker(category, key)"
                    [attr.aria-label]="'Browse for ' + meta.display_name"
                  >
                    <mat-icon svgIcon="file"></mat-icon>
                  </button>
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
              @case ('folder') {
                <mat-form-field appearance="fill" class="input-field">
                  <input
                    matInput
                    [formControl]="$any(getFormControl(category, key))"
                    (input)="onPathInput(category, key)"
                    [attr.aria-label]="'Folder path for ' + meta.display_name"
                  />
                  <button
                    matIconButton
                    matSuffix
                    (click)="openFolderPicker(category, key)"
                    [attr.aria-label]="'Browse for ' + meta.display_name"
                  >
                    <mat-icon svgIcon="folder"></mat-icon>
                  </button>
                  @if (
                    getFormControl(category, key).invalid && getFormControl(category, key).touched
                  ) {
                    <mat-error>{{ getValidationMessage(category, key) }}</mat-error>
                  }
                </mat-form-field>
              }
            }
          </div>
        </div>
      </div>
    }
  </ng-template>

  @if (hasPendingRestartChanges) {
    <button
      class="floating-pending-indicator"
      (click)="scrollToPendingChanges()"
      matTooltip="You have {{
        pendingRestartChanges.size
      }} unsaved changes that require engine restart. Click to scroll to them."
      matTooltipPosition="left"
      matTooltipClass="pending-changes-tooltip"
      aria-label="Scroll to pending changes section"
    >
      <mat-icon svgIcon="circle-exclamation" class="warning-icon"></mat-icon>
      <span class="pending-count">{{ pendingRestartChanges.size }}</span>
    </button>
  }
</div>
