<div
  class="onboarding-container"
  data-tauri-drag-region
  animate.enter="onboarding-entrance-enter"
  animate.leave="onboarding-entrance-leave"
>
  <div class="floating-shape"></div>

  @if (animationState() === 'loading') {
    <app-loading-overlay
      animate.enter="fade-in-out-enter"
      animate.leave="fade-in-out-leave"
      title="Initializing RClone Manager"
      message="Checking system configuration..."
      icon="refresh"
    >
    </app-loading-overlay>
  }

  <div class="card-container" [class.onboarding-state-enter]="animationState() === 'visible'">
    <div class="onboarding-header">
      <div class="page-indicators">
        @for (card of cards(); track trackByIndex(i); let i = $index) {
          <div
            class="indicator"
            [class.active]="i === currentCardIndex()"
            [class.completed]="i < currentCardIndex()"
          ></div>
        }
      </div>
    </div>
    <div class="content-area">
      <div class="card-content">
        <div class="icon-container">
          <img [src]="currentCard().image" alt="{{ currentCard().title }} icon" />
        </div>
        <div class="text-content">
          <h2 class="card-title">{{ currentCard().title }}</h2>
          <p class="card-description">{{ currentCard().content }}</p>
        </div>
        @if (currentCard().title === 'Select RClone Config') {
          <div class="form-section">
            <app-installation-options
              [mode]="'config'"
              [disabled]="installing()"
              [tabOptions]="[
                { key: 'default', label: 'Default', icon: 'file' },
                { key: 'custom', label: 'Custom', icon: 'folder' },
              ]"
              (dataChange)="onConfigOptionsChange($event)"
              (validChange)="onConfigValidChange($event)"
            ></app-installation-options>
          </div>
        }
        @if (currentCard().title === 'Configuration Password Required') {
          <div class="form-section">
            <app-password-manager
              [password]="configPassword()"
              [hasError]="!!passwordValidationError()"
              [storePassword]="true"
              [isSubmitting]="isSubmittingPassword()"
              [errorMessage]="passwordValidationError() || ''"
              [showStoreOption]="false"
              (passwordChange)="configPassword.set($event)"
              (unlock)="submitConfigPassword()"
            >
            </app-password-manager>
          </div>
        }
        @if (currentCard().title === 'Install RClone' && !systemHealth.rcloneInstalled()) {
          <div class="form-section">
            <app-installation-options
              [mode]="'install'"
              [disabled]="installing()"
              [tabOptions]="onboardingTabOptions"
              (dataChange)="onInstallationOptionsChange($event)"
              (validChange)="onInstallationValidChange($event)"
            >
            </app-installation-options>
          </div>
        }
      </div>
    </div>
    <div class="footer-navigation">
      <div>
        @if (currentCardIndex() > 0) {
          <button matButton (click)="previousCard()" class="secondary">
            <mat-icon svgIcon="left-arrow"></mat-icon>
            Back
          </button>
        }
      </div>
      <div>
        @switch (currentAction()) {
          @case ('install-rclone') {
            <button
              matButton="filled"
              class="primary"
              (click)="installRclone()"
              [disabled]="!canInstall()"
              [matTooltip]="!canInstall() ? 'Please complete the installation options above' : ''"
            >
              <mat-icon
                [svgIcon]="installing() ? 'refresh' : 'download'"
                [class.animate-spin]="installing()"
              ></mat-icon>
              {{ installButtonText() }}
            </button>
          }
          @case ('install-plugin') {
            <button
              matButton="filled"
              class="primary"
              (click)="installMountPlugin()"
              [disabled]="downloadingPlugin()"
            >
              <mat-icon
                [svgIcon]="downloadingPlugin() ? 'refresh' : 'download'"
                [class.animate-spin]="downloadingPlugin()"
              ></mat-icon>
              {{ downloadingPlugin() ? 'Installing...' : 'Install Plugin' }}
            </button>
          }
          @case ('config-next') {
            <button
              matButton="filled"
              class="primary"
              (click)="onConfigNext()"
              [disabled]="!configValid()"
              [matTooltip]="
                !configValid() ? 'Please select or provide a valid config option first' : ''
              "
            >
              Next
              <mat-icon svgIcon="right-arrow"></mat-icon>
            </button>
          }
          @case ('unlock') {
            <button
              matButton="filled"
              class="primary"
              (click)="submitConfigPassword()"
              [disabled]="!configPassword() || isSubmittingPassword()"
            >
              @if (isSubmittingPassword()) {
                <mat-progress-spinner diameter="18" mode="indeterminate"></mat-progress-spinner>
              } @else {
                <span>Unlock</span>
              }
            </button>
          }
          @case ('finish') {
            <button
              matButton="filled"
              class="primary"
              (click)="completeOnboarding()"
              class="finish-button"
            >
              <mat-icon svgIcon="circle-check"></mat-icon>
              Get Started
            </button>
          }
          @default {
            <button matButton="filled" class="primary" (click)="nextCard()">
              Next
              <mat-icon svgIcon="right-arrow"></mat-icon>
            </button>
          }
        }
      </div>
    </div>
  </div>
</div>
