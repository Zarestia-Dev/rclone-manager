<div class="home-wrapper">
  <mat-sidenav-container class="home-container">
    <!-- Sidebar -->
    <mat-sidenav
      #sidenav
      [opened]="isSidebarOpen()"
      (openedChange)="isSidebarOpen.set($event)"
      [mode]="sidebarMode()"
    >
      <app-sidebar [remotes]="remotes()"></app-sidebar>
    </mat-sidenav>

    <!-- Main Content -->
    <mat-sidenav-content class="main-content" position="center">
      <!-- Sidebar Toggle Button -->
      <div class="sidebar-button">
        <button matIconButton (click)="sidenav.toggle()">
          <mat-icon svgIcon="menu-bar"></mat-icon>
        </button>
      </div>

      <!-- Remote Options Menu -->
      @if (selectedRemote(); as remote) {
        <button
          matIconButton
          class="ellipsis-button"
          [cdkMenuTriggerFor]="remoteOptionsMenu"
          [cdkMenuTriggerData]="{ remote: remote }"
        >
          <mat-icon svgIcon="ellipsis-vertical"></mat-icon>
        </button>
      }

      <!-- Empty State -->
      @if (remotes().length === 0 && !isLoading()) {
        <div class="empty-state">
          <div class="empty-state-content">
            <div class="icon-container">
              <img src="assets/rclone.svg" alt="Rclone Logo" class="empty-state-icon" />
            </div>
            <h2>RClone Manager</h2>
            <p>
              Easily manage your RClone remotes. If you're new to RClone, use "Add Quick Remote" for
              a fast and simple setup.
            </p>
            <div class="empty-state-actions">
              <button matButton="filled" class="primary" (click)="openQuickAddRemoteModal()">
                <mat-icon svgIcon="add"></mat-icon>
                Add Quick Remote
              </button>
              <button matButton="filled" class="accent" (click)="openRemoteConfigModal()">
                <mat-icon svgIcon="add"></mat-icon>
                Add Detailed Remote
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Overview Components -->
      @if (remotes().length > 0 && !selectedRemote() && !isLoading()) {
        @switch (currentTab()) {
          @case ('general') {
            <app-general-overview
              [remotes]="remotes()"
              [jobs]="jobs()"
              [actionInProgress]="actionInProgress()"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName, $event.serveId)"
              (browseRemote)="openRemoteInFiles($event, 'mount')"
              (selectRemote)="selectRemote($event)"
            >
            </app-general-overview>
          }
          @case ('serve') {
            <app-serve-overview
              [remotes]="remotes()"
              [runningServes]="runningServes()"
              [actionInProgress]="actionInProgress()"
              (remoteSelected)="selectRemote($event)"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName, $event.serveId)"
            >
            </app-serve-overview>
          }
          @default {
            <app-app-overview
              [mode]="currentTab()"
              [remotes]="remotes()"
              [actionInProgress]="actionInProgress()"
              (remoteSelected)="selectRemote($event)"
              (openInFiles)="openRemoteInFiles($event, currentTab())"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName)"
            >
            </app-app-overview>
          }
        }
      }

      <!-- Remote Detail View -->
      @if (selectedRemote(); as remote) {
        @switch (currentTab()) {
          @case ('general') {
            <app-general-detail
              [restrictMode]="restrictMode()"
              [jobs]="getJobsForRemote(remote.remoteSpecs.name)"
              [selectedRemote]="remote"
              (stopJob)="stopJob($event.type, $event.remoteName)"
              (openRemoteConfigModal)="
                openRemoteConfigModal($event.editTarget, $event.existingConfig)
              "
              (deleteJob)="deleteJob($event)"
              (togglePrimaryAction)="togglePrimaryAction($event)"
            >
            </app-general-detail>
          }
          @case ('serve') {
            <app-serve-detail
              [selectedRemote]="remote"
              [runningServes]="runningServes()"
              [remoteSettings]="selectedRemoteSettings()"
              [actionInProgress]="actionInProgress()[remote.remoteSpecs.name]"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName, $event.serveId)"
              (openRemoteConfigModal)="
                openRemoteConfigModal(
                  $event.editTarget,
                  $event.existingConfig,
                  $event.initialSection
                )
              "
            >
            </app-serve-detail>
          }
          @default {
            <app-app-detail
              [mainOperationType]="currentTab()"
              [selectedSyncOperation]="selectedSyncOperation()"
              [selectedRemote]="remote"
              [remoteSettings]="selectedRemoteSettings()"
              [restrictMode]="restrictMode()"
              [actionInProgress]="actionInProgress()[remote.remoteSpecs.name]"
              (syncOperationChange)="onSyncOperationChange($event)"
              (openRemoteConfigModal)="
                openRemoteConfigModal($event.editTarget, $event.existingConfig)
              "
              (openInFiles)="openRemoteInFilesWithPath($event.remoteName, $event.path)"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName)"
            >
            </app-app-detail>
          }
        }
      }
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>

<ng-template #remoteOptionsMenu let-remote="remote">
  <div class="material-context-menu" cdkMenu>
    <!-- Show in Tray Menu (Toggle) -->
    <button class="menu-item" cdkMenuItem (click)="$event.stopPropagation()">
      <mat-checkbox
        labelPosition="before"
        [checked]="getRemoteSettingValue(remote.remoteSpecs.name, 'showOnTray')"
        (change)="saveRemoteSettings(remote.remoteSpecs.name, { showOnTray: $event.checked })"
      >
        <span>Show in Tray Menu</span>
      </mat-checkbox>
    </button>
    <mat-divider></mat-divider>
    <!-- Remote Actions -->
    <button class="menu-item" cdkMenuItem (click)="openLogsModal(remote.remoteSpecs.name)">
      <span>View Logs</span>
    </button>
    <button class="menu-item" cdkMenuItem (click)="cloneRemote(remote.remoteSpecs.name)">
      <span>Clone Remote</span>
    </button>
    <mat-divider></mat-divider>
    <button class="menu-item" cdkMenuItem (click)="openExportModal(remote.remoteSpecs.name)">
      <span>Export Configuration</span>
    </button>
    <button class="menu-item" cdkMenuItem (click)="resetRemoteSettings()">
      <span>Reset Settings</span>
    </button>
    <mat-divider></mat-divider>
    <!-- Delete Remote -->
    <button class="menu-item" cdkMenuItem (click)="deleteRemote(remote.remoteSpecs.name)">
      <span>Delete Remote</span>
    </button>
  </div>
</ng-template>
