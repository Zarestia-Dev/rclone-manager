<div class="home-wrapper">
  <mat-sidenav-container class="home-container">
    <!-- Sidebar -->
    <mat-sidenav
      #sidenav
      [opened]="isSidebarOpen()"
      (openedChange)="isSidebarOpen.set($event)"
      [mode]="sidebarMode()"
    >
      <app-sidebar [remotes]="remotes()"></app-sidebar>
    </mat-sidenav>

    <!-- Main Content -->
    <mat-sidenav-content class="main-content" position="center">
      <!-- Sidebar Toggle Button -->
      <div class="sidebar-button">
        <button matIconButton (click)="sidenav.toggle()">
          <mat-icon svgIcon="menu-bar"></mat-icon>
        </button>
      </div>

      <!-- Remote Options Menu -->
      @for (remote of [selectedRemote()]; track remote?.remoteSpecs?.name) {
        @if (remote) {
          <button
            matIconButton
            class="ellipsis-button"
            [cdkMenuTriggerFor]="remoteOptionsMenu"
            [cdkMenuTriggerData]="{ remote: remote }"
          >
            <mat-icon svgIcon="ellipsis-vertical"></mat-icon>
          </button>
        }
      }

      <!-- Empty State -->
      @if (remotes().length === 0 && !isLoading()) {
        <div class="no-remotes">
          <div class="no-remotes-content">
            <!-- Logo with integrated Backend Indicator -->
            <button
              class="icon-container interactive"
              (click)="openBackendModal()"
              [matTooltip]="'shared.overviewHeader.manageBackends' | translate"
              matTooltipShowDelay="500"
              matTooltipPosition="above"
            >
              <img src="assets/rclone.svg" alt="Rclone Logo" class="no-remotes-icon" />
              <span class="status-dot" [class]="backendStatusClass()"></span>
            </button>
            <span class="backend-name">{{ activeBackend() }}</span>

            <h2>{{ 'home.emptyState.title' | translate }}</h2>
            <p>
              {{ 'home.emptyState.description' | translate }}
            </p>
            <div class="no-remotes-actions">
              <button matButton="filled" class="primary" (click)="openQuickAddRemoteModal()">
                <mat-icon svgIcon="plus"></mat-icon>
                {{ 'home.emptyState.addQuickRemote' | translate }}
              </button>
              <button matButton="filled" class="accent" (click)="openRemoteConfigModal()">
                <mat-icon svgIcon="plus"></mat-icon>
                {{ 'home.emptyState.addDetailedRemote' | translate }}
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Overview Components -->
      @if (remotes().length > 0 && !selectedRemote() && !isLoading()) {
        @switch (currentTab()) {
          @case ('general') {
            <app-general-overview
              [remotes]="remotes()"
              [jobs]="jobs()"
              [actionInProgress]="actionInProgress()"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="
                stopJob($event.type, $event.remoteName, $event.serveId, $event.profileName)
              "
              (browseRemote)="openRemoteInFiles($event, 'mount')"
              (selectRemote)="selectRemote($event)"
              (openBackendModal)="openBackendModal()"
            >
            </app-general-overview>
          }
          @default {
            <app-app-overview
              [mode]="currentTab()"
              [remotes]="remotes()"
              [runningServes]="runningServes()"
              [actionInProgress]="actionInProgress()"
              (remoteSelected)="selectRemote($event)"
              (openInFiles)="openRemoteInFiles($event, currentTab())"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="
                stopJob($event.type, $event.remoteName, $event.serveId, $event.profileName)
              "
              (openBackendModal)="openBackendModal()"
            >
            </app-app-overview>
          }
        }
      }

      <!-- Remote Detail View -->
      @if (selectedRemote(); as remote) {
        @switch (currentTab()) {
          @case ('general') {
            <app-general-detail
              [jobs]="getJobsForRemote(remote.remoteSpecs.name)"
              [selectedRemote]="remote"
              (stopJob)="stopJob($event.type, $event.remoteName, undefined, $event.profileName)"
              (openRemoteConfigModal)="
                openRemoteConfigModal($event.editTarget, $event.existingConfig)
              "
              (deleteJob)="deleteJob($event)"
              (togglePrimaryAction)="togglePrimaryAction($event)"
            >
            </app-general-detail>
          }
          @default {
            <app-app-detail
              [mainOperationType]="currentTab()"
              [selectedSyncOperation]="selectedSyncOperation()"
              [selectedRemote]="remote"
              [remoteSettings]="selectedRemoteSettings()"
              [actionInProgress]="actionInProgress()[remote.remoteSpecs.name]"
              (syncOperationChange)="onSyncOperationChange($event)"
              (openRemoteConfigModal)="
                openRemoteConfigModal(
                  $event.editTarget,
                  $event.existingConfig,
                  $event.initialSection,
                  $event.targetProfile
                )
              "
              (openInFiles)="openRemoteInFiles($event.remoteName, $event.path)"
              (startJob)="startJob($event.type, $event.remoteName, $event.profileName)"
              (stopJob)="
                stopJob($event.type, $event.remoteName, $event.serveId, $event.profileName)
              "
            >
            </app-app-detail>
          }
        }
      }
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>

<ng-template #remoteOptionsMenu let-remote="remote">
  <div class="material-context-menu" cdkMenu>
    <!-- Show in Tray Menu (Toggle) -->
    <button class="menu-item" cdkMenuItem (click)="$event.stopPropagation()">
      <mat-checkbox
        labelPosition="before"
        [checked]="getRemoteSettingValue(remote.remoteSpecs.name, 'showOnTray')"
        (change)="saveRemoteSettings(remote.remoteSpecs.name, { showOnTray: $event.checked })"
      >
        <span>{{ 'home.options.showInTray' | translate }}</span>
      </mat-checkbox>
    </button>
    <mat-divider></mat-divider>
    <!-- Remote Actions -->
    <button class="menu-item" cdkMenuItem (click)="openLogsModal(remote.remoteSpecs.name)">
      <span>{{ 'home.options.viewLogs' | translate }}</span>
    </button>
    <button class="menu-item" cdkMenuItem (click)="cloneRemote(remote.remoteSpecs.name)">
      <span>{{ 'home.options.cloneRemote' | translate }}</span>
    </button>
    <mat-divider></mat-divider>
    <button class="menu-item" cdkMenuItem (click)="openExportModal(remote.remoteSpecs.name)">
      <span>{{ 'home.options.exportConfig' | translate }}</span>
    </button>
    <button class="menu-item" cdkMenuItem (click)="resetRemoteSettings(remote.remoteSpecs.name)">
      <span>{{ 'home.options.resetSettings' | translate }}</span>
    </button>
    <mat-divider></mat-divider>
    <!-- Delete Remote -->
    <button class="menu-item" cdkMenuItem (click)="deleteRemote(remote.remoteSpecs.name)">
      <span>{{ 'home.options.deleteRemote' | translate }}</span>
    </button>
  </div>
</ng-template>
