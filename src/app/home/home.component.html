<div class="home-wrapper">
  <!-- Shutdown Overlay -->
  <app-loading-overlay
    [isVisible]="isShuttingDown"
    title="Shutting Down"
    message="Please wait while the application shuts down safely..."
    icon="refresh"
    overlayType="fullscreen"
  >
  </app-loading-overlay>

  <mat-sidenav-container class="home-container">
    <!-- Sidebar -->
    <mat-sidenav #sidenav [(opened)]="isSidebarOpen" [mode]="sidebarMode">
      <app-sidebar [iconService]="iconService" [remotes]="remotes"></app-sidebar>
    </mat-sidenav>

    <!-- Main Content -->
    <mat-sidenav-content class="main-content" position="center">
      <!-- Sidebar Toggle Button -->
      <div class="sidebar-button">
        <button matIconButton (click)="sidenav.toggle()">
          <mat-icon svgIcon="menu-bar"></mat-icon>
        </button>
      </div>

      <!-- Remote Options Menu -->
      @if (selectedRemote) {
        <div class="ellipsis-button-container">
          <button matIconButton class="ellipsis-button" [matMenuTriggerFor]="remoteOptionsMenu">
            <mat-icon svgIcon="ellipsis-vertical"></mat-icon>
          </button>
          <mat-menu #remoteOptionsMenu="matMenu">
            <!-- Show in Tray Menu (Toggle) -->
            <button mat-menu-item (click)="$event.stopPropagation()">
              <mat-checkbox
                labelPosition="before"
                [checked]="getRemoteSettingValue(selectedRemote.remoteSpecs.name, 'showOnTray')"
                (change)="
                  saveRemoteSettings(selectedRemote.remoteSpecs.name, {
                    showOnTray: $event.checked,
                  })
                "
                class="menu-checkbox"
              >
                <span class="menu-item-label">Show in Tray Menu</span>
              </mat-checkbox>
            </button>
            <mat-divider></mat-divider>
            <!-- Remote Actions -->
            <button mat-menu-item (click)="openLogsModal(selectedRemote.remoteSpecs.name)">
              <span>View Logs</span>
            </button>
            <button mat-menu-item (click)="cloneRemote(selectedRemote.remoteSpecs.name)">
              <span>Clone Remote</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="openExportModal(selectedRemote.remoteSpecs.name)">
              <span>Export Configuration</span>
            </button>
            <button mat-menu-item (click)="resetRemoteSettings()">
              <span>Reset Settings</span>
            </button>
            <mat-divider></mat-divider>
            <!-- Delete Remote -->
            <button
              mat-menu-item
              class="delete-option"
              (click)="deleteRemote(selectedRemote.remoteSpecs.name)"
            >
              <span>Delete Remote</span>
            </button>
          </mat-menu>
        </div>
      }

      <!-- Empty State -->
      @if (remotes.length === 0 && !isLoading) {
        <div class="empty-state">
          <div class="empty-state-content">
            <div class="icon-container">
              <img src="assets/rclone.svg" alt="Rclone Logo" class="empty-state-icon" />
            </div>
            <h2>RClone Manager</h2>
            <p>
              Easily manage your RClone remotes. If you're new to RClone, use "Add Quick Remote" for
              a fast and simple setup.
            </p>
            <div class="empty-state-actions">
              <button matButton="filled" class="primary" (click)="openQuickAddRemoteModal()">
                <mat-icon svgIcon="add"></mat-icon>
                Add Quick Remote
              </button>
              <button matButton="filled" class="accent" (click)="openRemoteConfigModal()">
                <mat-icon svgIcon="add"></mat-icon>
                Add Detailed Remote
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Overview Components -->
      @if (remotes.length > 0 && !selectedRemote && !isLoading) {
        @switch (currentTab) {
          @case ('general') {
            <app-general-overview
              [remotes]="remotes"
              [jobs]="jobs"
              [actionInProgress]="actionInProgress"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName, $event.serveId)"
              (browseRemote)="openRemoteInFiles($event, 'mount')"
              (selectRemote)="selectRemote($event)"
            >
            </app-general-overview>
          }
          @case ('serve') {
            <app-serve-overview
              [remotes]="remotes"
              [runningServes]="runningServes"
              (remoteSelected)="selectRemote($event)"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName, $event.serveId)"
            >
            </app-serve-overview>
          }
          @default {
            <app-app-overview
              [mode]="currentTab"
              [remotes]="remotes"
              [actionInProgress]="actionInProgress"
              (remoteSelected)="selectRemote($event)"
              (openInFiles)="openRemoteInFiles($event, currentTab)"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName)"
            >
            </app-app-overview>
          }
        }
      }

      <!-- Remote Detail View -->
      @if (selectedRemote && !isLoading) {
        @switch (currentTab) {
          @case ('general') {
            <app-general-detail
              [restrictMode]="restrictMode"
              [jobs]="getJobsForRemote(selectedRemote.remoteSpecs.name)"
              [selectedRemote]="selectedRemote"
              (stopJob)="stopJob($event.type, $event.remoteName)"
              (openRemoteConfigModal)="
                openRemoteConfigModal($event.editTarget, $event.existingConfig)
              "
              (deleteJob)="deleteJob($event)"
              (togglePrimaryAction)="togglePrimaryAction($event)"
            >
            </app-general-detail>
          }
          @case ('serve') {
            <app-serve-detail
              [selectedRemote]="selectedRemote"
              [runningServes]="runningServes"
              [remoteSettings]="loadRemoteSettings(selectedRemote.remoteSpecs.name)"
              [actionInProgress]="actionInProgress[selectedRemote.remoteSpecs.name]"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName, $event.serveId)"
              (openRemoteConfigModal)="
                openRemoteConfigModal(
                  $event.editTarget,
                  $event.existingConfig,
                  $event.initialSection
                )
              "
            >
            </app-serve-detail>
          }
          @default {
            <app-app-detail
              [mainOperationType]="currentTab"
              [selectedSyncOperation]="selectedSyncOperation"
              [iconService]="iconService"
              [selectedRemote]="selectedRemote"
              [remoteSettings]="loadRemoteSettings(selectedRemote.remoteSpecs.name)"
              [restrictMode]="restrictMode"
              [actionInProgress]="actionInProgress[selectedRemote.remoteSpecs.name]"
              (syncOperationChange)="onSyncOperationChange($event)"
              (openRemoteConfigModal)="
                openRemoteConfigModal($event.editTarget, $event.existingConfig)
              "
              (openInFiles)="openRemoteInFilesWithPath($event.remoteName, $event.path)"
              (startJob)="startJob($event.type, $event.remoteName)"
              (stopJob)="stopJob($event.type, $event.remoteName)"
            >
            </app-app-detail>
          }
        }
      }
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>
